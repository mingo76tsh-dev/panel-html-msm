
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">
  <meta name="description" content="HSM v7 • Móvil: ingreso y alta rápida con soporte offline, cola de pendientes con reintentos, y envío directo a Google Sheets.">

  <title>HSM v7 • Móvil</title>

  <style>
    :root{
      --bg:#0b1220; --card:#121a2a; --muted:#99a3b3; --fg:#e6edf7; --acc:#2ecc71; --warn:#f39c12; --err:#e74c3c; --primary:#2d7ef7;
      --radius:14px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;}
    *{box-sizing:border-box}
    a{color:inherit}
    .wrap{max-width:920px;margin-inline:auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .chip{background:#0e1526;border:1px solid #1e2a44;color:#bcd0ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{background:var(--primary);border:none;color:white;border-radius:999px;padding:10px 16px;font-weight:600}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .ghost{background:#10192e;border:1px solid #233152}
    .danger{background:var(--err)}
    nav.tabs{display:flex;gap:8px;margin:8px 0 16px}
    nav.tabs .tab{background:#0e1526;border:1px solid #1e2a44;color:#c9d6ff;border-radius:999px;padding:8px 14px;cursor:pointer}
    nav.tabs .tab[aria-selected="true"]{background:#1a2440;color:white;border-color:#3350a8}
    .card{background:var(--card);border:1px solid #1b2744;border-radius:var(--radius);padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 4px}
    input,select,textarea{
      width:100%;color:var(--fg);background:#0e1526;border:1px solid #223052;border-radius:12px;padding:12px;
      outline:none;accent-color:#6cb1ff;font-size:16px
    }
    input:focus,select:focus,textarea:focus{border-color:#3b69ff;box-shadow:0 0 0 3px rgba(59,105,255,.15)}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .hint{font-size:12px;color:#97a6c5;margin-top:6px}
    .badge{background:#0e1526;border:1px solid #27365b;border-radius:999px;padding:4px 10px;font-size:12px}
    .right{margin-left:auto}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:#9fb0d4;text-align:left;padding:4px 8px}
    td{background:#0f1728;border:1px solid #1e2c4f;padding:10px;border-radius:10px;font-size:14px}
    td small{color:#9fb0d4}
    dialog{border:none;border-radius:16px;background:#0f1728;color:#eaf0ff;max-width:560px;width:92%;padding:0;box-shadow:0 30px 80px rgba(0,0,0,.5)}
    dialog .hd{padding:14px 16px;border-bottom:1px solid #182648;font-weight:700}
    dialog .bd{padding:16px}
    dialog .ft{padding:12px 16px;border-top:1px solid #182648;display:flex;gap:8px;justify-content:flex-end}
    #toast{position:fixed;left:16px;right:16px;bottom:16px;background:#0f1728;border:1px solid #1d2b4a;border-radius:12px;padding:12px 14px;color:#dfe8ff;display:none}
    .ok{color:#9effb7}
    .warn{color:#ffd37a}
    .err{color:#ff9aa2}
    .pill{background:#0c1426;border:1px dashed #2a3a63;color:#cfe0ff;border-radius:12px;font-size:12px;padding:6px 10px;cursor:pointer}
    .kv{display:flex;align-items:center;gap:8px}
    .kv code{background:#0d1528;border:1px solid #243355;border-radius:8px;padding:4px 6px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="chip">HSM v7 • Móvil</div>
        <span class="badge" id="net-badge">Online</span>
      </div>
      <div class="toolbar">
        <button class="btn ghost" id="btn-install" hidden>Instalar</button>
        <button class="btn ghost" id="btn-cfg" title="Configuración">⚙️</button>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Secciones">
      <button class="tab" role="tab" aria-selected="true" data-tab="ing">Ingreso</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="pend">Pendientes <span class="badge" id="pend-count">0</span></button>
      <button class="tab" role="tab" aria-selected="false" data-tab="util">Útiles</button>
    </nav>

    <main>
      <!-- ====== TAB: Ingreso ====== -->
      <section id="tab-ing" class="card" role="tabpanel">
        <div class="row">
          <div>
            <label for="dni">DNI</label>
            <input id="dni" type="text" inputmode="numeric" pattern="[0-9]{7,9}" placeholder="7–9 dígitos" autocomplete="off">
          </div>
          <div>
            <label for="sexo">Sexo</label>
            <select id="sexo">
              <option value="">—</option>
              <option>M</option>
              <option>F</option>
              <option>X</option>
            </select>
          </div>

          <div>
            <label for="fec">Fecha ingreso</label>
            <div class="kv">
              <input id="fec" type="date">
              <button class="pill" type="button" id="btn-hoy">Hoy</button>
            </div>
            <div class="hint">Formato enviado: <code>yyyy-mm-dd</code></div>
          </div>

          <div>
            <label for="hor">Hora ingreso</label>
            <div class="kv">
              <input id="hor" type="time" step="60">
              <button class="pill" type="button" id="btn-ahora">Ahora</button>
            </div>
          </div>

          <div>
            <label for="ide">Ideación / Intento</label>
            <select id="ide">
              <option value="">—</option>
              <option>Ideación</option>
              <option>Intento</option>
            </select>
          </div>

          <div>
            <label for="met">Método / Letalidad</label>
            <select id="met">
              <option value="">—</option>
              <option>Intoxicación</option>
              <option>Corte</option>
              <option>Colgamiento</option>
              <option>Arma de fuego</option>
              <option>Arrojo</option>
              <option>Otro</option>
            </select>
          </div>

          <div>
            <label for="cons">Consumo</label>
            <select id="cons">
              <option>Niega</option>
              <option>Ocasional</option>
              <option>Semanal</option>
              <option>Diario</option>
            </select>
          </div>

          <div>
            <label for="freq">Frecuencia</label>
            <select id="freq">
              <option value="">—</option>
              <option>Diaria</option>
              <option>Semanal</option>
              <option>Ocasional</option>
            </select>
          </div>

          <div>
            <label for="dx">Dx CIE-10 (código)</label>
            <input id="dx" type="text" placeholder="Ej: F32.1" autocapitalize="characters">
          </div>

          <div>
            <label for="obs">Observaciones</label>
            <textarea id="obs" placeholder="Notas breves (opcional)"></textarea>
            <div class="actions">
              <button class="pill" type="button" data-obs="Obs. SP">Obs. SP</button>
              <button class="pill" type="button" data-obs="Red apoyo ✓">Red apoyo ✓</button>
              <button class="pill" type="button" data-obs="Niega consumo">Niega consumo</button>
              <button class="pill" type="button" data-obs="Acompañante">Acompañante</button>
              <span class="right"></span>
              <button id="btn-guardar" class="btn">Guardar ingreso</button>
            </div>
          </div>
        </div>
        <div class="hint">Los envíos fallidos quedan en <b>Pendientes</b> y se reintentan automáticamente al recuperar conexión.</div>
      </section>

      <!-- ====== TAB: Pendientes ====== -->
      <section id="tab-pend" class="card" role="tabpanel" hidden>
        <div class="actions">
          <button id="btn-retry" class="btn">Reintentar todos</button>
          <button id="btn-vaciar" class="btn danger">Vaciar cola</button>
          <span class="right"></span>
          <span class="hint">Se evita duplicar por <code>DUPE_KEY = DNI|Fecha|Hora</code></span>
        </div>
        <div style="height:8px"></div>
        <table>
          <thead>
            <tr>
              <th>#</th><th>Tipo</th><th>DNI</th><th>Fecha</th><th>Hora</th><th>Estado</th>
            </tr>
          </thead>
          <tbody id="pend-tb"></tbody>
        </table>
      </section>

      <!-- ====== TAB: Útiles ====== -->
      <section id="tab-util" class="card" role="tabpanel" hidden>
        <div class="row">
          <div>
            <div class="kv"><strong>WebApp URL (exec)</strong></div>
            <div class="hint"><code id="cfg-url-short">—</code></div>
          </div>
          <div>
            <div class="kv"><strong>API Key</strong></div>
            <div class="hint"><code id="cfg-key-short">—</code></div>
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="actions">
          <button class="btn ghost" id="btn-open-cfg">Modificar configuración</button>
          <button class="btn ghost" id="btn-ping">Probar ping</button>
        </div>
        <div id="util-out" class="hint"></div>
      </section>
    </main>
  </div>

  <!-- ====== DIALOG: Config ====== -->
  <dialog id="dlg">
    <div class="hd">Configuración</div>
    <div class="bd">
      <label>WebApp URL (exec)</label>
      <input id="cfg-url" type="url" placeholder="https://script.google.com/macros/s/.../exec">
      <label>API Key</label>
      <input id="cfg-key" type="text" placeholder="HSM2025KEY">
      <div class="hint">El envío no usa headers personalizados (evita preflight). La API key viaja en el cuerpo del POST.</div>
    </div>
    <div class="ft">
      <button class="btn ghost" id="cfg-test">Probar</button>
      <button class="btn" id="cfg-save">Guardar</button>
      <button class="btn ghost" id="cfg-close">Cerrar</button>
    </div>
  </dialog>

  <div id="toast"></div>
  <script>
  // =============== CONFIG & STATE ===============
  const CFG = {
    url:  localStorage.getItem('hsm.webapp') || 'https://script.google.com/macros/s/AKfycbxdJ8bzevXZ-BBRSekO5ep8ggva0H2TVnp52FP1_lbzkbc0tCeVhoEvBqav969CDEJc0g/exec',
    apiKey: localStorage.getItem('hsm.apikey') || 'HSM2025KEY'
  };

  function saveCfg(){
    localStorage.setItem('hsm.webapp', CFG.url);
    localStorage.setItem('hsm.apikey', CFG.apiKey);
    paintCfgShort();
  }

  // Cola local
  function qLoad(){ try { return JSON.parse(localStorage.getItem('hsm.queue') || '[]'); } catch(_){ return []; } }
  function qSave(q){ localStorage.setItem('hsm.queue', JSON.stringify(q)); }

  // =============== UI HELPERS ===============
  function $(qs){ return document.querySelector(qs); }
  function toast(msg, cls){
    const t = $("#toast");
    t.textContent = msg;
    t.className = cls || '';
    t.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> t.style.display='none', 3500);
  }
  function short(s, n=54){ s=String(s||''); return s.length>n? s.slice(0,n-3)+'…' : s; }
  function paintCfgShort(){
    $("#cfg-url-short").textContent = short(CFG.url);
    $("#cfg-key-short").textContent = short(CFG.apiKey);
  }
  function setOnline(v){
    $("#net-badge").textContent = v?'Online':'Offline';
    $("#net-badge").style.background = v?'#0e2a1c':'#2a1717';
    $("#net-badge").style.border = v?'1px solid #1c5738':'1px solid #5b2a2a';
  }

  // =============== TABS ===============
  document.querySelectorAll('nav.tabs .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('nav.tabs .tab').forEach(b => b.setAttribute('aria-selected', String(b===btn)));
      document.querySelectorAll('main > section').forEach(s => s.hidden = (s.id !== 'tab-'+tab));
      if (tab === 'pend') paintPend();
    });
  });

  // =============== FORM UTILS ===============
  const btnHoy = $("#btn-hoy");
  const btnAhora = $("#btn-ahora");
  const inpFec = $("#fec");
  const inpHor = $("#hor");

  btnHoy.addEventListener('click', ()=>{
    const d = new Date();
    const iso = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    inpFec.value = iso;
  });
  btnAhora.addEventListener('click', ()=>{
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    inpHor.value = `${hh}:${mm}`;
  });

  // Chips observaciones
  document.querySelectorAll('[data-obs]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const v = b.getAttribute('data-obs');
      const t = $("#obs");
      const sep = t.value && !t.value.endsWith(' ') ? ' ' : '';
      t.value = (t.value || '') + sep + v;
    });
  });

  // =============== DUPE KEY ===============
  function dupeKeyFrom(item){
    const dni = String(item.DNI||'').trim();
    const f   = String(item.FechaIngresoManual||'').trim();   // yyyy-mm-dd
    const h   = String(item.HoraIngresoManual||'').trim();    // HH:mm
    return `${dni}|${f}|${h}`;
  }

  // Agregar/actualizar en cola evitando duplicar la misma DUPE_KEY
  function enqueueOnce(item){
    const q = qLoad();
    const key = item.DUPE_KEY || dupeKeyFrom(item);
    const idx = q.findIndex(x => x.DUPE_KEY === key && x._state !== 'sent');
    const payload = Object.assign({}, item, { DUPE_KEY:key, _state:'pend', retries:(idx>=0? q[idx].retries:0), ts:Date.now() });
    if (idx >= 0) q[idx] = payload; else q.push(payload);
    qSave(q);
    paintPend(); paintBadge();
  }

  // =============== SEND (sin headers → sin preflight) ===============
  async function sendOne(item){
    const body = JSON.stringify(Object.assign({}, item, { apiKey: CFG.apiKey }));
    const res  = await fetch(CFG.url, { method:'POST', body }); // sin headers
    if (!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json();
    if (!json.ok) throw new Error(json.error||'API error');
    return json;
  }

  // =============== RETRY LOOP ===============
  async function retryQueue(){
    const q = qLoad();
    let changed = false;
    for (let i=0;i<q.length;i++){
      const it = q[i];
      if (it._state==='sent') continue;
      try{
        await sendOne(it);
        it._state='sent'; changed=true;
      }catch(e){
        it.retries = (it.retries||0)+1;
      }
    }
    if (changed){
      // limpia enviados
      qSave(q.filter(x=>x._state!=='sent'));
    } else {
      qSave(q);
    }
    paintPend(); paintBadge();
  }

  // =============== PENDIENTES UI ===============
  function paintBadge(){
    const n = qLoad().filter(x=>x._state!=='sent').length;
    $("#pend-count").textContent = String(n);
  }
  function paintPend(){
    const tb = $("#pend-tb");
    const q = qLoad();
    tb.innerHTML = "";
    let n=0;
    q.forEach(it=>{
      if (it._state==='sent') return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${++n}</td>
        <td>${it.Tipo||'-'}</td>
        <td>${it.DNI||'-'}</td>
        <td>${it.FechaIngresoManual||'-'}</td>
        <td>${it.HoraIngresoManual||'-'}</td>
        <td><small>${it._state}${it.retries?` · r${it.retries}`:''}</small></td>
      `;
      tb.appendChild(tr);
    });
  }

  // =============== GUARDAR ===============
  let saving=false;
  $("#btn-guardar").addEventListener('click', async ()=>{
    if (saving) return;
    saving = true; $("#btn-guardar").disabled = true;

    const item = {
      Tipo: "ing",
      DNI: $("#dni").value.trim(),
      Sexo: $("#sexo").value || '-',
      FechaIngresoManual: $("#fec").value || '',
      HoraIngresoManual:  $("#hor").value || '',
      IdeacionIntento:    $("#ide").value || '-',
      MetodoLetalidad:    $("#met").value || '-',
      Consumo:            $("#cons").value || '-',
      Frecuencia:         $("#freq").value || '',
      DxCIE10:            $("#dx").value.trim(),
      Observaciones:      $("#obs").value.trim(),
      AppVersion: "v7-móvil"
    };

    // validación mínima
    if (!item.DNI || !item.FechaIngresoManual || !item.HoraIngresoManual){
      toast("Completá DNI, fecha y hora", "warn");
      saving=false; $("#btn-guardar").disabled=false;
      return;
    }

    try{
      await sendOne(item);
      toast("Ingreso guardado ✔","ok");
    }catch(_){
      enqueueOnce(item);
      toast("Sin conexión o error: quedó en pendientes","warn");
    }finally{
      saving=false; $("#btn-guardar").disabled=false;
      paintBadge();
      setTimeout(retryQueue, 1500);
    }
  });

  // =============== PENDIENTES: acciones ===============
  $("#btn-retry").addEventListener('click', retryQueue);
  $("#btn-vaciar").addEventListener('click', ()=>{
    qSave([]); paintPend(); paintBadge(); toast("Cola vacía","ok");
  });

  // =============== CONFIG DIALOG ===============
  const dlg = $("#dlg");
  $("#btn-cfg").addEventListener('click', openCfg);
  $("#btn-open-cfg").addEventListener('click', openCfg);
  $("#cfg-close").addEventListener('click', ()=> dlg.close());
  $("#cfg-save").addEventListener('click', ()=>{
    CFG.url = $("#cfg-url").value.trim() || CFG.url;
    CFG.apiKey = $("#cfg-key").value.trim() || CFG.apiKey;
    saveCfg(); dlg.close(); toast("Configuración guardada","ok");
  });
  $("#cfg-test").addEventListener('click', async ()=>{
    try{
      const r = await fetch(CFG.url+'?ping=1'); // GET simple (sin headers)
      const j = await r.json().catch(()=> ({}));
      toast(j && (j.ok||j.ping) ? "Ping OK" : "Ping recibido");
    }catch(_){ toast("Ping falló","err"); }
  });
  function openCfg(){
    $("#cfg-url").value = CFG.url;
    $("#cfg-key").value = CFG.apiKey;
    dlg.showModal();
  }

  // Accesos rápidos en Útiles
  $("#btn-ping").addEventListener('click', async ()=>{
    try{
      const r = await fetch(CFG.url+'?ping=1');
      const j = await r.json().catch(()=> ({}));
      $("#util-out").textContent = "Respuesta: "+JSON.stringify(j);
      toast("Ping OK","ok");
    }catch(e){
      $("#util-out").textContent = "Error: "+String(e);
      toast("Ping falló","err");
    }
  });

  // =============== INSTALL (PWA opcional) ===============
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; $("#btn-install").hidden=false; });
  $("#btn-install").addEventListener('click', async ()=>{
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice.catch(()=>{});
    deferredPrompt=null; $("#btn-install").hidden=true;
  });

  // =============== INIT ===============
  function initDefaults(){
    // precargar hoy/ahora
    $("#btn-hoy").click(); $("#btn-ahora").click();
    // estado conexión
    setOnline(navigator.onLine);
    window.addEventListener('online', ()=>{ setOnline(true); retryQueue(); });
    window.addEventListener('offline',()=> setOnline(false));
    // pintar
    paintCfgShort(); paintBadge(); paintPend();
    // reintentos periódicos
    setInterval(retryQueue, 15000);
  }
  initDefaults();
  </script>
</body>
</html>
