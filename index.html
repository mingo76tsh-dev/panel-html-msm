<!doctype html>
<html lang="es" dir="ltr">
<head>
  <!-- ===== Meta / PWA / SEO ===== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="HSM v7 • Móvil — Ingreso y alta rápida con soporte offline y cola de pendientes." />
  <title>HSM v7 • Móvil</title>

  <!-- Manifest + favicons -->
  <link rel="manifest" href="/panel-html-msm/manifest.json">
  <link rel="icon" href="/panel-html-msm/icons/favicon-32.png" type="image/png" sizes="32x32">
  <link rel="icon" href="/panel-html-msm/icons/favicon-16.png" type="image/png" sizes="16x16">
  <link rel="apple-touch-icon" href="/panel-html-msm/icons/apple-touch-icon.png" sizes="180x180" />

  <!-- LCP: PRELOAD consistente con #logo -->
  <link rel="preload" as="image"
        href="/panel-html-msm/icons/icon-512.png"
        imagesrcset="/panel-html-msm/icons/icon-192.png 192w, /panel-html-msm/icons/icon-512.png 512w"
        imagesizes="44px">

  <!-- Preconexiones (Apps Script) -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://script.googleapis.com" crossorigin>

  <!-- ===== Estilos ===== -->
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--ink:#e5e7eb;--mut:#94a3b8;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--acc:#60a5fa;
      --field:#0b1329;--bd:#1f2a44;--chip:#1f2937;--shadow:0 8px 28px rgba(0,0,0,.35);--focus:0 0 0 2px rgba(59,130,246,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;contain:content}
    header.app{display:grid;grid-template-columns:44px 12px 1fr 78px 1fr 96px 48px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--bd);min-height:64px}
    .title{font-weight:800;letter-spacing:.3px;margin:0;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #logo{grid-column:1;height:44px;width:44px;object-fit:cover;border-radius:8px;vertical-align:middle}
    #online{grid-column:4;min-width:78px;justify-content:center}
    .sp{grid-column:5}
    #btnInstall{grid-column:6;width:96px;text-align:center;visibility:hidden;opacity:0;transition:opacity .2s}
    #btnInstall.shown{visibility:visible;opacity:1}
    #btnCfg{grid-column:7;width:48px;text-align:center}

    .badge{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;font-size:12px;background:rgba(148,163,184,.16);color:#cbd5e1;border:1px solid var(--bd)}
    .badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
    .badge.off{background:rgba(148,163,184,.12);color:#94a3b8}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--acc);color:#04121f}
    .btn.sec{background:#1f2937;color:#d1d5db}
    .btn.ghost{background:transparent;border:1px solid var(--bd);color:#cbd5e1}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:740px){.row{grid-template-columns:1fr}}
    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    input,select,textarea{width:100%;background:var(--field);color:var(--ink);border:1px solid var(--bd);border-radius:12px;padding:11px 12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#3b82f6;box-shadow:var(--focus)}
    textarea{min-height:90px;resize:vertical}
    nav.tabs{display:flex;gap:6px;border-bottom:1px solid var(--bd);padding:10px 10px 0}
    .tab{padding:8px 12px;border-radius:9px 9px 0 0;background:#111a2c;border:1px solid var(--bd);border-bottom:0;color:#cbd5e1;cursor:pointer;font-weight:700;text-decoration:none;-webkit-tap-highlight-color:transparent}
    .tab[aria-selected="true"]{background:var(--card);color:#fff}
    section.view{padding:12px;content-visibility:auto;contain-intrinsic-size:800px 1200px}
    .kv{display:flex;gap:8px;align-items:center}.kv input{flex:1}
    .st{margin-top:10px;font-size:13px}.ok{color:#86efac}.err{color:#fca5a5}.mut{color:#94a3b8}
    .chips{display:flex;flex-wrap:wrap;gap:8px}.chip,.pill{background:var(--chip);border:1px solid var(--bd);color:#d1d5db;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;text-decoration:none}
    .list{border:1px solid var(--bd);border-radius:12px;overflow:hidden}.item{display:flex;gap:12px;padding:10px 12px;border-bottom:1px solid var(--bd);align-items:center}.item:last-child{border-bottom:0}
    .small{font-size:12px;color:#94a3b8}hr{border:0;border-top:1px solid var(--bd);margin:14px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,23,42,.96);color:#e5e7eb;border:1px solid var(--bd);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;display:none}
    dialog#cfg{border:1px solid var(--bd);border-radius:16px;background:#0f172a;color:#e5e7eb;max-width:560px;width:92%}dialog::backdrop{background:rgba(2,6,23,.55)}
    :focus-visible{outline:2px solid #60a5fa;outline-offset:2px}
    @media (prefers-reduced-motion:reduce){
      *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
    }

    /* Vistas por hash: la activa se muestra */
    .view{display:none}
    :root:has(:target#ing)  #v-ing,
    :root:has(:target#alta) #v-alta,
    :root:has(:target#pend) #v-pend,
    :root:has(:target#util) #v-util{display:block}

    .footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;color:#a8b3c7;font-size:12px;border-top:1px solid var(--bd);background:#0f172a}
    .visually-hidden{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <noscript>
    <div class="wrap"><div class="card" style="padding:12px;margin-top:12px">Se requiere JavaScript para usar esta aplicación.</div></div>
  </noscript>
  <a class="visually-hidden" href="#main">Saltar al contenido</a>

  <main id="main" class="wrap" role="main">
    <article class="card" aria-label="Aplicación HSM v7 Móvil">
      <header class="app">
        <img id="logo" alt="Logo de la institución"
             src="/panel-html-msm/icons/icon-512.png"
             width="44" height="44" decoding="async" fetchpriority="high"
             style="visibility:hidden;opacity:0;transition:opacity .2s">
        <div></div>
        <h1 class="title">HSM v7 • Móvil</h1>
        <span id="online" class="badge off" aria-live="polite" title="Estado de red">Offline</span>
        <span class="sp"></span>
        <button id="btnInstall" class="btn sec" type="button" hidden>Instalar</button>
        <button id="btnCfg" class="btn sec" aria-haspopup="dialog" aria-controls="cfg" title="Configuración" type="button">⚙️</button>
      </header>

      <nav class="tabs" aria-label="Secciones">
        <a class="tab" href="#ing"  id="tab-ing"  aria-selected="true">Ingreso</a>
        <a class="tab" href="#alta" id="tab-alta" aria-selected="false">Alta</a>
        <a class="tab" href="#pend" id="tab-pend" aria-selected="false">Pendientes</a>
        <a class="tab" href="#util" id="tab-util" aria-selected="false">Útiles</a>
      </nav>

      <!-- ========== Vistas ========== -->
      <section id="v-ing" class="view" aria-labelledby="tab-ing">
        <!-- (Colocá acá tu formulario real de ingreso — placeholder mínimo para estructura) -->
        <div class="row">
          <div>
            <label for="dni">DNI</label>
            <input id="dni" placeholder="7–9 dígitos" inputmode="numeric">
          </div>
          <div>
            <label for="sexo">Sexo</label>
            <select id="sexo"><option>—</option><option>F</option><option>M</option><option>X</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="fi">Fecha ingreso</label>
            <input id="fi" type="text" placeholder="dd/mm/aaaa">
          </div>
          <div>
            <label for="hi">Hora ingreso</label>
            <input id="hi" type="text" placeholder="hh:mm">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="cie">Dx CIE-10 (código)</label>
            <input id="cie" placeholder="Ej: F32.1">
          </div>
          <div>
            <label for="obs">Observaciones</label>
            <input id="obs" placeholder="Notas breves (opcional)">
          </div>
        </div>
        <div class="kv" style="margin-top:12px">
          <button class="btn" type="button">Guardar ingreso</button>
          <button class="btn sec" type="button">Compartir comprobante</button>
        </div>
        <hr>
        <div class="small mut">Tip: admite <code>?dni=&amp;sexo=&amp;fi=YYYY-MM-DD</code> para prellenar.</div>
      </section>

      <section id="v-alta" class="view" aria-labelledby="tab-alta">
        <!-- Placeholder liviano -->
        <div class="row">
          <div>
            <label for="dni2">DNI</label>
            <input id="dni2" placeholder="7–9 dígitos" inputmode="numeric">
          </div>
          <div>
            <label for="nac">Fecha Nac. (opcional)</label>
            <input id="nac" placeholder="dd/mm/aaaa">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="sexo2">Sexo</label>
            <select id="sexo2"><option>—</option><option>F</option><option>M</option><option>X</option></select>
          </div>
          <div>
            <label for="fa">Fecha alta</label>
            <input id="fa" placeholder="dd/mm/aaaa">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="ha">Hora alta</label>
            <input id="ha" placeholder="hh:mm">
          </div>
          <div>
            <label for="obs2">Observaciones</label>
            <input id="obs2" placeholder="Breve detalle (opcional)">
          </div>
        </div>
        <div class="kv" style="margin-top:12px">
          <button class="btn" type="button">Guardar alta</button>
          <button class="btn sec" type="button">Compartir comprobante</button>
        </div>
      </section>

      <section id="v-pend" class="view" aria-labelledby="tab-pend">
        <div class="kv">
          <button class="btn" type="button">Enviar pendientes</button>
          <button class="btn sec" type="button">Exportar JSON</button>
          <button class="btn sec" type="button">Importar JSON</button>
          <span class="pill">0</span>
        </div>
        <hr>
      </section>

      <section id="v-util" class="view" aria-labelledby="tab-util">
        <div class="row">
          <div>
            <label for="dniScan">Escáner rápido (DNI)</label>
            <input id="dniScan" placeholder="DNI">
          </div>
          <div style="align-self:end">
            <button class="btn sec" type="button">Validar</button>
          </div>
        </div>
        <hr>
        <div class="chips">
          <a class="chip" href="#ing">Ir a Ingreso</a>
          <a class="chip" href="#alta">Ir a Alta</a>
          <a class="chip" href="#pend">Ver Pendientes</a>
        </div>
        <hr>
        <div class="small mut">Versión app: v7-móvil</div>
      </section>

      <footer class="footer">
        <span>“Sembrando esperanza, cultivando bienestar”</span>
        <span> · </span>
        <span>Desarrollado por Lic. Domingo Alarcón · HSM v7</span>
      </footer>
    </article>
  </main>

  <!-- Config dialog + toast -->
  <dialog id="cfg" aria-labelledby="cfg-title">
    <form method="dialog" style="padding:14px">
      <h3 id="cfg-title" style="margin:0 0 10px">Configuración</h3>
      <label for="cfg_url">WebApp URL (/exec)</label>
      <input id="cfg_url" placeholder="https://script.google.com/macros/s/.../exec" inputmode="url">
      <label for="cfg_key">API Key</label>
      <input id="cfg_key" placeholder="Si está activa">
      <label for="cfg_logo">Logo URL (png/jpg/svg)</label>
      <input id="cfg_logo" placeholder="https://.../logo.png" inputmode="url">
      <div class="kv" style="margin-top:10px;gap:8px">
        <button class="btn sec" id="cfgTest" type="button">Probar</button>
        <button class="btn">Guardar</button>
      </div>
      <div id="cfgMsg" class="small" style="margin-top:8px" aria-live="polite"></div>
    </form>
  </dialog>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ======== LÓGICA / PWA (liviana) ======== -->
  <script>
  // Tabs ARIA (solo marca aria-selected según hash)
  function syncTabs() {
    const id = (location.hash || "#ing").slice(1);
    for (const idTab of ["ing","alta","pend","util"]) {
      const el = document.getElementById("tab-"+idTab);
      if (el) el.setAttribute("aria-selected", idTab===id ? "true" : "false");
    }
  }
  window.addEventListener("hashchange", syncTabs, { passive:true });

  // Estado de red
  const $online = document.getElementById("online");
  function paintOnline() {
    const on = navigator.onLine;
    $online.textContent = on ? "Online" : "Offline";
    $online.classList.toggle("ok", on);
    $online.classList.toggle("off", !on);
  }
  addEventListener("online",  paintOnline);
  addEventListener("offline", paintOnline);
  paintOnline();

  // Logo: mostrar cuando cargó (evita CLS)
  const logo = document.getElementById("logo");
  if (logo.complete) { logo.style.visibility="visible"; logo.style.opacity="1"; }
  else logo.addEventListener("load", () => { logo.style.visibility="visible"; logo.style.opacity="1"; }, { once:true });

  // Install prompt
  let deferredPrompt;
  const btnInstall = document.getElementById("btnInstall");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault(); deferredPrompt = e;
    btnInstall.hidden = false; btnInstall.classList.add("shown");
  });
  btnInstall.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btnInstall.classList.remove("shown"); btnInstall.hidden = true;
  });

  // Config dialog
  document.getElementById("btnCfg").addEventListener("click", () => document.getElementById("cfg").showModal());

  // Toast helper
  const toast = (msg, ms=1800) => {
    const t = document.getElementById("toast");
    t.textContent = msg; t.style.display = "block";
    setTimeout(()=>{ t.style.display="none"; }, ms);
  };

  // Atajo para forzar update del SW (Ctrl+Alt+U)
  document.addEventListener("keydown", (ev) => {
    if (ev.ctrlKey && ev.altKey && (ev.key==='u' || ev.key==='U')) {
      navigator.serviceWorker?.getRegistration().then(reg=>{
        reg?.waiting?.postMessage({type:'SKIP_WAITING'});
        toast("Forzando actualización…");
        setTimeout(()=>location.reload(), 800);
      });
    }
  });

  // Registrar SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/panel-html-msm/sw.js').then(reg => {
        // Nuevo SW listo para activar
        if (reg.waiting) { toast("Nueva versión disponible"); }
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              toast("Nueva versión disponible");
            }
          });
        });
        // Mensaje desde SW terminado
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          toast("Actualizado"); setTimeout(()=>location.reload(), 300);
        });
      }).catch(() => {});
    }, { once:true });
  }

  // Hash por defecto
  if (!location.hash) location.hash = "#ing";
  syncTabs();
  </script>
</body>
</html>

