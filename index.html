<!doctype html>
<html lang="es" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>HSM v7 • Móvil</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon.png" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --mut:#94a3b8;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --acc:#60a5fa;
      --field:#0b1329; --bd:#1f2a44; --chip:#1f2937; --shadow:0 8px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .header{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--bd)}
    .header .title{font-weight:800; letter-spacing:.3px}
    .header .sp{flex:1}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;font-size:12px;background:rgba(148,163,184,.16);color:#cbd5e1;border:1px solid var(--bd)}
    .badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
    .badge.off{background:rgba(148,163,184,.12);color:#94a3b8}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--acc);color:#031532}
    .btn.sec{background:#1f2937;color:#d1d5db}
    .btn.warn{background:var(--warn);color:#051019}
    .btn.ghost{background:transparent;border:1px solid var(--bd);color:#cbd5e1}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }
    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    input,select,textarea{
      width:100%; background:var(--field); color:var(--ink);
      border:1px solid var(--bd); border-radius:12px; padding:11px 12px; outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.25)}
    textarea{min-height:90px;resize:vertical}
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--bd);padding:10px 10px 0}
    .tab{padding:8px 12px;border-radius:9px 9px 0 0;background:#111a2c;border:1px solid var(--bd);border-bottom:0;color:#cbd5e1;cursor:pointer;font-weight:700}
    .tab.act{background:var(--card);color:#fff}
    .view{padding:12px}
    .kv{display:flex; gap:8px; align-items:center}
    .kv input{flex:1}
    .st{margin-top:10px;font-size:13px}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .mut{color:#94a3b8}
    .logo{height:44px; width:auto; object-fit:contain; border-radius:8px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:var(--chip); border:1px solid var(--bd); color:#d1d5db; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer}
    .list{border:1px solid var(--bd); border-radius:12px; overflow:hidden}
    .item{display:flex;gap:12px; padding:10px 12px; border-bottom:1px solid var(--bd); align-items:center}
    .item:last-child{border-bottom:0}
    .small{font-size:12px;color:var(--mut)}
    hr{border:0;border-top:1px solid var(--bd); margin:14px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,23,42,.96);color:#e5e7eb;border:1px solid var(--bd);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;display:none}
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="header">
      <img id="logo" class="logo" alt="logo" src="" hidden>
      <div class="title">HSM v7 • Móvil</div>
      <span id="online" class="badge off">Offline</span>
      <span class="sp"></span>
      <button id="btnInstall" class="btn sec" style="display:none">Instalar</button>
      <button id="btnCfg" class="btn sec">⚙️</button>
    </div>

    <!-- NAV TABS -->
    <div class="tabs">
      <div class="tab act" data-v="ing">Ingreso</div>
      <div class="tab" data-v="alta">Alta</div>
      <div class="tab" data-v="pend">Pendientes</div>
      <div class="tab" data-v="util">Útiles</div>
    </div>

    <!-- INGRESO -->
    <div id="v-ing" class="view">
      <div class="row">
        <div>
          <label>DNI</label>
          <div class="kv">
            <input id="i_dni" type="tel" inputmode="numeric" placeholder="7–9 dígitos">
            <button class="btn sec" id="dniCam">Cargar</button>
          </div>
        </div>
        <div>
          <label>Sexo</label>
          <select id="i_sexo"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fecha ingreso</label>
          <div class="kv">
            <input id="i_fi" type="date"><button class="btn sec" id="iFiNow">Ahora</button>
          </div>
        </div>
        <div>
          <label>Hora ingreso</label>
          <div class="kv">
            <input id="i_hi" type="time"><button class="btn sec" id="iHiNow">Ahora</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ideación / Intento</label>
          <select id="i_ii">
            <option value="">—</option><option>Ideación</option><option>Intento</option>
          </select>
        </div>
        <div>
          <label>Método / Letalidad</label>
          <select id="i_met">
            <option value="">—</option>
            <option>Intoxicación</option><option>Corte</option><option>Colgamiento</option>
            <option>Arma de fuego</option><option>Arrojo</option><option>Otro</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Consumo</label>
          <select id="i_con"><option value="">—</option><option>Sí</option><option>No</option></select>
        </div>
        <div>
          <label>Tipo Sustancia</label>
          <select id="i_sus"><option value=""></option><option>Alcohol</option><option>BZD</option><option>Opioides</option><option>Cocaína</option><option>THC</option><option>Mixto</option></select>
        </div>
      </div>

      <label>Dx CIE-10 (código)</label>
      <input id="i_cie" list="cie-list" placeholder="Ej: F32.1">
      <datalist id="cie-list"></datalist>

      <label>Observaciones</label>
      <textarea id="i_obs" placeholder="Notas breves (opcional)"></textarea>
      <div class="chips" id="tpls">
        <div class="chip" data-t="+Observación breve sin particularidades.">Obs. SP</div>
        <div class="chip" data-t="+Se informa red de apoyo presente.">Red apoyo ✓</div>
        <div class="chip" data-t="+Niega consumo reciente.">Niega consumo</div>
        <div class="chip" data-t="+Acompañante en guardia.">Acompañante</div>
      </div>

      <div class="st mut" id="ingMsg"></div>
      <div class="kv" style="margin-top:12px; gap:10px; flex-wrap:wrap">
        <button class="btn" id="ingSave">Guardar ingreso</button>
        <button class="btn ghost" id="ingShare">Compartir comprobante</button>
      </div>
      <div class="small">Tip: admite <code>?dni=&amp;sexo=&amp;fi=YYYY-MM-DD</code> para prellenar.</div>
    </div>

    <!-- ALTA -->
    <div id="v-alta" class="view" style="display:none">
      <div class="row">
        <div>
          <label>DNI</label>
          <input id="a_dni" type="tel" inputmode="numeric" placeholder="7–9 dígitos">
        </div>
        <div>
          <label>Fecha Nac. (opcional)</label>
          <input id="a_fn" type="date">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Sexo</label>
          <select id="a_sexo"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
        </div>
        <div>
          <label>Buscar ingreso</label>
          <div class="kv">
            <button class="btn sec" id="aSearch">Buscar por DNI</button>
            <span id="aFound" class="hint"></span>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fecha alta</label>
          <div class="kv">
            <input id="a_fa" type="date"><button class="btn sec" id="aFaNow">Ahora</button>
          </div>
        </div>
        <div>
          <label>Hora alta</label>
          <div class="kv">
            <input id="a_ha" type="time"><button class="btn sec" id="aHaNow">Ahora</button>
          </div>
        </div>
      </div>

      <label>Estado</label>
      <select id="a_estado">
        <option>Alta</option><option>Derivación</option><option>Fuga</option><option>Traslado</option><option>Óbito</option>
      </select>

      <label>Observaciones</label>
      <textarea id="a_obs" placeholder="Breve detalle (opcional)"></textarea>

      <div class="st mut" id="altaMsg"></div>
      <div class="kv" style="margin-top:12px; gap:10px; flex-wrap:wrap">
        <button class="btn" id="altaSave">Guardar alta</button>
        <button class="btn ghost" id="altaShare">Compartir comprobante</button>
      </div>
    </div>

    <!-- PENDIENTES -->
    <div id="v-pend" class="view" style="display:none">
      <div class="kv" style="gap:8px; flex-wrap:wrap">
        <button class="btn sec" id="flush">Enviar pendientes</button>
        <button class="btn ghost" id="exp">Exportar JSON</button>
        <input id="impFile" type="file" accept="application/json" style="display:none">
        <button class="btn ghost" id="imp">Importar JSON</button>
        <span id="pendInfo" class="badge off">0</span>
      </div>
      <hr/>
      <div class="list" id="pendList"></div>
    </div>

    <!-- ÚTILES -->
    <div id="v-util" class="view" style="display:none">
      <div class="row">
        <div class="card" style="padding:12px">
          <b>Escáner rápido (DNI)</b><br>
          <div class="small">Usá la cámara/teclado del celular para pegar/teclear DNI y validar.</div>
          <div class="kv" style="margin-top:8px">
            <input id="u_dni" type="tel" inputmode="numeric" placeholder="DNI">
            <button class="btn sec" id="uVal">Validar</button>
          </div>
          <div id="u_res" class="st mut"></div>
        </div>
        <div class="card" style="padding:12px">
          <b>Atajos</b>
          <div class="chips" style="margin-top:8px">
            <div class="chip" data-go="ing">Ir a Ingreso</div>
            <div class="chip" data-go="alta">Ir a Alta</div>
            <div class="chip" data-go="pend">Ver Pendientes</div>
          </div>
          <hr>
          <div class="small">Versión app: <span id="vver">v7-móvil</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CONFIG -->
<dialog id="cfg" style="border:1px solid var(--bd); border-radius:16px; background:#0f172a; color:#e5e7eb; max-width:560px; width:92%">
  <form method="dialog" style="padding:14px">
    <h3 style="margin:0 0 10px">Configuración</h3>
    <label>WebApp URL (/exec)</label>
    <input id="cfg_url" placeholder="https://script.google.com/macros/s/.../exec">
    <label>API Key</label>
    <input id="cfg_key" placeholder="Si está activa">
    <label>Logo URL (png/jpg/svg)</label>
    <input id="cfg_logo" placeholder="https://.../logo.png">
    <div class="kv" style="margin-top:10px; gap:8px">
      <button class="btn sec" id="cfgTest" type="button">Probar</button>
      <button class="btn">Guardar</button>
    </div>
    <div id="cfgMsg" class="small" style="margin-top:8px"></div>
  </form>
</dialog>

<div id="toast" class="toast"></div>

<script>
/* ===== Utilidades base ===== */
const LS={get(k,d=null){try{const v=localStorage.getItem(k);return v==null?d:JSON.parse(v)}catch(_){return localStorage.getItem(k)||d}},
          set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(_){localStorage.setItem(k,v)}},
          del(k){localStorage.removeItem(k)}};
const $=s=>document.querySelector(s);
const fmtDate=ts=>new Date(ts).toLocaleString();
const vibrate=p=>('vibrate' in navigator)&&navigator.vibrate(p);

/* ===== API ===== */
const API={
  url(){return LS.get('HSM_WEBAPP_URL','')},
  key(){return LS.get('HSM_API_KEY','')},
  async call(action,payload={}){
    const u=API.url(); if(!u) throw new Error('Sin URL configurada');
    // Simple request SIN preflight
    const r = await fetch(u,{
      method:'POST',
      headers:{ 'Content-Type':'text/plain' },
      body: JSON.stringify({ action, apiKey: API.key(), ...payload })
    });
    const t = await r.text();
    if(!r.ok) throw new Error('HTTP '+r.status+' '+t);
    try { return JSON.parse(t); } catch { return { ok:false, raw:t }; }
  }
};

/* ===== Toast ===== */
function toast(txt,ms=2200){const t=$("#toast");t.textContent=txt;t.style.display='block';setTimeout(()=>t.style.display='none',ms)}

/* ===== PWA: instalar (botón) & SW ===== */
let _deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();_deferredPrompt=e;$('#btnInstall').style.display='inline-block';});
$('#btnInstall').onclick=async()=>{ if(!_deferredPrompt) return; _deferredPrompt.prompt(); await _deferredPrompt.userChoice; _deferredPrompt=null; $('#btnInstall').style.display='none';};
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{})); }

/* ===== Estado online ===== */
function setOnline(ok){const b=$('#online');b.textContent=ok?'Online':'Offline';b.className='badge '+(ok?'ok':'off')}
window.addEventListener('online',()=>setOnline(true));
window.addEventListener('offline',()=>setOnline(false));
setOnline(navigator.onLine);

/* ===== Logo ===== */
function applyLogo(){
  const u=LS.get('HSM_LOGO_URL',''), el=$('#logo');
  if(u){ el.src=u; el.hidden=false; } else { el.hidden=true; }
}

/* ===== Tabs ===== */
function wireTabs(){
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('act'));
      t.classList.add('act');
      const v=t.dataset.v;
      ['ing','alta','pend','util'].forEach(id=>{
        const el=$('#v-'+id); if(el) el.style.display=(id===v?'block':'none');
      });
      if(v==='pend') renderPend();
    };
  });
  (document.querySelector('.tab.act')||document.querySelector('.tab[data-v="ing"]')||document.querySelector('.tab'))?.click();
}

/* ===== Helpers fechas ===== */
function nowDate(){return new Date().toISOString().slice(0,10)}
function nowTime(){return new Date().toTimeString().slice(0,5)}
$('#iFiNow').onclick=()=>$('#i_fi').value=nowDate();
$('#iHiNow').onclick=()=>$('#i_hi').value=nowTime();
$('#aFaNow').onclick=()=>$('#a_fa').value=nowDate();
$('#aHaNow').onclick=()=>$('#a_ha').value=nowTime();

/* ===== Chips ===== */
$('#tpls').addEventListener('click',e=>{const t=e.target.closest('.chip'); if(!t) return; $('#i_obs').value=(($('#i_obs').value||'')+' '+t.dataset.t).trim(); $('#i_obs').focus();});

/* ===== Validaciones ===== */
function validDNI(v){ return /^\d{7,9}$/.test((v||'').trim()); }

/* ===== Outbox ===== */
function boxGet(){ return LS.get('HSM_OUTBOX',[]); }
function boxSet(a){ LS.set('HSM_OUTBOX',a); const n=a.length; $('#pendInfo').textContent=n; $('#pendInfo').className='badge '+(n?'ok':'off'); }
async function boxFlush(){
  const box=boxGet(); if(!box.length){ toast('No hay pendientes'); return; }
  $('#pendInfo').textContent='…';
  const rest=[];
  for(const it of box){
    try{
      if(it.kind==='ingreso') await API.call('save',{payload:it.payload});
      if(it.kind==='alta')    await API.call('alta',{payload:it.payload});
    }catch(_){ rest.push(it); }
  }
  boxSet(rest);
  toast(rest.length?('Quedan '+rest.length+' pendientes'): 'Pendientes enviados ✔');
  renderPend();
}
$('#flush').onclick=boxFlush;
$('#exp').onclick=()=>{ const a=document.createElement('a'); a.download='hsm_outbox.json'; a.href=URL.createObjectURL(new Blob([JSON.stringify(boxGet())],{type:'application/json'})); a.click(); };
$('#imp').onclick=()=>$('#impFile').click();
$('#impFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{ try{ const arr=JSON.parse(rd.result||'[]'); const cur=boxGet(); boxSet(cur.concat(arr)); renderPend(); toast('Importado'); }catch(_){ toast('Archivo inválido',2600) } };
  rd.readAsText(f);
};
function renderPend(){
  const box=boxGet(), el=$('#pendList'); el.innerHTML='';
  if(!box.length){ el.innerHTML='<div class="item"><span class="mut">No hay pendientes.</span></div>'; return; }
  box.forEach((it,ix)=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<div class="small">${it.kind.toUpperCase()}</div>
      <div>DNI <b>${it.payload.DNI||'?'}</b> • ${fmtDate(it.ts)}</div>
      <span class="sp"></span>
      <button class="btn ghost" data-i="${ix}">Borrar</button>`;
    el.appendChild(d);
  });
  el.onclick=e=>{ const b=e.target.closest('button'); if(!b) return; const idx=+b.dataset.i; const box=boxGet(); box.splice(idx,1); boxSet(box); renderPend(); };
}

/* ===== Anti-duplicado ===== */
function recentKey(kind,dni){ return `HSM_REC_${kind}_${dni}`; }
function dedupeSet(kind,dni){ LS.set(recentKey(kind,dni), Date.now()); }
function dedupeHit(kind,dni,ms=60000){ const t=LS.get(recentKey(kind,dni),0); return (Date.now()-t)<ms; }

/* ===== Autosave ===== */
const DRAFT_ING='HSM_DRAFT_ING', DRAFT_ALTA='HSM_DRAFT_ALTA';
function saveDraft(id,fields){ const o={}; fields.forEach(f=>o[f]=$('#'+f)?.value??''); LS.set(id,o); }
function loadDraft(id,fields){ const o=LS.get(id,null); if(!o) return; fields.forEach(f=>{ if(o[f]!=null && $('#'+f)) $('#'+f).value=o[f]; }); }
['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs'].forEach(id=>$('#'+id).addEventListener('input',()=>saveDraft(DRAFT_ING,['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs'])));
['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs'].forEach(id=>$('#'+id).addEventListener('input',()=>saveDraft(DRAFT_ALTA,['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs'])));

/* ===== Ingreso ===== */
let lastReceipt=null;
$('#ingSave').onclick=async ()=>{
  try{
    const dni=$('#i_dni').value.trim();
    if(!validDNI(dni)){ $('#ingMsg').textContent='DNI inválido'; $('#ingMsg').className='st err'; vibrate(200); return; }
    if(dedupeHit('ing',dni)){ toast('Ingreso enviado hace instantes'); return; }

    const payload={
      DNI:dni, Sexo:$('#i_sexo').value,
      FechaIngresoManual:$('#i_fi').value, HoraIngresoManual:$('#i_hi').value,
      IdeacionIntento:$('#i_ii').value, MetodoLetalidad:$('#i_met').value,
      Consumo:$('#i_con').value, TipoSustancia:$('#i_sus').value,
      DxProvisorio_CIE10:$('#i_cie').value, Observaciones:$('#i_obs').value
    };
    $('#ingMsg').textContent='Guardando…'; $('#ingMsg').className='st mut';
    const j=await API.call('save',{payload});
    if(j&&j.ok){
      $('#ingMsg').textContent='Guardado ✔'; $('#ingMsg').className='st ok';
      lastReceipt={kind:'Ingreso',dni,ts:Date.now()};
      dedupeSet('ing',dni); LS.del(DRAFT_ING); vibrate([60,40,60]);
    } else throw new Error(j&&j.message||'desconocido');
  }catch(e){
    const it={kind:'ingreso',payload:{
      DNI:$('#i_dni').value.trim(), Sexo:$('#i_sexo').value,
      FechaIngresoManual:$('#i_fi').value, HoraIngresoManual:$('#i_hi').value,
      IdeacionIntento:$('#i_ii').value, MetodoLetalidad:$('#i_met').value,
      Consumo:$('#i_con').value, TipoSustancia:$('#i_sus').value,
      DxProvisorio_CIE10:$('#i_cie').value, Observaciones:$('#i_obs').value
    }, ts:Date.now()};
    const box=boxGet(); box.push(it); boxSet(box);
    $('#ingMsg').textContent='Sin red. Guardado en pendientes ('+box.length+')'; $('#ingMsg').className='st err'; vibrate(150);
  }
};
$('#ingShare').onclick=()=>{ const txt = lastReceipt? `HSM • ${lastReceipt.kind} DNI ${lastReceipt.dni} • ${fmtDate(lastReceipt.ts)}` : 'HSM • Ingreso registrado'; if(navigator.share) navigator.share({text:txt}).catch(()=>{}); else navigator.clipboard.writeText(txt).then(()=>toast('Copiado')); };

/* ===== Alta ===== */
$('#aSearch').onclick=async ()=>{
  try{
    const dni=$('#a_dni').value.trim(); if(!validDNI(dni)){ $('#aFound').textContent=' DNI inválido'; return; }
    $('#aFound').textContent=' Buscando…';
    const j=await API.call('find',{dni, days:120}).catch(()=>null);
    if(j && j.ok && j.row){ $('#aFound').textContent=' Encontrado (fila '+j.row+')'; if(j.sexo) $('#a_sexo').value=(j.sexo||'').toUpperCase(); }
    else { $('#aFound').textContent=' No hallado (continuar manual)'; }
  }catch(_){ $('#aFound').textContent=' Offline (buscará al enviar)'; }
};
$('#altaSave').onclick=async ()=>{
  try{
    const dni=$('#a_dni').value.trim();
    if(!validDNI(dni)){ $('#altaMsg').textContent='DNI inválido'; $('#altaMsg').className='st err'; vibrate(200); return; }
    if(dedupeHit('alta',dni)){ toast('Alta enviada hace instantes'); return; }

    const payload={
      DNI:dni, Sexo:$('#a_sexo').value,
      FechaAltaManual:$('#a_fa').value, HoraAltaManual:$('#a_ha').value,
      EstadoEgreso:$('#a_estado').value, Observaciones:$('#a_obs').value
    };
    $('#altaMsg').textContent='Guardando…'; $('#altaMsg').className='st mut';
    const j=await API.call('alta',{payload});
    if(j&&j.ok){
      $('#altaMsg').textContent='Alta guardada ✔'; $('#altaMsg').className='st ok';
      lastReceipt={kind:'Alta',dni,ts:Date.now()};
      dedupeSet('alta',dni); LS.del(DRAFT_ALTA); vibrate([60,40,60]);
    } else throw new Error(j&&j.message||'desconocido');
  }catch(e){
    const it={kind:'alta',payload:{
      DNI:$('#a_dni').value.trim(), Sexo:$('#a_sexo').value,
      FechaAltaManual:$('#a_fa').value, HoraAltaManual:$('#a_ha').value,
      EstadoEgreso:$('#a_estado').value, Observaciones:$('#a_obs').value
    }, ts:Date.now()};
    const box=boxGet(); box.push(it); boxSet(box);
    $('#altaMsg').textContent='Sin red. Guardado en pendientes ('+box.length+')'; $('#altaMsg').className='st err'; vibrate(150);
  }
};
$('#altaShare').onclick=()=>{ const txt = lastReceipt? `HSM • ${lastReceipt.kind} DNI ${lastReceipt.dni} • ${fmtDate(lastReceipt.ts)}` : 'HSM • Alta registrada'; if(navigator.share) navigator.share({text:txt}).catch(()=>{}); else navigator.clipboard.writeText(txt).then(()=>toast('Copiado')); };

/* ===== Config ===== */
$('#btnCfg').onclick=()=>{ $('#cfg_url').value=API.url()||''; $('#cfg_key').value=API.key()||''; $('#cfg_logo').value=LS.get('HSM_LOGO_URL','')||''; $('#cfg').showModal(); };
$('#cfg').addEventListener('close',()=>{ const u=$('#cfg_url').value.trim(), k=$('#cfg_key').value.trim(), l=$('#cfg_logo').value.trim(); if(u) LS.set('HSM_WEBAPP_URL',u); else LS.del('HSM_WEBAPP_URL'); if(k) LS.set('HSM_API_KEY',k); else LS.del('HSM_API_KEY'); if(l) LS.set('HSM_LOGO_URL',l); else LS.del('HSM_LOGO_URL'); applyLogo(); toast('Configuración guardada'); });
$('#cfgTest').onclick=async ()=>{ try{ const r=await API.call('ping'); $('#cfgMsg').textContent='OK '+(r.version||''); toast('WebApp OK'); } catch(e){ $('#cfgMsg').textContent='Error: '+(e.message||e); toast('No conecta',2600) } };

/* ===== Útiles ===== */
$('#uVal').onclick=()=>{ const v=$('#u_dni').value.trim(); const ok=validDNI(v); $('#u_res').textContent = ok? 'Formato válido ✔' : 'Formato inválido'; $('#u_res').className = 'st ' + (ok?'ok':'err'); };
document.querySelectorAll('.chip[data-go]').forEach(c=>c.onclick=()=>document.querySelector(`.tab[data-v="${c.dataset.go}"]`).click());

/* ===== CIE10 cache (10 min) ===== */
(async function loadCIE(){
  try{
    const ck='CIE_CACHE', ts='CIE_TS', now=Date.now();
    let list=LS.get(ck,null), t=LS.get(ts,0);
    if(!list || (now-t)>600000){
      const j=await API.call('cie10_list'); list=(j&&j.ok&&j.list)||[];
      LS.set(ck,list); LS.set(ts,now);
    }
    const dl=$('#cie-list'); dl.innerHTML='';
    list.slice(0,2000).forEach(x=>{ const o=document.createElement('option'); o.value=x.code; o.label=x.desc; dl.appendChild(o); });
  }catch(_){ /* silencioso */ }
})();

/* ===== Prefill por query ===== */
(function prefill(){
  const q=new URLSearchParams(location.search);
  if(q.get('dni') && $('#i_dni')) $('#i_dni').value=q.get('dni');
  if(q.get('sexo') && $('#i_sexo')) $('#i_sexo').value=q.get('sexo').toUpperCase();
  if(q.get('fi') && $('#i_fi')) $('#i_fi').value=q.get('fi');
})();

/* ===== Boot ===== */
window.addEventListener('DOMContentLoaded', () => {
  try {
    applyLogo(); boxSet(boxGet()); wireTabs();

    const safe = (fn)=>{ try{ fn(); }catch(e){ console.warn(e);} };
    safe(()=>loadDraft(DRAFT_ING,['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs']));
    safe(()=>loadDraft(DRAFT_ALTA,['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs']));
    if ($('#i_fi') && !$('#i_fi').value) $('#i_fi').value=nowDate();
    if ($('#i_hi') && !$('#i_hi').value) $('#i_hi').value=nowTime();

    if (navigator.serviceWorker) {
      navigator.serviceWorker.addEventListener('message', (ev) => {
        if (ev.data?.type === 'SW_ACTIVATED') {
          toast('Nueva versión disponible. Recargando…', 1800);
          setTimeout(()=>location.reload(), 1500);
        }
      });
    }
  } catch (e) {
    console.error('Boot error', e);
    toast('Error inicializando la app', 3000);
  }
});
  <script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzPlCb70mBDtlZYq-8FFzf8kXXwqRIMusEYpd4fo0gdyEItPY8CLLfPzdlcqIKFZxY6DQ/exec';        // /exec del deployment
const API_KEY = 'HSM2025KEY';              // la misma de Script Properties

// ---------- Helpers ----------
const $ = (s,root=document) => root.querySelector(s);
const $$= (s,root=document) => [...root.querySelectorAll(s)];
const normStr  = v => (v==null?'':String(v).trim());
const onlyDigits = v => normStr(v).replace(/\D/g,'');
const normDate = v => {                    // espera yyyy-mm-dd (input date)
  v = normStr(v);
  // acepta también dd/mm/yyyy del teclado
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) {
    const [d,m,y] = v.split('/'); return `${y}-${m}-${d}`;
  }
  return v; // ya viene yyyy-mm-dd
};
const normTime = v => {                    // hh:mm ó hh:mm:ss
  v = normStr(v);
  if (!v) return '';
  const m = v.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if (!m) return '';
  const hh = String(Math.min(23,parseInt(m[1],10))).padStart(2,'0');
  const mm = String(Math.min(59,parseInt(m[2],10))).padStart(2,'0');
  const ss = String(Math.min(59,parseInt(m[3]||'0',10))).padStart(2,'0');
  return `${hh}:${mm}`;                    // la hoja usa hh:mm
};
function disable(el, on){ if (!el) return; on? el.setAttribute('disabled',''): el.removeAttribute('disabled'); }
function toast(msg){ console.log('[HSM]', msg); } // reemplazá por snackbar visual

// Llamada genérica SIN preflight
async function api(action, payload={}) {
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },  // <- clave para evitar preflight
    body: JSON.stringify({ action, apiKey: API_KEY, payload })
  });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return { ok:false, code:'E_PARSE', message:txt }; }
}

// ---------- Lectores de formulario ----------
function leerFormularioIngreso(){
  const f = $('#frmIngreso');
  // mapeo 1:1 con headers RAW (los que usa el core)
  const out = {
    DNI:                 onlyDigits($('[name="DNI"]',f)?.value),
    FechaIngresoManual:  normDate($('[name="FechaIngresoManual"]',f)?.value),
    HoraIngresoManual:   normTime($('[name="HoraIngresoManual"]',f)?.value),
    Sexo:                normStr($('[name="Sexo"]',f)?.value).toUpperCase(),
    IdeacionIntento:     normStr($('[name="IdeacionIntento"]',f)?.value),
    MetodoLetalidad:     normStr($('[name="MetodoLetalidad"]',f)?.value),
    Consumo:             normStr($('[name="Consumo"]',f)?.value),
    TipoSustancia:       normStr($('[name="TipoSustancia"]',f)?.value),
    Frecuencia:          normStr($('[name="Frecuencia"]',f)?.value),
    DxProvisorio_CIE10:  normStr($('[name="DxProvisorio_CIE10"]',f)?.value).toUpperCase(),
    Observaciones:       normStr($('[name="Observaciones"]',f)?.value),
    RedApoyo:            normStr($('[name="RedApoyo"]',f)?.value),
    PacienteUID:         normStr($('[name="PacienteUID"]',f)?.value),
    IngresoID:           normStr($('[name="IngresoID"]',f)?.value),
    // adicionales opcionales (geo/firma/cliente)
    Geo_Lat:      normStr($('[name="Geo_Lat"]',f)?.value),
    Geo_Lon:      normStr($('[name="Geo_Lon"]',f)?.value),
    Geo_Acc:      normStr($('[name="Geo_Acc"]',f)?.value),
    Geo_Ts:       normStr($('[name="Geo_Ts"]',f)?.value),
    FirmaURL:     normStr($('[name="FirmaURL"]',f)?.value),
    ClientGUID:   normStr(localStorage.getItem('hsm.client') || ''),
    ForceDuplicate: false
  };
  // validaciones mínimas
  if(!out.DNI) throw new Error('Ingresá un DNI válido.');
  if(!out.FechaIngresoManual) throw new Error('Falta fecha de ingreso.');
  if(!out.HoraIngresoManual) throw new Error('Falta hora de ingreso.');
  return out;
}

function leerFormularioAlta(){
  const f = $('#frmAlta');
  const out = {
    DNI:               onlyDigits($('[name="DNI"]',f)?.value),
    Sexo:              normStr($('#sexo')?.value || '' ).toUpperCase(), // si querés cargar el mismo select
    FechaAltaManual:   normDate($('[name="FechaAltaManual"]',f)?.value),
    HoraAltaManual:    normTime($('[name="HoraAltaManual"]',f)?.value),
    EstadoEgreso:      normStr($('[name="EstadoEgreso"]',f)?.value) || 'Alta',
    Observaciones:     normStr($('[name="Observaciones"]',f)?.value),
    ForceDuplicate:    false
  };
  if(!out.DNI) throw new Error('DNI requerido para el alta.');
  if(!out.FechaAltaManual) throw new Error('Falta fecha de alta.');
  if(!out.HoraAltaManual) throw new Error('Falta hora de alta.');
  return out;
}

// ---------- Acciones ----------
async function guardarIngreso(){
  const btn = $('#btnGuardar'); disable(btn,true);
  try{
    const payload = leerFormularioIngreso();
    const r = await api('save', payload);
    if (!r.ok) throw new Error(r.message || r.code || 'Error al guardar');
    toast('Ingreso guardado ✔');
    // opcional: limpiar campos o marcar éxito visual
  }catch(e){ toast(e.message || e); }
  finally{ disable(btn,false); }
}

async function guardarAlta(){
  const btn = $('#btnAlta'); disable(btn,true);
  try{
    const payload = leerFormularioAlta();
    const r = await api('alta', payload);
    if (!r.ok) throw new Error(r.message || r.code || 'Error al registrar alta');
    toast('Alta registrada ✔');
  }catch(e){ toast(e.message || e); }
  finally{ disable(btn,false); }
}

// ---------- Extras útiles ----------
async function buscarPorDNI(dni){
  dni = onlyDigits(dni);
  if (dni.length < 7) return;
  const r = await api('findbydni', { dni, days: 120 });
  if (r?.ok && r.found) {
    if (r.sexo) $('#sexo').value = r.sexo;
    // acá podrías autocompletar más cosas si quisieras
  }
}
$('#dni')?.addEventListener('blur', e => buscarPorDNI(e.target.value));

// Autocomplete Dx (si querés)
async function cargarCIE10(){
  const r = await api('cie10');
  if (!r?.ok) return;
  const list = r.list || [];
  // ejemplo ultra simple: al perder foco normaliza código
  $('#dx')?.addEventListener('blur', ()=>{
    const v = $('#dx').value.toUpperCase();
    const hit = list.find(x => x.code === v);
    if (!hit && /^[A-Z]\d{2}/.test(v)) $('#dx').value = v; // deja el código igual
  });
}

// Arranque: ping + config + CIE10
window.addEventListener('load', async ()=>{
  console.log('PING', await api('ping'));
  console.log('CONFIG', await api('config'));
  cargarCIE10();
});
</script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/panel-html-msm/sw.js', {
      scope: '/panel-html-msm/'
    }).catch(console.error);

    // (tu listener existente puede quedar igual)
    navigator.serviceWorker.addEventListener('message', (ev) => {
      if (ev.data?.type === 'SW_ACTIVATED') {
        toast('Nueva versión disponible. Recargando…', 1800);
        setTimeout(() => location.reload(), 1500);
      }
    });
  }
</script>
<!-- Manifest y color del tema -->
<link rel="manifest" href="/panel-html-msm/manifest.json">
<meta name="theme-color" content="#0b1220">

<script>
  // Registrar el service worker con scope del subpath
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/panel-html-msm/sw.js', {
      scope: '/panel-html-msm/'
    }).catch(console.error);
  }

  // (opcional) escuchar mensaje de versión nueva
  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('message', (ev) => {
      if (ev.data?.type === 'SW_ACTIVATED') {
        // tu toast + recarga suave
        setTimeout(() => location.reload(), 1500);
      }
    });
  }
</script>

</body>
</html>



