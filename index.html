<!doctype html>
<html lang="es" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="HSM v7 ‚Ä¢ M√≥vil ‚Äî Ingreso y alta r√°pida con soporte offline y cola de pendientes." />
  <title>HSM v7 ‚Ä¢ M√≥vil</title>

  <!-- Manifest DEV (rutas relativas). En producci√≥n us√° /panel-html-msm/manifest.json -->
  <link rel="manifest" href="./manifest.dev.json">

  <!-- Favicons -->
  <link rel="icon" href="./icons/favicon-32.png" type="image/png" sizes="32x32">
  <link rel="icon" href="./icons/favicon-16.png" type="image/png" sizes="16x16">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" sizes="180x180" />

  <style>
    /* ====== Tema / Dise√±o =================================================== */
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --mut:#94a3b8;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --acc:#60a5fa;
      --field:#0b1329; --bd:#1f2a44; --chip:#1f2937;
      --shadow:0 10px 38px rgba(0,0,0,.45); --focus:0 0 0 2px rgba(59,130,246,.35);
      --ring: 0 0 0 8px rgba(96,165,250,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;contain:content}

    /* ====== Header App ====================================================== */
    header.app{display:grid;grid-template-columns:44px 12px 1fr 78px 1fr 96px 48px;align-items:center;
               padding:10px 12px;border-bottom:1px solid var(--bd);min-height:64px;position:sticky;top:0;background:var(--card);z-index:10}
    .title{font-weight:800;letter-spacing:.3px;margin:0;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #logo{grid-column:1;height:44px;width:44px;object-fit:cover;border-radius:8px;transform:scale(.96);opacity:0;transition:opacity .35s ease, transform .35s ease}
    #logo.loaded{opacity:1;transform:scale(1)}
    #online{grid-column:4;min-width:78px;justify-content:center}.sp{grid-column:5}
    #btnInstall{grid-column:6;width:96px;text-align:center;visibility:hidden;opacity:0;transition:opacity .2s, transform .2s;transform:translateY(-2px)}
    #btnInstall.shown{visibility:visible;opacity:1;transform:translateY(0)}
    #btnCfg{grid-column:7;width:48px;text-align:center}

    /* ====== B√°sicos ========================================================= */
    .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;font-size:12px;background:rgba(148,163,184,.12);color:#cbd5e1;border:1px solid var(--bd)}
    .badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
    .badge.off{background:rgba(148,163,184,.12);color:#94a3b8}

    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--acc);color:#04121f}
    .btn.sec{background:#1f2937;color:#d1d5db}.btn.ghost{background:transparent;border:1px solid var(--bd);color:#cbd5e1}
    .btn:active{transform:translateY(1px)} .btn:focus-visible{box-shadow:var(--focus)}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:740px){.row{grid-template-columns:1fr}}

    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    input,select,textarea{width:100%;background:var(--field);color:var(--ink);border:1px solid var(--bd);border-radius:12px;padding:11px 12px;outline:none;transition:box-shadow .2s,border-color .2s}
    input:focus,select:focus,textarea:focus{border-color:#3b82f6;box-shadow:var(--focus)}
    textarea{min-height:90px;resize:vertical}
    .kv{display:flex;gap:8px;align-items:center}.kv input{flex:1}

    nav.tabs{display:flex;gap:8px;border-bottom:1px solid var(--bd);padding:10px 10px 0}
    .tab{padding:10px 14px;border-radius:10px 10px 0 0;background:#111a2c;border:1px solid var(--bd);border-bottom:0;color:#cbd5e1;cursor:pointer;font-weight:700;text-decoration:none;-webkit-tap-highlight-color:transparent;transition:background .2s, transform .2s}
    .tab:hover{background:#0f1a2d;transform:translateY(-1px)}
    .tab[aria-selected="true"]{background:var(--card);color:#fff}

    section.view{padding:12px;content-visibility:auto;contain-intrinsic-size:800px 1200px}
    .list{border:1px solid var(--bd);border-radius:12px;overflow:hidden}.item{display:flex;gap:12px;padding:10px 12px;border-bottom:1px solid var(--bd);align-items:center}.item:last-child{border-bottom:0}

    .chips{display:flex;flex-wrap:wrap;gap:8px}.chip{background:var(--chip);border:1px solid var(--bd);color:#d1d5db;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .small{font-size:12px;color:#94a3b8}.mut{color:#94a3b8}.ok{color:#86efac}.err{color:#fca5a5}
    hr{border:0;border-top:1px solid var(--bd);margin:14px 0}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,23,42,.96);color:#e5e7eb;border:1px solid var(--bd);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;display:none}
    .footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;color:#a8b3c7;font-size:12px;border-top:1px solid var(--bd);background:#0f172a}

    dialog#cfg{border:1px solid var(--bd);border-radius:16px;background:#0f172a;color:#e5e7eb;max-width:560px;width:92%}
    dialog::backdrop{background:rgba(2,6,23,.55)}
    :focus-visible{outline:2px solid #60a5fa;outline-offset:2px}

    /* ====== Micro-motions =================================================== */
    @keyframes pop { from{transform:scale(.98);opacity:0} to{transform:scale(1);opacity:1} }
    .card{animation:pop .25s ease}
    .tab{will-change:transform}

    /* ====== Vistas por :target (fallback sin JS) ============================ */
    .view{display:none}
    :root:has(:target#ing)  #v-ing,
    :root:has(:target#alta) #v-alta,
    :root:has(:target#pend) #v-pend,
    :root:has(:target#util) #v-util{display:block}
  </style>
</head>
<body>
  <noscript>
    <div class="wrap">
      <div class="card" style="padding:12px;margin-top:12px">Se requiere JavaScript para usar esta aplicaci√≥n.</div>
    </div>
  </noscript>

  <a class="visually-hidden" href="#main" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Saltar al contenido</a>

  <main id="main" class="wrap" role="main">
    <article class="card" aria-label="Aplicaci√≥n HSM v7 M√≥vil">
      <header class="app">
        <img id="logo" alt="Logo de la instituci√≥n" src="./icons/icon-512.png" width="44" height="44" decoding="async" fetchpriority="high">
        <div></div>
        <h1 class="title">HSM v7 ‚Ä¢ M√≥vil</h1>
        <span id="online" class="badge off" aria-live="polite" title="Estado de red">Offline</span>
        <span class="sp"></span>
        <button id="btnInstall" class="btn sec" type="button">Instalar</button>
        <button id="btnCfg" class="btn sec" aria-haspopup="dialog" aria-controls="cfg" title="Configuraci√≥n" type="button">‚öôÔ∏è</button>
      </header>

      <nav class="tabs">
        <a class="tab" id="t-ing"  href="#ing"  aria-selected="true">Ingreso</a>
        <a class="tab" id="t-alta" href="#alta">Alta</a>
        <a class="tab" id="t-pend" href="#pend">Pendientes</a>
        <a class="tab" id="t-util" href="#util">√ötiles</a>
      </nav>

      <!-- ================== INGRESO ================== -->
      <section id="v-ing" class="view">
        <form id="fIng" autocomplete="off">
          <div class="row">
            <div>
              <label for="dni">DNI</label>
              <input id="dni" name="dni" inputmode="numeric" pattern="[0-9]{7,9}" placeholder="7‚Äì9 d√≠gitos">
            </div>
            <div>
              <label for="sexo">Sexo</label>
              <select id="sexo" name="sexo">
                <option value="">‚Äî</option>
                <option>Femenino</option>
                <option>Masculino</option>
                <option>Otro / X</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="fi">Fecha ingreso</label>
              <input id="fi" name="fi" type="text" placeholder="dd/mm/aaaa" inputmode="numeric">
            </div>
            <div>
              <label for="hi">Hora ingreso</label>
              <div class="kv">
                <input id="hi" name="hi" type="text" placeholder="--:--" inputmode="numeric">
                <button class="btn sec" type="button" id="btnNowI">Ahora</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="ide">Ideaci√≥n / Intento</label>
              <select id="ide" name="ide">
                <option value="">‚Äî</option>
                <option>Ideaci√≥n</option>
                <option>Intento</option>
              </select>
            </div>
            <div>
              <label for="met">M√©todo / Letalidad</label>
              <select id="met" name="met">
                <option value="">‚Äî</option>
                <option>Intoxicaci√≥n</option>
                <option>Ahorcamiento</option>
                <option>Corte</option>
                <option>Otro</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="cons">Consumo</label>
              <select id="cons" name="cons">
                <option value="">‚Äî</option>
                <option>Sin consumo</option>
                <option>Alcohol</option>
                <option>Sustancias</option>
              </select>
            </div>
            <div>
              <label for="tsus">Tipo Sustancia</label>
              <input id="tsus" name="tsus" placeholder="Ej. coca√≠na / cannabis / mix">
            </div>
          </div>

          <div>
            <label for="dx">Dx CIE-10 (c√≥digo)</label>
            <input id="dx" name="dx" placeholder="Ej: F32.1">
          </div>

          <div>
            <label for="obs">Observaciones</label>
            <textarea id="obs" name="obs" placeholder="Notas breves (opcional)"></textarea>
          </div>

          <div class="chips" style="margin:10px 0">
            <button class="chip" type="button" data-tag="Obs. SP">Obs. SP</button>
            <button class="chip" type="button" data-tag="Red apoyo ‚úì">Red apoyo ‚úì</button>
            <button class="chip" type="button" data-tag="Niega consumo">Niega consumo</button>
            <button class="chip" type="button" data-tag="Acompa√±ante">Acompa√±ante</button>
          </div>

          <div class="row" style="align-items:center">
            <button class="btn"  type="submit" id="btnSaveI">Guardar ingreso</button>
            <button class="btn sec" type="button" id="btnShareI">Compartir comprobante</button>
          </div>

          <p class="small" style="margin-top:10px">
            Tip: admite <code>?dni=&amp;sexo=&amp;fi=YYYY-MM-DD</code> para prellenar.
          </p>
        </form>
      </section>

      <!-- ================== ALTA ================== -->
      <section id="v-alta" class="view">
        <form id="fAlta" autocomplete="off">
          <div class="row">
            <div>
              <label for="dniA">DNI</label>
              <input id="dniA" name="dni" inputmode="numeric" placeholder="7‚Äì9 d√≠gitos">
            </div>
            <div>
              <label for="fnacA">Fecha Nac. (opcional)</label>
              <input id="fnacA" name="fnac" type="text" placeholder="dd/mm/aaaa" inputmode="numeric">
            </div>
          </div>

          <div class="row">
            <div>
              <label for="sexoA">Sexo</label>
              <select id="sexoA" name="sexo">
                <option value="">‚Äî</option>
                <option>Femenino</option>
                <option>Masculino</option>
                <option>Otro / X</option>
              </select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn sec" type="button" id="btnBuscarIngreso">Buscar por DNI</button>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="fa">Fecha alta</label>
              <input id="fa" name="fa" type="text" placeholder="dd/mm/aaaa" inputmode="numeric">
            </div>
            <div>
              <label for="ha">Hora alta</label>
              <div class="kv">
                <input id="ha" name="ha" type="text" placeholder="--:--" inputmode="numeric">
                <button class="btn sec" type="button" id="btnNowA">Ahora</button>
              </div>
            </div>
          </div>

          <div>
            <label for="estadoA">Estado</label>
            <select id="estadoA" name="estado">
              <option>Alta</option>
              <option>Interconsulta</option>
              <option>Derivaci√≥n</option>
              <option>Otros</option>
            </select>
          </div>

          <div>
            <label for="obsA">Observaciones</label>
            <textarea id="obsA" name="obs" placeholder="Breve detalle (opcional)"></textarea>
          </div>

          <div class="row" style="align-items:center">
            <button class="btn"  type="submit" id="btnSaveA">Guardar alta</button>
            <button class="btn sec" type="button" id="btnShareA">Compartir comprobante</button>
          </div>
        </form>
      </section>

      <!-- ================== PENDIENTES ================== -->
      <section id="v-pend" class="view">
        <div class="list" id="pendList" aria-live="polite"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnSendAll" type="button">Enviar pendientes</button>
          <div class="kv">
            <button class="btn sec" id="btnExport" type="button">Exportar JSON</button>
            <button class="btn ghost" id="btnImport" type="button">Importar JSON</button>
            <span class="small" id="pendCount">0</span>
          </div>
        </div>
      </section>

      <!-- ================== √öTILES ================== -->
      <section id="v-util" class="view">
        <div class="row">
          <div class="card" style="padding:12px">
            <h3 style="margin:0 0 8px">Esc√°ner r√°pido (DNI)</h3>
            <p class="small">Us√° la c√°mara/teclado del celular para pegar/teclear DNI y validar.</p>
            <div class="kv">
              <input id="scanDni" placeholder="DNI">
              <button class="btn sec" id="btnValidar" type="button">Validar</button>
            </div>
          </div>
          <div class="card" style="padding:12px">
            <h3 style="margin:0 0 8px">Atajos</h3>
            <div class="chips">
              <a class="chip" href="#ing">Ir a Ingreso</a>
              <a class="chip" href="#alta">Ir a Alta</a>
              <a class="chip" href="#pend">Ver Pendientes</a>
            </div>
            <p class="small" style="margin-top:10px">Versi√≥n app: v7-m√≥vil</p>
          </div>
        </div>
      </section>

      <footer class="footer">
        ‚ÄúSembrando esperanza, cultivando bienestar‚Äù ¬∑ Desarrollado por Lic. Domingo Alarc√≥n ¬∑ HSM v7
      </footer>
    </article>
  </main>

  <!-- Config / Toast -->
  <dialog id="cfg" aria-labelledby="cfg-title">
    <form method="dialog" style="padding:14px">
      <h3 id="cfg-title" style="margin:0 0 10px">Configuraci√≥n</h3>
      <label for="cfg_url">WebApp URL (/exec)</label>
      <input id="cfg_url" placeholder="https://script.google.com/macros/s/.../exec" inputmode="url">
      <label for="cfg_key">API Key</label>
      <input id="cfg_key" placeholder="Si est√° activa">
      <label for="cfg_logo">Logo URL (png/jpg/svg)</label>
      <input id="cfg_logo" placeholder="https://.../logo.png" inputmode="url">
      <div class="kv" style="margin-top:10px;gap:8px">
        <button class="btn sec" id="cfgTest" type="button">Probar</button>
        <button class="btn">Guardar</button>
      </div>
      <div id="cfgMsg" class="small" style="margin-top:8px" aria-live="polite"></div>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
  // ========= Utilitarios =========
  const qs = s => document.querySelector(s);
  const qsa = s => [...document.querySelectorAll(s)];
  const store = {
    get k(){ return 'hsmv7_cfg' },
    get p(){ return 'hsmv7_pending' },
    read(){ try{ return JSON.parse(localStorage.getItem(this.k) || '{}') }catch{return {}} },
    save(v){ localStorage.setItem(this.k, JSON.stringify(v||{})) },
    pend(){ try{ return JSON.parse(localStorage.getItem(this.p)||'[]') }catch{return []} },
    setPend(arr){ localStorage.setItem(this.p, JSON.stringify(arr||[])) }
  }
  const fmtDate = d => d.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
  const fmtTime = d => d.toTimeString().slice(0,5);
  const toast = (msg, ms=2200)=>{ const el=qs('#toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', ms) }

  // ========= Estado Online/Offline =========
  const onlineBadge = () => {
    const on = navigator.onLine;
    const el = qs('#online');
    el.className = 'badge ' + (on ? 'ok' : 'off');
    el.textContent = on ? 'Online' : 'Offline';
  };
  window.addEventListener('online', onlineBadge);
  window.addEventListener('offline', onlineBadge);

  // ========= Tabs accesibles =========
  const syncTabs = () => {
    const h = location.hash || '#ing';
    const map = { '#ing':'t-ing', '#alta':'t-alta', '#pend':'t-pend', '#util':'t-util' };
    Object.values(map).forEach(id=>qs('#'+id).setAttribute('aria-selected','false'));
    (qs('#'+(map[h]||'t-ing'))).setAttribute('aria-selected','true');
    // Fallback si no hay :has() -> mostrar vista seleccionada
    qsa('.view').forEach(v=>v.style.display='none');
    qs('#v-'+h.replace('#','')).style.display='block';
  };
  window.addEventListener('hashchange', syncTabs);

  // ========= Logo load micro-motion =========
  qs('#logo').addEventListener('load',e=>e.target.classList.add('loaded'));

  // ========= Configuraci√≥n =========
  const cfg = store.read();
  const dlg = qs('#cfg');
  qs('#btnCfg').onclick = ()=> {
    qs('#cfg_url').value = cfg.url || '';
    qs('#cfg_key').value = cfg.key || '';
    qs('#cfg_logo').value= cfg.logo|| '';
    dlg.showModal();
  };
  dlg.addEventListener('close', ()=>{
    const n = {
      url: qs('#cfg_url').value.trim(),
      key: qs('#cfg_key').value.trim(),
      logo:qs('#cfg_logo').value.trim()
    };
    store.save(n);
    if(n.logo){ qs('#logo').src = n.logo }
  });
  qs('#cfgTest').onclick = async ()=>{
    const url = qs('#cfg_url').value.trim();
    if(!url) return toast('Ingres√° la URL /exec');
    try{
      const r = await fetch(url,{method:'OPTIONS',mode:'no-cors'}); // ping suave
      qs('#cfgMsg').textContent = 'Ping enviado (ver consola del GAS si corresponde).';
    }catch(e){ qs('#cfgMsg').textContent = 'No se pudo contactar. Revis√° la URL.' }
  };

  // ========= Helpers de formulario =========
  qs('#btnNowI').onclick = ()=>{ const d=new Date(); qs('#fi').value=fmtDate(d); qs('#hi').value=fmtTime(d) };
  qs('#btnNowA').onclick = ()=>{ const d=new Date(); qs('#fa').value=fmtDate(d); qs('#ha').value=fmtTime(d) };
  qsa('.chip').forEach(b=> b.onclick = ()=> {
    const t = qs('#obs');
    t.value = (t.value ? (t.value.trim() + ' ¬∑ ') : '') + b.dataset.tag;
    t.focus();
  });

  // ========= Queue / Pendientes =========
  function renderPend(){
    const list = qs('#pendList');
    const arr = store.pend();
    qs('#pendCount').textContent = arr.length;
    if(!arr.length){ list.innerHTML = '<div class="item"><span class="small">No hay pendientes</span></div>'; return }
    list.innerHTML = arr.map((x,i)=>`
      <div class="item">
        <div class="small" style="min-width:70px">${x.tipo||'?'}</div>
        <div style="flex:1">
          <div><strong>DNI:</strong> ${x.data?.dni||x.data?.dniA||'-'} ¬∑ <strong>Fecha:</strong> ${x.data?.fi||x.data?.fa||'-'}</div>
          <div class="small mut">${x.data?.obs||x.data?.obsA||''}</div>
        </div>
        <button class="btn ghost" data-del="${i}" type="button">üóë</button>
      </div>`).join('');
    qsa('[data-del]').forEach(b=> b.onclick = ()=>{
      const idx = +b.dataset.del;
      const arr = store.pend(); arr.splice(idx,1); store.setPend(arr); renderPend(); toast('Pendiente eliminado')
    });
  }

  // ========= Env√≠o (mock a GAS) =========
  async function sendToApi(payload){
    const c = store.read();
    if(!c.url){ throw new Error('Config: falta URL de GAS') }
    const r = await fetch(c.url, {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key': (c.key||'')},
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json().catch(()=>({ok:true}));
  }

  async function flushQueue(){
    const arr = store.pend();
    if(!arr.length) return toast('No hay pendientes');
    if(!navigator.onLine) return toast('Sin conexi√≥n. Intentalo luego.');
    let ok=0, fail=0;
    for(const item of arr.slice()){
      try{ await sendToApi(item); ok++; arr.shift(); }
      catch{ fail++; break; } // corta en el primero fallido para no quemar rate
    }
    store.setPend(arr); renderPend();
    toast(`Enviados: ${ok} ¬∑ Restantes: ${arr.length}${fail? ' ¬∑ Error en env√≠o':''}`);
  }

  // ========= Formularios: guardar =========
  qs('#fIng').addEventListener('submit', e=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    data.fi ||= fmtDate(new Date()); data.hi ||= fmtTime(new Date());
    const item = {tipo:'ING', ts: Date.now(), data};
    const q = store.pend(); q.push(item); store.setPend(q);
    renderPend(); toast('Ingreso guardado en pendientes');
    if(navigator.share){ qs('#btnShareI').onclick = ()=> navigator.share({title:'Ingreso HSM', text:`DNI ${data.dni} ¬∑ ${data.fi} ${data.hi}`}).catch(()=>{}) }
  });

  qs('#fAlta').addEventListener('submit', e=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    data.fa ||= fmtDate(new Date()); data.ha ||= fmtTime(new Date());
    const item = {tipo:'ALTA', ts: Date.now(), data};
    const q = store.pend(); q.push(item); store.setPend(q);
    renderPend(); toast('Alta guardada en pendientes');
    if(navigator.share){ qs('#btnShareA').onclick = ()=> navigator.share({title:'Alta HSM', text:`DNI ${data.dni} ¬∑ ${data.fa} ${data.ha}`}).catch(()=>{}) }
  });

  // ========= Acciones varias =========
  qs('#btnSendAll').onclick = flushQueue;
  qs('#btnExport').onclick = ()=>{
    const blob = new Blob([localStorage.getItem(store.p) || '[]'], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pendientes-hsmv7.json'; a.click();
  };
  qs('#btnImport').onclick = async ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = async ()=>{
      const txt = await inp.files[0].text();
      try{ const data = JSON.parse(txt); if(!Array.isArray(data)) throw 0;
        const cur = store.pend(); store.setPend(cur.concat(data)); renderPend(); toast('Importado ‚úì')
      }catch{ toast('Archivo inv√°lido') }
    };
    inp.click();
  };
  qs('#btnValidar').onclick = ()=> {
    const v = qs('#scanDni').value.trim();
    toast((/^\d{7,9}$/.test(v)) ? 'DNI v√°lido' : 'DNI inv√°lido');
  };
  qs('#btnBuscarIngreso').onclick = ()=> {
    const dni = qs('#dniA').value.trim(); if(!dni) return toast('Ingres√° DNI');
    const hit = store.pend().find(x=>x.tipo==='ING' && (x.data?.dni===dni));
    if(hit){ qs('#sexoA').value = hit.data?.sexo || ''; toast('Ingreso en pendientes encontrado') } else { toast('Sin coincidencias en cola') }
  };

  // ========= Instalaci√≥n (PWA) =========
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e;
    const b = qs('#btnInstall'); b.classList.add('shown');
    b.onclick = async ()=>{ deferredPrompt?.prompt(); deferredPrompt = null; b.classList.remove('shown') };
  });

  // ========= SW registro =========
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      const scope = './'; // dev
      navigator.serviceWorker.register('./sw.js', {scope}).catch(console.error);
    });
  }

  // ========= Init =========
  (function init(){
    onlineBadge();
    syncTabs();
    // Aplicar logo desde config si existe
    const c = store.read(); if(c.logo){ qs('#logo').src = c.logo }
    // Prellenado por querystring b√°sico
    const params = new URLSearchParams(location.search);
    if(params.get('dni')) qs('#dni').value = params.get('dni');
    if(params.get('sexo')) qs('#sexo').value = params.get('sexo');
    if(params.get('fi'))   qs('#fi').value = params.get('fi').split('-').reverse().join('/');
    renderPend();
  })();
  </script>
</body>
</html>
