<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HSM v7 • Ingreso / Alta</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0e1420; --panel:#161e2e; --ink:#e9eefc; --mut:#9bb0d0;
      --ok:#2bd67b; --err:#ff7066; --brand:#7aa2ff; --line:#22304a;
      --btn:#2b3a59; --btnh:#334769; --kbd:#2a3350;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-bottom:1px solid var(--line);background:#0c1220;position:sticky;top:0;z-index:10}
    .brand{font-weight:700;color:var(--brand);letter-spacing:.3px}
    .badge{padding:4px 10px;border-radius:999px;background:#23314d}
    .badge.ok{background:#153a2a;color:#a7f3c6}
    .badge.err{background:#4a2323;color:#ffd9d6}
    .badge.mut{background:#2a344a;color:#c9d6f5}
    .container{display:grid;grid-template-columns:280px 1fr;gap:18px;max-width:1200px;margin:20px auto;padding:0 16px}
    .sidebar{position:sticky;top:64px;height:fit-content}
    .tabs{display:flex;flex-direction:column;gap:8px}
    .tab{background:var(--btn);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px;text-align:left;cursor:pointer}
    .tab[aria-selected="true"],.tab:hover{background:var(--btnh)}
    .help{margin-top:12px;padding:12px;border:1px dashed var(--line);border-radius:12px;color:var(--mut)}
    .content{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px}
    .panel{display:none}
    .panel.show{display:block}
    h2{margin:0 0 12px 0;font-size:18px;color:#dfe8ff}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{display:flex;flex-direction:column;gap:6px;font-size:14px;color:#cdddff}
    label.full{grid-column:1/-1}
    input,select,textarea{
      background:#0f1726;border:1px solid #26324c;border-radius:10px;color:var(--ink);
      padding:10px 12px;outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:#3f5ea8;box-shadow:0 0 0 3px rgba(122,162,255,.15)}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .actions{display:flex;align-items:center;gap:12px;margin-top:10px}
    .btn{background:var(--btn);border:1px solid var(--line);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{background:var(--btnh)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{min-height:1.2rem;color:var(--mut)}
    .note{font-size:.9rem;color:var(--mut)}
    .kbd{background:var(--kbd);padding:2px 6px;border-radius:6px;border:1px solid var(--line);font-family:ui-monospace,monospace}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:.85rem}
    .pill.ok{border-color:#195a3d;color:#a7f3c6;background:#10261f}
    .pill.err{border-color:#5a1919;color:#ffd9d6;background:#261010}
    .footer{max-width:1200px;margin:16px auto;padding:0 16px;color:var(--mut)}
    .inline{display:inline-flex;gap:6px;align-items:center}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width:900px){
      .container{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header class="topbar" role="banner">
  <div class="brand" aria-label="Nombre de la aplicación">HSM v7</div>
  <div class="inline" aria-live="polite" aria-atomic="true">
    <span id="epiState" class="pill" title="Estado de episodio" hidden></span>
    <span id="status" class="badge mut" title="Estado de conexión">Comprobando…</span>
  </div>
</header>

<main class="container" role="main">
  <aside class="sidebar" aria-label="Navegación">
    <nav class="tabs" role="tablist" aria-label="Secciones">
      <button class="tab" role="tab" id="tab-ing" aria-controls="panel-ing" aria-selected="true">Ingreso</button>
      <button class="tab" role="tab" id="tab-alt" aria-controls="panel-alt" aria-selected="false">Alta / Egreso</button>
    </nav>
    <section class="help" aria-live="polite">
      <p class="muted">Datos mínimos: <b>DNI</b> (7–9), <b>Sexo</b>, <b>Fecha</b> y <b>Hora</b>. Si omitís fecha/hora se toma la actual.</p>
      <p class="note">Atajos: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> guarda.</p>
    </section>
  </aside>

  <section class="content">
    <!-- ===== Ingreso ===== -->
    <form id="panel-ing" class="panel show" role="tabpanel" aria-labelledby="tab-ing" autocomplete="off">
      <h2>Ingreso</h2>
      <div class="grid">
        <label>DNI
          <div class="row">
            <input id="dni" class="grow" inputmode="numeric" pattern="\d{7,9}" placeholder="7–9 dígitos" aria-describedby="dHelp" />
            <button id="btn-find" type="button" class="btn" title="Buscar episodio por DNI">Buscar</button>
          </div>
          <small id="dHelp" class="note">Ej.: 32123456</small>
        </label>
        <label>Sexo
          <select id="sexo" aria-label="Sexo">
            <option value="">—</option><option>F</option><option>M</option><option>X</option>
          </select>
        </label>
        <label>Fecha ingreso
          <input id="fi" type="date" />
        </label>
        <label>Hora ingreso
          <input id="hi" type="time" />
        </label>
        <label>Ideación / Intento
          <select id="ii">
            <option value="">—</option><option>Ideación</option><option>Intento</option>
          </select>
        </label>
        <label>Método / Letalidad
          <input id="met" placeholder="Método" />
        </label>
        <label>Consumo
          <select id="cons">
            <option value="">—</option>
            <option>Alcohol</option><option>Psicoactivos</option><option>Mixto</option><option>Sin datos</option>
          </select>
        </label>
        <label>Tipo Sustancia
          <input id="sust" placeholder="Ej: Cocaína, BZD..." />
        </label>
        <label>Dx CIE-10 (provisorio)
          <input id="cie" list="cie10" placeholder="Ej: F10.1 Trastornos mentales..." autocomplete="off" />
          <datalist id="cie10"><option value="Cargando…"></option></datalist>
          <small class="note">Escribí código o descripción; se autocompleta desde la hoja <b>CIE10_MAP</b>.</small>
        </label>
        <label class="full">Observaciones
          <textarea id="obs" rows="3" placeholder="Notas breves…"></textarea>
        </label>
      </div>
      <div class="actions">
        <button id="submitIng" type="button" class="btn">Guardar ingreso</button>
        <span id="msgIng" class="msg" role="status" aria-live="polite"></span>
      </div>
    </form>

    <!-- ===== Alta / Egreso ===== -->
    <form id="panel-alt" class="panel" role="tabpanel" aria-labelledby="tab-alt" autocomplete="off">
      <h2>Alta / Egreso</h2>
      <div class="grid">
        <label>DNI
          <div class="row">
            <input id="dni2" class="grow" inputmode="numeric" pattern="\d{7,9}" placeholder="7–9 dígitos" />
            <button id="btn-find2" type="button" class="btn" title="Buscar episodio por DNI">Buscar</button>
          </div>
        </label>
        <label>Sexo
          <select id="sexo2">
            <option value="">—</option><option>F</option><option>M</option><option>X</option>
          </select>
        </label>
        <label>Fecha alta
          <input id="fa" type="date" />
        </label>
        <label>Hora alta
          <input id="ha" type="time" />
        </label>
        <label>Estado egreso
          <select id="estado">
            <option>Alta</option><option>Derivación</option><option>Fuga</option><option>Otro</option>
          </select>
        </label>
        <label class="full">Observaciones
          <textarea id="obs2" rows="3" placeholder="Notas…"></textarea>
        </label>
      </div>
      <div class="actions">
        <button id="submitAlta" type="button" class="btn">Guardar alta</button>
        <span id="msgAlta" class="msg" role="status" aria-live="polite"></span>
      </div>
    </form>
  </section>
</main>

<footer class="footer">
  <small>v7 • Panel HTML • GitHub Pages • <span id="coreVer">core?</span></small>
</footer>

<script>
/* ====== CONFIG ====== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyqvAkFP2tf_lT6BXNcMNJ0esY0MajUTsI91wXRItW6RGhJguR4VwdG9wUkLWf1EC7u/exec';
const API_KEY    = 'HSM2025KEY';

/* ====== HELPERS ====== */
const $ = s => document.querySelector(s);
const LS={get:(k,d=null)=>{try{return JSON.parse(localStorage.getItem(k))??d;}catch(_){return localStorage.getItem(k)??d;}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch(_){localStorage.setItem(k,v);}},del:(k)=>localStorage.removeItem(k)};
const nowDate=()=>new Date().toISOString().slice(0,10);
const nowTime=()=>new Date().toTimeString().slice(0,5);
const dniClean=v=>String(v||'').replace(/\D/g,'').slice(0,9);
const dniOK=v=>/^\d{7,9}$/.test(String(v||'').trim());
function setStatus(t,c){ const st=$('#status'); if(st){ st.textContent=t; st.className='badge '+(c||'mut'); } }
function setEpiState(open,row){
  const el=$('#epiState'); if(!el) return;
  if(open===undefined){ el.hidden=true; return; }
  el.hidden=false;
  if(open){ el.textContent='Episodio ABIERTO'; el.className='pill ok'; el.title='Hay un ingreso sin alta (fila '+(row||'?')+')'; }
  else { el.textContent='Sin episodio abierto'; el.className='pill'; el.title='Último episodio cerrado'+(row?(' (fila '+row+')'):''); }
}
function setMsg(el,t,ok=true){ if(el){ el.style.color=ok?'var(--ok)':'var(--err)'; el.textContent=t; } }
function postForm(url, params){
  const qs=new URLSearchParams(params);
  return fetch(url+(url.includes('?')?'&':'?')+'apiKey='+encodeURIComponent(API_KEY),{
    method:'POST',mode:'cors',credentials:'omit',cache:'no-cache',body:qs
  }).then(r=>r.json());
}

/* ====== API ====== */
const API={
  ping: async()=> (await fetch(WEBAPP_URL)).json(),
  saveIngreso: p => postForm(WEBAPP_URL,{
    tipo:'ing', DNI:p.DNI, Sexo:p.Sexo,
    FechaIngresoManual:p.FechaIngresoManual, HoraIngresoManual:p.HoraIngresoManual,
    IdeacionIntento:p.IdeacionIntento||'', MetodoLetalidad:p.MetodoLetalidad||'',
    Consumo:p.Consumo||'', TipoSustancia:p.TipoSustancia||'', Frecuencia:p.Frecuencia||'',
    DxProvisorio_CIE10:(p.DxProvisorio_CIE10||p.DxCIE10||'').toUpperCase(),
    Observaciones:p.Observaciones||'', AppVersion:'v7-panel-html'
  }),
  saveAlta: p => postForm(WEBAPP_URL,{
    tipo:'alta', DNI:p.DNI, Sexo:p.Sexo||'',
    EstadoEgreso:p.EstadoEgreso||'Alta', FechaAltaManual:p.FechaAltaManual||'', HoraAltaManual:p.HoraAltaManual||'',
    FechaIngresoManual:p.FechaIngresoManual||'', HoraIngresoManual:p.HoraIngresoManual||'',
    Observaciones:p.Observaciones||'', AppVersion:'v7-panel-html'
  }),
  find: (dni, days=180) => postForm(WEBAPP_URL,{ action:'find', dni:String(dni||'').replace(/\D/g,''), days }),
  cie10List: async()=>{
    const cache=LS.get('CIE10_CACHE'); const ttl=LS.get('CIE10_TTL');
    const now=Date.now();
    if(cache && ttl && now<ttl) return cache; // cache 24h
    const out=await postForm(WEBAPP_URL,{ action:'cie10_list' });
    const list=(out && out.list)? out.list : [];
    LS.set('CIE10_CACHE', list); LS.set('CIE10_TTL', now+24*60*60*1000);
    return list;
  }
};
window.API=API;

/* ====== COLA OFFLINE ====== */
async function flushOutbox(key, kind){
  const box=LS.get(key,[]); if(!box.length) return;
  const remain=[]; for(const it of box){
    const now=Date.now(); if(it.retryAt && now<it.retryAt){ remain.push(it); continue; }
    try{ const out=(kind==='ing')? await API.saveIngreso(it.payload) : await API.saveAlta(it.payload);
         if(!(out&&out.ok)) throw new Error(out&&out.message||'ERR'); }
    catch(e){ it.retries=(it.retries||0)+1; it.retryAt=now+Math.min(60000,2000*Math.pow(2,it.retries)); remain.push(it); }
  }
  LS.set(key,remain);
}
setInterval(()=>{ flushOutbox('HSM_OUT_ING','ing'); flushOutbox('HSM_OUT_ALT','alt'); },15000);
addEventListener('online', ()=>setStatus('Online','ok'));
addEventListener('offline',()=>setStatus('Offline','mut'));

/* ====== UI BINDINGS ====== */
function activateTab(tabId){
  document.querySelectorAll('[role="tab"]').forEach(t=>{
    const sel=(t.id===('tab-'+tabId)); t.setAttribute('aria-selected', sel?'true':'false');
  });
  document.querySelectorAll('[role="tabpanel"]').forEach(p=>{
    p.classList.toggle('show', p.id===('panel-'+tabId));
  });
}
document.addEventListener('click', (e)=>{
  const b=e.target.closest('[role="tab"]'); if(!b) return;
  const id=b.id.replace('tab-',''); activateTab(id);
});
document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){
    if($('#panel-ing').classList.contains('show')) $('#submitIng').click();
    else $('#submitAlta').click();
  }
});

/* ====== AUTOCOMPLETE CIE10 ====== */
async function setupCIE10(){
  try{
    const list=await API.cie10List();
    const dl=$('#cie10'); if(!dl) return;
    dl.innerHTML='';
    // Sólo cargamos primeros 300 a datalist y dejamos filtro incremental
    (list||[]).slice(0,300).forEach(x=>{
      const v=(x.code?(x.code+' '):'')+(x.desc||'');
      const opt=document.createElement('option'); opt.value=v; dl.appendChild(opt);
    });
    // Filtro on-the-fly (no todos los navegadores muestran >300)
    const input=$('#cie');
    let lastQ='';
    input?.addEventListener('input', ()=>{
      const q=(input.value||'').toLowerCase();
      if(q===lastQ) return; lastQ=q;
      const best=(list||[]).filter(x=>{
        const s=((x.code||'')+' '+(x.desc||'')).toLowerCase();
        return q.length>=2 && s.includes(q);
      }).slice(0,100);
      dl.innerHTML='';
      best.forEach(x=>{
        const opt=document.createElement('option');
        opt.value=((x.code||'').toUpperCase()+' '+(x.desc||''));
        dl.appendChild(opt);
      });
    });
  }catch(_){}
}

/* ====== BUSCAR EPISODIO ====== */
async function doFind(dni, target='ing'){
  const clean=dniClean(dni);
  if(!dniOK(clean)){ setEpiState(); return {ok:false}; }
  try{
    const r=await API.find(clean, 240);
    if(r && r.ok){
      if(r.found){ setEpiState(r.abierto, r.row); }
      else{ setEpiState(false, null); }
      if(target==='alt' && !r.abierto){
        // Sugerimos pasar a Ingreso si no hay abierto
        const m=$('#msgAlta'); setMsg(m,'No hay episodio abierto para ese DNI',false);
      }
      return r;
    }
  }catch(_){}
  setEpiState(); return {ok:false};
}

/* ====== FORM INGRESO ====== */
function bindIngreso(){
  const btn=$('#submitIng'); if(!btn) return;
  $('#dni')?.addEventListener('input', e=> e.target.value=dniClean(e.target.value));
  $('#btn-find')?.addEventListener('click',()=> doFind($('#dni').value,'ing'));
  btn.addEventListener('click', async(ev)=>{
    ev.preventDefault(); const m=$('#msgIng');
    const p={
      DNI:dniClean($('#dni')?.value), Sexo:$('#sexo')?.value||'',
      FechaIngresoManual:$('#fi')?.value||'', HoraIngresoManual:$('#hi')?.value||'',
      IdeacionIntento:$('#ii')?.value||'', MetodoLetalidad:$('#met')?.value||'',
      Consumo:$('#cons')?.value||'', TipoSustancia:$('#sust')?.value||'',
      DxProvisorio_CIE10:($('#cie')?.value||'').toUpperCase(), Observaciones:$('#obs')?.value||''
    };
    if(!dniOK(p.DNI)){ setMsg(m,'DNI inválido (7–9 dígitos)',false); return; }
    if(!p.Sexo){ setMsg(m,'Seleccioná sexo',false); return; }
    if(!p.FechaIngresoManual){ $('#fi').value=nowDate(); p.FechaIngresoManual=$('#fi').value; }
    if(!p.HoraIngresoManual){  $('#hi').value=nowTime(); p.HoraIngresoManual=$('#hi').value; }
    btn.disabled=true; setMsg(m,'Guardando…',true);
    try{ const out=await API.saveIngreso(p);
         if(out&&out.ok){ setMsg(m,'Guardado ✔ (fila '+(out.row||'?')+')',true); doFind(p.DNI,'ing'); }
         else throw new Error(out&&out.message||'Error'); }
    catch(e){ const box=LS.get('HSM_OUT_ING',[]); box.push({payload:p,retries:0}); LS.set('HSM_OUT_ING',box);
              setMsg(m,'Sin red. En cola ('+box.length+')',false); }
    finally{ btn.disabled=false; }
  });
}

/* ====== FORM ALTA ====== */
function bindAlta(){
  const btn=$('#submitAlta'); if(!btn) return;
  $('#dni2')?.addEventListener('input', e=> e.target.value=dniClean(e.target.value));
  $('#btn-find2')?.addEventListener('click',()=> doFind($('#dni2').value,'alt'));
  btn.addEventListener('click', async(ev)=>{
    ev.preventDefault(); const m=$('#msgAlta');
    const p={
      DNI:dniClean($('#dni2')?.value), Sexo:$('#sexo2')?.value||'',
      FechaAltaManual:$('#fa')?.value||'', HoraAltaManual:$('#ha')?.value||'',
      EstadoEgreso:$('#estado')?.value||'Alta', Observaciones:$('#obs2')?.value||''
    };
    if(!dniOK(p.DNI)){ setMsg(m,'DNI inválido',false); return; }
    if(!p.FechaAltaManual){ $('#fa').value=nowDate(); p.FechaAltaManual=$('#fa').value; }
    if(!p.HoraAltaManual){  $('#ha').value=nowTime(); p.HoraAltaManual=$('#ha').value; }
    btn.disabled=true; setMsg(m,'Guardando alta…',true);
    try{ const out=await API.saveAlta(p);
         if(out&&out.ok){ setMsg(m,'Alta guardada ✔ (fila '+(out.row||'?')+')',true); doFind(p.DNI,'alt'); }
         else throw new Error(out&&out.message||'Error'); }
    catch(e){ const box=LS.get('HSM_OUT_ALT',[]); box.push({payload:p,retries:0}); LS.set('HSM_OUT_ALT',box);
              setMsg(m,'Sin red. En cola ('+box.length+')',false); }
    finally{ btn.disabled=false; }
  });
}

/* ====== INIT ====== */
(async function init(){
  try{
    const j=await API.ping(); setStatus('Online','ok');
    if(j&&j.version) { $('#coreVer').textContent = j.version; }
  }catch(_){ setStatus('Offline','mut'); }
  if($('#fi') && !$('#fi').value) $('#fi').value=nowDate();
  if($('#hi') && !$('#hi').value) $('#hi').value=nowTime();
  bindIngreso(); bindAlta(); setupCIE10();
  flushOutbox('HSM_OUT_ING','ing'); flushOutbox('HSM_OUT_ALT','alt');
})();
</script>
</body>
</html>
