<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HSM v7 • Ingreso / Alta</title>
  <meta name="description" content="Carga rápida de Ingresos y Altas (HSM v7) con envío directo a Google Sheets.">
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg:#0b1220; --card:#111a2b; --text:#e5e7eb; --muted:#9aa4b2; --acc:#4da3ff;
      --ok:#16a34a; --bad:#ef4444; --focus:#93c5fd;
      font-synthesis-weight:none; text-rendering:optimizeLegibility;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,'Helvetica Neue',Arial}
    .wrap{max-width:980px;margin:auto;padding:24px}
    .title{font-size:22px;font-weight:700;margin:6px 0 18px}
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab{padding:10px 14px;border-radius:10px;background:#0f172a;color:#cbd5e1;cursor:pointer;border:1px solid #1e293b}
    .tab.active{background:#1e293b;color:#fff}
    form{background:var(--card);border:1px solid #1f2a40;border-radius:16px;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr; gap:14px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #263248;background:#0b1220;color:#e5e7eb;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(147,197,253,.15)}
    .row{display:flex;gap:10px}
    .row .grow{flex:1}
    .actions{display:flex;gap:10px;margin-top:14px}
    .btn{border:0;padding:12px 16px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--acc);color:#08111f}
    .btn.secondary{background:#0f172a;color:#cbd5e1;border:1px solid #1e293b}
    .hint{font-size:12px;color:#7e8aa0;margin-top:12px}
    .toast{position:fixed;inset:auto 16px 16px auto;background:#0f172a;color:#e5e7eb;border:1px solid #1e293b;
           padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(6px);transition:.25s}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">HSM v7 • Ingreso / Alta</div>

    <div class="tabs" role="tablist" aria-label="Tipo de registro">
      <button id="tab-ingreso" class="tab active" role="tab" aria-selected="true">Ingreso</button>
      <button id="tab-alta" class="tab" role="tab" aria-selected="false">Alta / Egreso</button>
    </div>

    <form id="f" autocomplete="off" novalidate>
      <input type="hidden" id="tipo" name="tipo" value="ingreso" />

      <div class="grid">
        <div>
          <label for="dni">DNI</label>
          <input id="dni" name="dni" inputmode="numeric" pattern="[0-9]{7,9}" placeholder="7–9 dígitos" required />
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo" name="sexo">
            <option value="">—</option>
            <option>F</option><option>M</option><option>X</option>
          </select>
        </div>

        <div>
          <label for="fecha">Fecha ingreso</label>
          <input id="fecha" name="fecha" type="date" />
        </div>
        <div>
          <label for="hora">Hora ingreso</label>
          <input id="hora" name="hora" type="time" />
        </div>

        <div>
          <label for="ideacion">Ideación / Intento</label>
          <select id="ideacion" name="ideacion">
            <option value="">—</option>
            <option>Ideación</option><option>Intento</option>
            <option>Intento reciente</option>
          </select>
        </div>
        <div>
          <label for="metodo">Método / Letalidad</label>
          <select id="metodo" name="metodo">
            <option value="">—</option>
            <option>Baja</option><option>Media</option><option>Alta</option>
          </select>
        </div>

        <div>
          <label for="consumo">Consumo</label>
          <select id="consumo" name="consumo">
            <option value="">—</option>
            <option>Alcohol</option><option>Psicoactivos</option><option>No</option>
          </select>
        </div>
        <div>
          <label for="sustancia">Tipo Sustancia</label>
          <input id="sustancia" name="sustancia" placeholder="(si aplica)" />
        </div>

        <div class="row" style="grid-column:1 / -1;">
          <div class="grow">
            <label for="cie10">Dx CIE-10 (código)</label>
            <input id="cie10" name="cie10" placeholder="Ej.: F32.1" />
          </div>
        </div>

        <div style="grid-column:1 / -1;">
          <label for="obs">Observaciones</label>
          <textarea id="obs" name="obs" rows="4" placeholder="Notas breves (opcional)"></textarea>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn primary">Guardar registro</button>
        <button type="button" id="limpiar" class="btn secondary">Limpiar</button>
      </div>

      <div class="hint">Sugerencia: añade este sitio a la pantalla de inicio para modo “app”.</div>
    </form>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ← Pega aquí TU URL de Apps Script (termina en /exec)
    const API_URL = 'PEGAR_AQUI_LA_URL_DEL_WEB_APP';

    // Tabs Ingreso / Alta
    const tipo = document.querySelector('#tipo');
    const tIngreso = document.querySelector('#tab-ingreso');
    const tAlta = document.querySelector('#tab-alta');
    const setTab = (t) => {
      tipo.value = t;
      tIngreso.classList.toggle('active', t === 'ingreso');
      tAlta.classList.toggle('active', t === 'alta');
      tIngreso.setAttribute('aria-selected', t === 'ingreso');
      tAlta.setAttribute('aria-selected', t === 'alta');
    };
    tIngreso.addEventListener('click', () => setTab('ingreso'));
    tAlta.addEventListener('click', () => setTab('alta'));

    // Helpers
    const $ = sel => document.querySelector(sel);
    const toast = (msg, ok=true) => {
      const t = $('#toast'); t.textContent = msg;
      t.style.borderColor = ok ? '#1e3a8a' : '#7f1d1d';
      t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500);
    };

    // Prefill fecha/hora
    const pad = n => String(n).padStart(2,'0');
    const now = new Date();
    $('#fecha').value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
    $('#hora').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;

    // Submit → Google Sheets
    $('#f').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const body = {
        tipo: $('#tipo').value,
        dni: $('#dni').value.trim(),
        sexo: $('#sexo').value,
        fecha: $('#fecha').value,
        hora: $('#hora').value,
        ideacion: $('#ideacion').value,
        metodo: $('#metodo').value,
        consumo: $('#consumo').value,
        sustancia: $('#sustancia').value,
        cie10: $('#cie10').value.trim(),
        obs: $('#obs').value.trim()
      };

      if (!body.dni) { toast('Ingresá un DNI válido', false); return; }
      if (!API_URL || !/^https:\/\/script\.google\.com\/macros\/s\/.+\/exec$/.test(API_URL)) {
        toast('Configurá la URL de API (Apps Script)', false); return;
      }

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body),
          // OJO: no usamos 'no-cors'; dejamos que el Web App responda con CORS correcto
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'omit'
        });

        const json = await res.json().catch(()=> ({}));
        if (!res.ok || !json.ok) {
          throw new Error(json.error || `Error HTTP ${res.status}`);
        }
        toast('Registro guardado ✔');
        $('#f').reset();
        setTab(body.tipo); // mantiene la pestaña
        // repone fecha/hora actuales
        const d=new Date();
        $('#fecha').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        $('#hora').value = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch (err) {
        console.error(err);
        toast('No se pudo guardar. Revisá conexión / permisos.', false);
      }
    });

    $('#limpiar').addEventListener('click',()=>{ $('#f').reset(); setTab('ingreso'); });

    // Service worker sin interferir POST ni cross-origin
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=> {
        navigator.serviceWorker.register('./sw.js').catch(console.warn);
      });
    }
  </script>
</body>
</html>

