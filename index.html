<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HSM v7 • Ingreso / Alta</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root { --bg:#0b1220; --fg:#e5e7eb; --bd:#1f2937; --ac:#0f172a; --ok:#10b981; --err:#ef4444; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .title{font-size:20px;font-weight:700;letter-spacing:.2px;margin:8px 0 16px}
    .card{background:var(--ac);border:1px solid var(--bd);border-radius:16px;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .row{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;opacity:.9}
    input,select,textarea{background:#0d1426;color:var(--fg);border:1px solid var(--bd);border-radius:10px;padding:10px 12px;outline:none}
    textarea{min-height:90px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{background:#1f2937;border:1px solid var(--bd);color:#e5e7eb;border-radius:12px;padding:10px 14px;cursor:pointer}
    button.primary{background:#2563eb;border-color:#1d4ed8}
    .note{font-size:12px;opacity:.7;margin-top:8px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:14px;padding:10px 14px;display:none}
    .toast.ok{border-color:#059669}
    .toast.err{border-color:#b91c1c}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">HSM v7 • Ingreso / Alta</div>

    <div class="card">
      <form id="frm">
        <div class="grid">
          <div class="row">
            <label for="dni">DNI</label>
            <input id="dni" name="dni" inputmode="numeric" maxlength="10" placeholder="7–9 dígitos" required />
          </div>

          <div class="row">
            <label for="sexo">Sexo</label>
            <select id="sexo" name="sexo" required>
              <option value="">—</option>
              <option>M</option><option>F</option><option>X</option>
            </select>
          </div>

          <div class="row">
            <label for="fing">Fecha ingreso</label>
            <input id="fing" name="fing" type="date" required />
          </div>

          <div class="row">
            <label for="hing">Hora ingreso</label>
            <input id="hing" name="hing" type="time" required />
          </div>

          <div class="row">
            <label for="ideacion">Ideación / Intento</label>
            <select id="ideacion" name="ideacion">
              <option value="">—</option>
              <option>Ideación</option>
              <option>Intento</option>
            </select>
          </div>

          <div class="row">
            <label for="metodo">Método / Letalidad</label>
            <select id="metodo" name="metodo">
              <option value="">—</option>
              <option>Baja</option>
              <option>Media</option>
              <option>Alta</option>
            </select>
          </div>

          <div class="row">
            <label for="consumo">Consumo</label>
            <select id="consumo" name="consumo">
              <option value="">—</option>
              <option>Ninguno</option><option>Alcohol</option><option>Sustancias</option>
            </select>
          </div>

          <div class="row">
            <label for="sustancia">Tipo Sustancia</label>
            <input id="sustancia" name="sustancia" placeholder="(si aplica)" />
          </div>

          <div class="row">
            <label for="cie">Dx CIE-10 (código)</label>
            <input id="cie" name="cie" placeholder="Ej.: F32.1" />
          </div>

          <div class="row" style="grid-column:1/-1">
            <label for="obs">Observaciones</label>
            <textarea id="obs" name="obs" placeholder="Notas breves (opcional)"></textarea>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="btn-guardar" class="primary">Guardar ingreso</button>
          <button type="reset">Limpiar</button>
        </div>
        <div class="note">Sugerencia: añadí este sitio a la pantalla de inicio para modo “app”.</div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ========= CONFIG =========
    const BASE_PATH = '/panel-html-msm/'; // ruta de GitHub Pages
    // Pega aquí la URL /exec de tu Apps Script:
    const GS_ENDPOINT = 'https://script.google.com/macros/s/REEMPLAZA_AQUI/exec';

    // ========= HELPERS UI =========
    const $ = (s, ro=document) => ro.querySelector(s);
    function toast(msg, ok=true){
      const el = $('#toast');
      el.textContent = msg;
      el.className = 'toast ' + (ok ? 'ok' : 'err');
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(()=> el.style.display = 'none', 3000);
    }
    function formDataAsObject(form){
      const data = Object.fromEntries(new FormData(form).entries());
      // normalizamos fecha + hora a ISO local
      if (data.fing && data.hing) data.timestamp = `${data.fing}T${data.hing}`;
      return data;
    }

    // ========= API: SIN PREFLIGHT (NO CORS 405) =========
    async function apiGuardarIngreso(payload){
      // NOTA: sin headers personalizados y sin Content-Type -> simple request (sin preflight)
      const resp = await fetch(GS_ENDPOINT, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      // Apps Script suele responder texto; hacemos fallback seguro
      const txt = await resp.text();
      try { return { ok: resp.ok, data: JSON.parse(txt) }; }
      catch { return { ok: resp.ok, data: txt }; }
    }

    // ========= EVENTOS =========
    $('#btn-guardar').addEventListener('click', async () => {
      const frm = $('#frm');
      if (!frm.reportValidity()) return;

      const datos = formDataAsObject(frm);
      // puede ser útil agregar marca de cliente
      datos.client_ts = Date.now();

      try{
        const r = await apiGuardarIngreso(datos);
        if (r.ok) {
          toast('Ingreso guardado');
          // opcional: frm.reset();
        } else {
          console.error('Respuesta API', r);
          toast('Error al guardar (API)', false);
        }
      }catch(err){
        console.error(err);
        toast('Error de red', false);
      }
    });

    // ========= SW REGISTRATION =========
    (async function registerSW(){
      if (!('serviceWorker' in navigator)) return;
      try{
        const reg = await navigator.serviceWorker.register(`${BASE_PATH}sw.js`, { scope: BASE_PATH });
        // auto-actualización
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{ /* podría avisar */ });
        // escucha mensajes del SW
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if (e.data === 'sw:updated') toast('App actualizada');
        });
      }catch(e){ console.warn('SW no registrado', e); }
    })();
  </script>
</body>
</html>

