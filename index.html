<!doctype html>
<html lang="es" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="HSM v7 • Móvil — Ingreso y alta rápida con soporte offline." />
  <title>HSM v7 • Móvil</title>

  <!-- Manifest + iconos (rutas absolutas para GitHub Pages /panel-html-msm/) -->
  <link rel="manifest" href="/panel-html-msm/manifest.json">
  <link rel="icon" href="/panel-html-msm/icons/favicon.png" type="image/png" sizes="any">
  <link rel="apple-touch-icon" href="/panel-html-msm/icons/apple-touch-icon.png" sizes="180x180" />

  <!-- Preconexión (Apps Script) -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://script.googleapis.com" crossorigin>

  <!-- (Quitado el preload del icono para evitar warnings y mejorar LCP) -->

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --mut:#94a3b8;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --acc:#60a5fa;
      --field:#0b1329; --bd:#1f2a44; --chip:#1f2937; --shadow:0 8px 28px rgba(0,0,0,.35);
      --focus:0 0 0 2px rgba(59,130,246,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .card{
      background:var(--card);border:1px solid var(--bd);border-radius:16px;
      box-shadow:var(--shadow);overflow:hidden;contain:paint style;
    }
    @media (max-width:480px){
      .card{ box-shadow:0 4px 16px rgba(0,0,0,.22) } /* sombra más liviana en móvil */
    }
    header.app{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--bd)}
    .title{font-weight:800; letter-spacing:.3px}
    .sp{flex:1}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;font-size:12px;background:rgba(148,163,184,.16);color:#cbd5e1;border:1px solid var(--bd)}
    .badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
    .badge.off{background:rgba(148,163,184,.12);color:#94a3b8}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--acc);color:#04121f}
    .btn.sec{background:#1f2937;color:#d1d5db}
    .btn.ghost{background:transparent;border:1px solid var(--bd);color:#cbd5e1}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:740px){ .row{grid-template-columns:1fr} }
    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    input,select,textarea{
      width:100%; background:var(--field); color:var(--ink);
      border:1px solid var(--bd); border-radius:12px; padding:11px 12px; outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#3b82f6; box-shadow:var(--focus)}
    textarea{min-height:90px;resize:vertical}
    nav.tabs{display:flex;gap:6px;border-bottom:1px solid var(--bd);padding:10px 10px 0}
    .tab{padding:8px 12px;border-radius:9px 9px 0 0;background:#111a2c;border:1px solid var(--bd);border-bottom:0;color:#cbd5e1;cursor:pointer;font-weight:700}
    .tab[aria-selected="true"]{background:var(--card);color:#fff}
    section.view{
      padding:12px;
      content-visibility:auto;
      contain:content;                  /* evita reflows fuera del tab activo */
      contain-intrinsic-size:800px 1200px;
    }
    .kv{display:flex; gap:8px; align-items:center}
    .kv input{flex:1}
    .st{margin-top:10px;font-size:13px}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .mut{color:#94a3b8}
    .logo{height:44px; width:auto; object-fit:contain; border-radius:8px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:var(--chip); border:1px solid var(--bd); color:#d1d5db; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer}
    .list{border:1px solid var(--bd); border-radius:12px; overflow:hidden}
    .item{display:flex;gap:12px; padding:10px 12px; border-bottom:1px solid var(--bd); align-items:center}
    .item:last-child{border-bottom:0}
    .small{font-size:12px;color:var(--mut)}
    hr{border:0;border-top:1px solid var(--bd); margin:14px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,23,42,.96);color:#e5e7eb;border:1px solid var(--bd);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;display:none}
    dialog#cfg{border:1px solid var(--bd);border-radius:16px;background:#0f172a;color:#e5e7eb;max-width:560px;width:92%}
    dialog::backdrop{background:rgba(2,6,23,.55)}
    :focus-visible{outline:2px solid #60a5fa; outline-offset: 2px}
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
    }
  </style>
</head>

<body>
  <a class="visually-hidden" href="#main" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">
    Saltar al contenido
  </a>

  <main id="main" class="wrap" role="main">
    <article class="card" aria-label="Aplicación HSM v7 Móvil">
      <header class="app">
        <img id="logo" class="logo" alt="Logo de la institución" src="" hidden>
        <h1 class="title" style="margin:0;font-size:16px">HSM v7 • Móvil</h1>
        <span id="online" class="badge off" aria-live="polite" title="Estado de red">Offline</span>
        <span class="sp"></span>
        <button id="btnInstall" class="btn sec" style="display:none">Instalar</button>
        <button id="btnCfg" class="btn sec" aria-haspopup="dialog" aria-controls="cfg">⚙️</button>
      </header>

      <!-- NAV TABS -->
      <nav class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab" role="tab" aria-controls="v-ing"   aria-selected="true"  data-v="ing">Ingreso</button>
        <button class="tab" role="tab" aria-controls="v-alta"  aria-selected="false" data-v="alta">Alta</button>
        <button class="tab" role="tab" aria-controls="v-pend"  aria-selected="false" data-v="pend">Pendientes</button>
        <button class="tab" role="tab" aria-controls="v-util"  aria-selected="false" data-v="util">Útiles</button>
      </nav>

      <!-- INGRESO -->
      <section id="v-ing" class="view" role="tabpanel" aria-labelledby="tab-ing">
        <div class="row">
          <div>
            <label for="i_dni">DNI</label>
            <div class="kv">
              <input id="i_dni" name="DNI" type="tel" inputmode="numeric" autocomplete="off" placeholder="7–9 dígitos" aria-required="true">
              <button class="btn sec" id="dniCam">Cargar</button>
            </div>
          </div>
          <div>
            <label for="i_sexo">Sexo</label>
            <select id="i_sexo" name="Sexo">
              <option value="">—</option><option>M</option><option>F</option><option>X</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="i_fi">Fecha ingreso</label>
            <div class="kv">
              <input id="i_fi" name="FechaIngresoManual" type="date">
              <button class="btn sec" id="iFiNow">Ahora</button>
            </div>
          </div>
          <div>
            <label for="i_hi">Hora ingreso</label>
            <div class="kv">
              <input id="i_hi" name="HoraIngresoManual" type="time">
              <button class="btn sec" id="iHiNow">Ahora</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="i_ii">Ideación / Intento</label>
            <select id="i_ii" name="IdeacionIntento">
              <option value="">—</option><option>Ideación</option><option>Intento</option>
            </select>
          </div>
          <div>
            <label for="i_met">Método / Letalidad</label>
            <select id="i_met" name="MetodoLetalidad">
              <option value="">—</option>
              <option>Intoxicación</option><option>Corte</option><option>Colgamiento</option>
              <option>Arma de fuego</option><option>Arrojo</option><option>Otro</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="i_con">Consumo</label>
            <select id="i_con" name="Consumo"><option value="">—</option><option>Sí</option><option>No</option></select>
          </div>
          <div>
            <label for="i_sus">Tipo Sustancia</label>
            <select id="i_sus" name="TipoSustancia">
              <option value=""></option><option>Alcohol</option><option>BZD</option><option>Opioides</option>
              <option>Cocaína</option><option>THC</option><option>Mixto</option>
            </select>
          </div>
        </div>

        <label for="i_cie">Dx CIE-10 (código)</label>
        <input id="i_cie" name="DxProvisorio_CIE10" list="cie-list" placeholder="Ej: F32.1" inputmode="text" autocomplete="off">
        <datalist id="cie-list"></datalist>

        <label for="i_obs">Observaciones</label>
        <textarea id="i_obs" name="Observaciones" placeholder="Notas breves (opcional)"></textarea>

        <div class="chips" id="tpls" aria-label="Plantillas rápidas">
          <button class="chip" type="button" data-t="+Observación breve sin particularidades.">Obs. SP</button>
          <button class="chip" type="button" data-t="+Se informa red de apoyo presente.">Red apoyo ✓</button>
          <button class="chip" type="button" data-t="+Niega consumo reciente.">Niega consumo</button>
          <button class="chip" type="button" data-t="+Acompañante en guardia.">Acompañante</button>
        </div>

        <div class="st mut" id="ingMsg" aria-live="polite"></div>
        <div class="kv" style="margin-top:12px; gap:10px; flex-wrap:wrap">
          <button class="btn" id="ingSave">Guardar ingreso</button>
          <button class="btn ghost" id="ingShare">Compartir comprobante</button>
        </div>
        <div class="small">Tip: admite <code>?dni=&amp;sexo=&amp;fi=YYYY-MM-DD</code> para prellenar.</div>
      </section>

      <!-- ALTA -->
      <section id="v-alta" class="view" style="display:none" role="tabpanel" aria-labelledby="tab-alta">
        <div class="row">
          <div>
            <label for="a_dni">DNI</label>
            <input id="a_dni" name="DNI" type="tel" inputmode="numeric" placeholder="7–9 dígitos">
          </div>
          <div>
            <label for="a_fn">Fecha Nac. (opcional)</label>
            <input id="a_fn" name="FechaNac" type="date">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="a_sexo">Sexo</label>
            <select id="a_sexo" name="Sexo"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
          </div>
          <div>
            <label>Buscar ingreso</label>
            <div class="kv">
              <button class="btn sec" id="aSearch">Buscar por DNI</button>
              <span id="aFound" class="small" aria-live="polite"></span>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="a_fa">Fecha alta</label>
            <div class="kv">
              <input id="a_fa" name="FechaAltaManual" type="date"><button class="btn sec" id="aFaNow">Ahora</button>
            </div>
          </div>
          <div>
            <label for="a_ha">Hora alta</label>
            <div class="kv">
              <input id="a_ha" name="HoraAltaManual" type="time"><button class="btn sec" id="aHaNow">Ahora</button>
            </div>
          </div>
        </div>

        <label for="a_estado">Estado</label>
        <select id="a_estado" name="EstadoEgreso">
          <option>Alta</option><option>Derivación</option><option>Fuga</option>
          <option>Traslado</option><option>Óbito</option>
        </select>

        <label for="a_obs">Observaciones</label>
        <textarea id="a_obs" name="Observaciones" placeholder="Breve detalle (opcional)"></textarea>

        <div class="st mut" id="altaMsg" aria-live="polite"></div>
        <div class="kv" style="margin-top:12px; gap:10px; flex-wrap:wrap">
          <button class="btn" id="altaSave">Guardar alta</button>
          <button class="btn ghost" id="altaShare">Compartir comprobante</button>
        </div>
      </section>

      <!-- PENDIENTES -->
      <section id="v-pend" class="view" style="display:none" role="tabpanel" aria-labelledby="tab-pend">
        <div class="kv" style="gap:8px; flex-wrap:wrap">
          <button class="btn sec" id="flush">Enviar pendientes</button>
          <button class="btn ghost" id="exp">Exportar JSON</button>
          <input id="impFile" type="file" accept="application/json" style="display:none" aria-hidden="true">
          <button class="btn ghost" id="imp">Importar JSON</button>
          <span id="pendInfo" class="badge off">0</span>
        </div>
        <hr/>
        <div class="list" id="pendList" role="list"></div>
      </section>

      <!-- ÚTILES -->
      <section id="v-util" class="view" style="display:none" role="tabpanel" aria-labelledby="tab-util">
        <div class="row">
          <div class="card" style="padding:12px">
            <b>Escáner rápido (DNI)</b><br>
            <div class="small">Usá la cámara/teclado del celular para pegar/teclear DNI y validar.</div>
            <div class="kv" style="margin-top:8px">
              <input id="u_dni" type="tel" inputmode="numeric" placeholder="DNI">
              <button class="btn sec" id="uVal">Validar</button>
            </div>
            <div id="u_res" class="st mut" aria-live="polite"></div>
          </div>
          <div class="card" style="padding:12px">
            <b>Atajos</b>
            <div class="chips" style="margin-top:8px">
              <button class="chip" data-go="ing">Ir a Ingreso</button>
              <button class="chip" data-go="alta">Ir a Alta</button>
              <button class="chip" data-go="pend">Ver Pendientes</button>
            </div>
            <hr>
            <div class="small">Versión app: <span id="vver">v7-móvil</span></div>
          </div>
        </div>
      </section>
    </article>
  </main>

  <!-- CONFIG -->
  <dialog id="cfg" aria-labelledby="cfg-title">
    <form method="dialog" style="padding:14px">
      <h3 id="cfg-title" style="margin:0 0 10px">Configuración</h3>
      <label for="cfg_url">WebApp URL (/exec)</label>
      <input id="cfg_url" placeholder="https://script.google.com/macros/s/.../exec" inputmode="url">
      <label for="cfg_key">API Key</label>
      <input id="cfg_key" placeholder="Si está activa">
      <label for="cfg_logo">Logo URL (png/jpg/svg)</label>
      <input id="cfg_logo" placeholder="https://.../logo.png" inputmode="url">
      <div class="kv" style="margin-top:10px; gap:8px">
        <button class="btn sec" id="cfgTest" type="button">Probar</button>
        <button class="btn">Guardar</button>
      </div>
      <div id="cfgMsg" class="small" style="margin-top:8px" aria-live="polite"></div>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ========= LÓGICA / PWA / CIERRE ========= -->
<script>
/* ================== Utils base ================== */
const LS = {
  get(k, d=null){ try{ const v=localStorage.getItem(k); return v==null? d : JSON.parse(v) }catch(_){ return localStorage.getItem(k)||d } },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(_){ localStorage.setItem(k, v)} },
  del(k){ localStorage.removeItem(k) }
};
const $  = (s,root=document)=>root.querySelector(s);
const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
const vibrate = p => ('vibrate' in navigator)&&navigator.vibrate(p);
function toast(txt,ms=2200){ const t=$("#toast"); if(!t) return; t.textContent=txt; t.style.display='block'; setTimeout(()=>t.style.display='none',ms) }
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

/* ================== Normalizadores (compat CORE / Sheets) ================== */
const S = Object.freeze({
  normStr:v => (v==null? '' : String(v).trim()),
  onlyDigits:v => String(v==null?'':v).replace(/\D/g,''),
  normDate(v){
    v = this.normStr(v);
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)){
      const [d,m,y]=v.split('/'); return `${y}-${m}-${d}`;
    }
    return v; // yyyy-mm-dd
  },
  normTime(v){
    v = this.normStr(v); if(!v) return '';
    const m=v.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/); if(!m) return '';
    const hh=String(clamp(parseInt(m[1],10)||0,0,23)).padStart(2,'0');
    const mm=String(clamp(parseInt(m[2],10)||0,0,59)).padStart(2,'0');
    return `${hh}:${mm}`; // Sheets usa hh:mm
  }
});

/* ================== API (alineado a H8) ================== */
const DEFAULTS = { WEBAPP_URL:'', API_KEY:'' };
const API = {
  url(){ return LS.get('HSM_WEBAPP_URL', DEFAULTS.WEBAPP_URL) },
  key(){ return LS.get('HSM_API_KEY',     DEFAULTS.API_KEY) },
  async call(action, payload={}){
    const u=this.url(); if(!u) throw new Error('Sin URL configurada');
    const r=await fetch(u,{ method:'POST', headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action, apiKey:this.key(), payload}) });
    const t=await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status} ${t}`);
    try { return JSON.parse(t) } catch { return {ok:false, code:'E_PARSE', message:t} }
  },
  ping(){               return this.call('ping') },
  config(){             return this.call('config') },
  cie10(){              return this.call('cie10') },
  findByDni(d,days=120){return this.call('findbydni',{dni:d, days})},
  saveIngreso(p){       return this.call('save', p) },
  saveAlta(p){          return this.call('alta', p) }
};

/* ================== Estado online ================== */
function setOnline(ok){
  const b = $('#online'); if(!b) return;
  b.textContent = ok ? 'Online' : 'Offline';
  b.className   = 'badge ' + (ok?'ok':'off');
}
addEventListener('online',  ()=>{ setOnline(true);  toast('Conectado'); tryAutoFlush(); },  {passive:true});
addEventListener('offline', ()=>{ setOnline(false); toast('Sin conexión'); },               {passive:true});
setOnline(navigator.onLine);

/* ================== PWA: instalación + SW (warmup + sync) ================== */
let _deferredPrompt=null;
addEventListener('beforeinstallprompt',e=>{e.preventDefault();_deferredPrompt=e;$('#btnInstall').style.display='inline-block';},{passive:true});
$('#btnInstall')?.addEventListener('click',async()=>{ if(!_deferredPrompt) return; _deferredPrompt.prompt(); try{await _deferredPrompt.userChoice}catch(_){} _deferredPrompt=null; $('#btnInstall').style.display='none'; },{passive:true});

if('serviceWorker' in navigator){
  addEventListener('load', ()=>{
    navigator.serviceWorker.register('/panel-html-msm/sw.js',{scope:'/panel-html-msm/'})
      .then(async reg=>{
        try{ const sw=await navigator.serviceWorker.ready; sw.active?.postMessage({type:'WARMUP'}); }catch(_){}
        if('sync' in reg){ try{ await reg.sync.register('flush-pend'); }catch(_){ } }
      }).catch(()=>{});
  },{once:true, passive:true});

  navigator.serviceWorker.addEventListener('message',ev=>{
    if(ev.data?.type==='SW_ACTIVATED'){ toast('Nueva versión disponible. Recargando…',1800); setTimeout(()=>location.reload(),1500); }
    if(ev.data?.type==='TRY_FLUSH_PEND' && document.visibilityState==='visible'){ safeFlushPend(); }
  },{passive:true});
}

/* ================== Tabs con ARIA + hash routing ================== */
function switchTab(id){
  $$('.tab').forEach(btn=>{
    btn.setAttribute('aria-selected', String(btn.dataset.v===id));
    btn.classList.toggle('act', btn.dataset.v===id);
  });
  ['ing','alta','pend','util'].forEach(v => {
    const el=$('#v-'+v);
    if(el) el.style.display = (v===id?'block':'none');
  });
  if(id==='pend') renderPend();
  if(location.hash !== '#'+id) history.replaceState(null,'','#'+id);
}
function wireTabs(){
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>switchTab(btn.dataset.v), {passive:true});
    btn.addEventListener('keydown', (e)=>{
      if(e.key!=='ArrowRight' && e.key!=='ArrowLeft') return;
      const tabs=$$('.tab'); const i=tabs.indexOf(btn); const j=(e.key==='ArrowRight')? (i+1)%tabs.length : (i-1+tabs.length)%tabs.length;
      tabs[j].focus(); switchTab(tabs[j].dataset.v);
    });
  });
  const wanted=['ing','alta','pend','util'].includes(location.hash.slice(1))?location.hash.slice(1):'ing';
  switchTab(wanted);
}
addEventListener('hashchange', ()=>{ const v=location.hash.slice(1); if(['ing','alta','pend','util'].includes(v)) switchTab(v); }, {passive:true});

/* ================== Helpers fechas ================== */
const nowDate = () => new Date().toISOString().slice(0,10);
const nowTime = () => new Date().toTimeString().slice(0,5);
$('#iFiNow')?.addEventListener('click',()=>$('#i_fi').value=nowDate(),{passive:true});
$('#iHiNow')?.addEventListener('click',()=>$('#i_hi').value=nowTime(),{passive:true});
$('#aFaNow')?.addEventListener('click',()=>$('#a_fa').value=nowDate(),{passive:true});
$('#aHaNow')?.addEventListener('click',()=>$('#a_ha').value=nowTime(),{passive:true});

/* ================== Plantillas rápidas ================== */
$('#tpls')?.addEventListener('click',e=>{
  const t=e.target.closest('.chip'); if(!t) return;
  const el=$('#i_obs'); el.value=((el.value||'')+' '+t.dataset.t).trim(); el.focus();
},{passive:true});

/* ================== Validaciones mínimas ================== */
const validDNI = v => /^\d{7,9}$/.test(S.onlyDigits(v||''));

/* ================== Outbox offline ================== */
function boxGet(){ return LS.get('HSM_OUTBOX', []) }
function boxSet(a){
  LS.set('HSM_OUTBOX', a);
  const el=$('#pendInfo'); if(el){ el.textContent=a.length; el.className='badge '+(a.length?'ok':'off'); }
}
async function boxFlush(){
  const box=boxGet(); if(!box.length){ toast('No hay pendientes'); return; }
  const rest=[];
  for(const it of box){
    try{
      if(it.kind==='ingreso') await API.saveIngreso(it.payload);
      if(it.kind==='alta')    await API.saveAlta(it.payload);
    }catch(_){ rest.push(it); }
  }
  boxSet(rest);
  toast(rest.length?('Quedan '+rest.length+' pendientes'):'Pendientes enviados ✔');
  renderPend();
}
function tryAutoFlush(){ if(navigator.onLine && boxGet().length) setTimeout(boxFlush, 400); }
$('#flush')?.addEventListener('click', boxFlush, {passive:true});
$('#exp')?.addEventListener('click', ()=>{
  const a=document.createElement('a');
  a.download='hsm_outbox.json';
  a.href=URL.createObjectURL(new Blob([JSON.stringify(boxGet(),null,2)],{type:'application/json'}));
  a.click();
},{passive:true});
$('#imp')?.addEventListener('click', ()=>$('#impFile').click(), {passive:true});
$('#impFile']?.addEventListener?.('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{
    try{ const arr=JSON.parse(rd.result||'[]'); if(!Array.isArray(arr)) throw 0; boxSet(boxGet().concat(arr)); renderPend(); toast('Importado'); }
    catch(_){ toast('Archivo inválido',2600); }
  };
  rd.readAsText(f);
});
function renderPend(){
  const box=boxGet(), el=$('#pendList'); if(!el) return; el.innerHTML='';
  if(!box.length){ el.innerHTML='<div class="item"><span class="small">No hay pendientes.</span></div>'; return; }
  box.forEach((it,ix)=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<div class="small">${it.kind.toUpperCase()}</div>
      <div>DNI <b>${it.payload.DNI||'?'}</b> • ${new Date(it.ts).toLocaleString()}</div>
      <span class="sp"></span><button class="btn ghost" data-i="${ix}" type="button">Borrar</button>`;
    el.appendChild(d);
  });
  el.onclick=e=>{ const b=e.target.closest('button'); if(!b) return; const i=+b.dataset.i; const box=boxGet(); box.splice(i,1); boxSet(box); renderPend(); };
}

/* ================== Dedup local (1 min) + Drafts ================== */
const recentKey=(k,d)=>`HSM_REC_${k}_${d}`;
const dedupeSet=(k,d)=>LS.set(recentKey(k,d),Date.now());
const dedupeHit=(k,d,ms=60000)=> (Date.now()-(+LS.get(recentKey(k,d),0)))<ms;

const DRAFT_ING='HSM_DRAFT_ING', DRAFT_ALTA='HSM_DRAFT_ALTA';
function saveDraft(id,fs){ const o={}; fs.forEach(f=>o[f]=$('#'+f)?.value??''); LS.set(id,o); }
function loadDraft(id,fs){ const o=LS.get(id,null); if(!o) return; fs.forEach(f=>{ if(o[f]!=null && $('#'+f)) $('#'+f).value=o[f]; }); }
;['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs']
  .forEach(id=>$('#'+id)?.addEventListener('input',()=>saveDraft(DRAFT_ING,['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs']),{passive:true}));
;['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs']
  .forEach(id=>$('#'+id)?.addEventListener('input',()=>saveDraft(DRAFT_ALTA,['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs']),{passive:true}));

/* ================== Ingreso ================== */
let lastReceipt=null;
$('#ingSave')?.addEventListener('click', async ()=>{
  try{
    const dni=S.onlyDigits($('#i_dni').value);
    if(!validDNI(dni)){ $('#ingMsg').textContent='DNI inválido'; $('#ingMsg').className='st err'; vibrate(200); return; }
    if(dedupeHit('ing',dni)){ toast('Ingreso enviado hace instantes'); return; }
    const payload={
      DNI:dni,
      Sexo:($('#i_sexo').value||'').toUpperCase(),
      FechaIngresoManual:S.normDate($('#i_fi').value),
      HoraIngresoManual:S.normTime($('#i_hi').value),
      IdeacionIntento:S.normStr($('#i_ii').value),
      MetodoLetalidad:S.normStr($('#i_met').value),
      Consumo:S.normStr($('#i_con').value),
      TipoSustancia:S.normStr($('#i_sus').value),
      DxProvisorio_CIE10:S.normStr($('#i_cie').value).toUpperCase(),
      Observaciones:S.normStr($('#i_obs').value)
    };
    $('#ingMsg').textContent='Guardando…'; $('#ingMsg').className='st mut';
    const j=await API.saveIngreso(payload);
    if(j?.ok){
      $('#ingMsg').textContent='Guardado ✔'; $('#ingMsg').className='st ok';
      lastReceipt={kind:'Ingreso', dni, ts:Date.now()}; dedupeSet('ing',dni); LS.del(DRAFT_ING); vibrate([60,40,60]);
    }else throw new Error(j?.message||j?.code||'Error');
  }catch(e){
    const it={kind:'ingreso', payload:{
      DNI:S.onlyDigits($('#i_dni').value), Sexo:$('#i_sexo').value,
      FechaIngresoManual:$('#i_fi').value, HoraIngresoManual:$('#i_hi').value,
      IdeacionIntento:$('#i_ii').value, MetodoLetalidad:$('#i_met').value,
      Consumo:$('#i_con').value, TipoSustancia:$('#i_sus').value,
      DxProvisorio_CIE10:$('#i_cie').value, Observaciones:$('#i_obs').value
    }, ts:Date.now()};
    const box=boxGet(); box.push(it); boxSet(box);
    $('#ingMsg').textContent='Sin red. Guardado en pendientes ('+box.length+')'; $('#ingMsg').className='st err'; vibrate(150);
  }
},{passive:true});
$('#ingShare')?.addEventListener('click', ()=>{
  const txt = lastReceipt?`HSM • ${lastReceipt.kind} DNI ${lastReceipt.dni} • ${new Date(lastReceipt.ts).toLocaleString()}`:'HSM • Ingreso registrado';
  if(navigator.share) navigator.share({text:txt}).catch(()=>{});
  else navigator.clipboard.writeText(txt).then(()=>toast('Copiado'));
},{passive:true});

/* ================== Alta ================== */
$('#aSearch')?.addEventListener('click', async ()=>{
  try{
    const dni=S.onlyDigits($('#a_dni').value); if(!validDNI(dni)){ $('#aFound').textContent=' DNI inválido'; return; }
    $('#aFound').textContent=' Buscando…';
    const j=await API.findByDni(dni,120).catch(()=>null);
    if(j?.ok && j.found){ $('#aFound').textContent=' Encontrado'+(j.row?` (fila ${j.row})`:'' ); if(j.sexo) $('#a_sexo').value=(j.sexo||'').toUpperCase(); }
    else { $('#aFound').textContent=' No hallado (continuar manual)'; }
  }catch(_){ $('#aFound').textContent=' Offline (buscará al enviar)'; }
},{passive:true});

$('#altaSave')?.addEventListener('click', async ()=>{
  try{
    const dni=S.onlyDigits($('#a_dni').value);
    if(!validDNI(dni)){ $('#altaMsg').textContent='DNI inválido'; $('#altaMsg').className='st err'; vibrate(200); return; }
    if(dedupeHit('alta',dni)){ toast('Alta enviada hace instantes'); return; }
    const payload={
      DNI:dni, Sexo:($('#a_sexo').value||'').toUpperCase(),
      FechaAltaManual:S.normDate($('#a_fa').value),
      HoraAltaManual:S.normTime($('#a_ha').value),
      EstadoEgreso:S.normStr($('#a_estado').value)||'Alta',
      Observaciones:S.normStr($('#a_obs').value)
    };
    $('#altaMsg').textContent='Guardando…'; $('#altaMsg').className='st mut';
    const j=await API.saveAlta(payload);
    if(j?.ok){
      $('#altaMsg').textContent='Alta guardada ✔'; $('#altaMsg').className='st ok';
      lastReceipt={kind:'Alta', dni, ts:Date.now()}; dedupeSet('alta',dni); LS.del(DRAFT_ALTA); vibrate([60,40,60]);
    }else throw new Error(j?.message||j?.code||'Error');
  }catch(e){
    const it={kind:'alta', payload:{
      DNI:S.onlyDigits($('#a_dni').value), Sexo:$('#a_sexo').value,
      FechaAltaManual:$('#a_fa').value, HoraAltaManual:$('#a_ha').value,
      EstadoEgreso:$('#a_estado').value, Observaciones:$('#a_obs').value
    }, ts:Date.now()};
    const box=boxGet(); box.push(it); boxSet(box);
    $('#altaMsg').textContent='Sin red. Guardado en pendientes ('+box.length+')'; $('#altaMsg').className='st err'; vibrate(150);
  }
},{passive:true});

$('#altaShare')?.addEventListener('click', ()=>{
  const txt = lastReceipt?`HSM • ${lastReceipt.kind} DNI ${lastReceipt.dni} • ${new Date(lastReceipt.ts).toLocaleString()}`:'HSM • Alta registrada';
  if(navigator.share) navigator.share({text:txt}).catch(()=>{});
  else navigator.clipboard.writeText(txt).then(()=>toast('Copiado'));
},{passive:true});

/* ================== Útiles ================== */
$('#uVal')?.addEventListener('click', ()=>{
  const v=S.onlyDigits($('#u_dni').value); const ok=validDNI(v);
  $('#u_res').textContent = ok? 'Formato válido ✔' : 'Formato inválido';
  $('#u_res').className   = 'st ' + (ok?'ok':'err');
},{passive:true});
$$('[data-go]').forEach(c=>c.addEventListener('click', ()=>switchTab(c.dataset.go), {passive:true}));

/* ================== CIE10 cache (idle 10 min) ================== */
(function(){
  function seed(list){
    const dl=$('#cie-list'); if(!dl) return; dl.innerHTML='';
    list.slice(0,2000).forEach(x=>{ const o=document.createElement('option'); o.value=x.code; o.label=x.desc; dl.appendChild(o); });
  }
  const CK='CIE_CACHE', TS='CIE_TS';
  const run=async()=>{
    try{
      const now=Date.now(); let list=LS.get(CK,null), t=+LS.get(TS,0);
      if(!list || (now-t)>600000){ const j=await API.cie10(); list=(j&&j.ok&&j.list)||[]; LS.set(CK,list); LS.set(TS,now); }
      seed(LS.get(CK,[]));
    }catch(_){}
  };
  'requestIdleCallback' in window ? requestIdleCallback(run,{timeout:3000}) : setTimeout(run,1000);
})();

/* ================== Prefill query ================== */
(function(){
  const q=new URLSearchParams(location.search);
  if(q.get('dni'))  $('#i_dni').value = q.get('dni');
  if(q.get('sexo')) $('#i_sexo').value= (q.get('sexo')||'').toUpperCase();
  if(q.get('fi'))   $('#i_fi').value  = q.get('fi');
})();

/* ================== Settings ================== */
function applyLogo(){
  const url=LS.get('HSM_LOGO_URL',''); const el=$('#logo');
  if(!el) return; if(url){ el.loading='lazy'; el.decoding='async'; el.src=url; el.hidden=false; } else { el.hidden=true; }
}
$('#btnCfg')?.addEventListener('click', ()=>{
  $('#cfg_url').value=API.url()||''; $('#cfg_key').value=API.key()||''; $('#cfg_logo').value=LS.get('HSM_LOGO_URL','')||'';
  $('#cfg').showModal();
},{passive:true});
$('#cfg')?.addEventListener('close', ()=>{
  const u=$('#cfg_url').value.trim(), k=$('#cfg_key').value.trim(), l=$('#cfg_logo').value.trim();
  if(u) LS.set('HSM_WEBAPP_URL',u); else LS.del('HSM_WEBAPP_URL');
  if(k) LS.set('HSM_API_KEY',k);    else LS.del('HSM_API_KEY');
  if(l) LS.set('HSM_LOGO_URL',l);   else LS.del('HSM_LOGO_URL');
  applyLogo(); toast('Configuración guardada');
});
$('#cfgTest')?.addEventListener('click', async ()=>{
  try{ const r=await API.ping(); $('#cfgMsg').textContent='OK '+(r.version||''); toast('WebApp OK'); }
  catch(e){ $('#cfgMsg').textContent='Error: '+(e.message||e); toast('No conecta',2600) }
},{passive:true});

/* ================== Boot ================== */
addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') tryAutoFlush(); },{passive:true});

addEventListener('DOMContentLoaded', ()=>{
  applyLogo();
  wireTabs();                 // interacción primero
  boxSet(boxGet());           // badge de pendientes
  if($('#i_fi') && !$('#i_fi').value) $('#i_fi').value=nowDate();
  if($('#i_hi') && !$('#i_hi').value) $('#i_hi').value=nowTime();
  tryAutoFlush();
  // diferir carga de borradores para liberar el hilo y mejorar LCP/TBT
  const idle = ()=>{
    try{ loadDraft(DRAFT_ING,['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs']); }catch(_){}
    try{ loadDraft(DRAFT_ALTA,['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs']); }catch(_){}
  };
  'requestIdleCallback' in window ? requestIdleCallback(idle,{timeout:1500}) : setTimeout(idle,400);
});
function safeFlushPend(){ if(!navigator.onLine) return; boxFlush(); }
</script>
<!-- ========= /FIN LÓGICA ========= -->
</body>
</html>
