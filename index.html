<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0d1321" />
  <meta name="description" content="HSM v7 ‚Ä¢ M√≥vil. Carga r√°pida y segura de ingresos y altas del servicio de Salud Mental." />
  <title>HSM v7 ‚Ä¢ M√≥vil</title>

  <style>
    :root{
      /* Paleta accesible (alto contraste sobre fondo oscuro) */
      --bg: #0d1321;
      --panel: #141a2a;
      --panel-2: #1a2236;
      --txt: #e9f1ff;
      --txt-muted: #bfd1ff;        /* mejor contraste AA */
      --txt-placeholder: #afc2f5;  /* mejor contraste AA */
      --brand: #3da9fc;
      --ok: #2dd4bf;
      --warn: #f59e0b;
      --err: #ef4444;
      --chip: #2b3550;

      --radius: 14px;
      --gap: 14px;
      --shadow: 0 6px 18px rgba(0,0,0,.25);
      --focus: 0 0 0 3px rgba(61,169,252,.35);
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    header{
      display:flex; align-items:center; gap:10px;
      padding:14px 16px; position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg, rgba(13,19,33,.95), rgba(13,19,33,.85) 60%, rgba(13,19,33,0));
      backdrop-filter: blur(6px);
    }
    .badge{padding:4px 10px;border-radius:999px;background:#11213d;color:#cfe7ff;}
    .badge.ok{background:#0d2b26;color:#bff7ea;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:38px; padding:0 14px; border-radius:10px; border:0;
      color:#e6eeff; background:#1b2742; box-shadow:var(--shadow);
      cursor:pointer; user-select:none;
    }
    .btn.primary{ background: linear-gradient(180deg,#2363ff,#1646c5); }
    .btn.warn{ background:#6b4b00; }
    .btn:hover{ filter:brightness(1.05) }
    .btn:disabled{ opacity:.55; cursor:not-allowed; filter:none }
    .row{ display:flex; flex-wrap:wrap; gap:var(--gap); }
    .col{ flex:1 1 260px; min-width:250px; }
    main{ padding:10px 14px 60px; }

    .card{
      background:var(--panel); border:1px solid #1e2740; border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow);
    }
    .head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .title{ font-weight:600; }

    label{ display:block; margin:12px 0 6px; color:#cfe1ff; }
    input, select, textarea{
      width:100%; border:1px solid #2a385f; border-radius:12px;
      background:var(--panel-2); color:var(--txt);
      padding:12px 12px; outline:none;
      box-shadow: inset 0 0 0 1px transparent;
    }
    input::placeholder, textarea::placeholder{ color:var(--txt-placeholder); }
    input:focus, select:focus, textarea:focus{ box-shadow:var(--focus); border-color:#3564ff; }

    .inline{ display:flex; gap:10px; align-items:center; }
    .helper{ color:var(--txt-muted); font-size:12px; margin-top:6px; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      background:var(--chip); color:#e6eeff; border-radius:999px;
      padding:8px 12px; cursor:pointer; user-select:none;
      border:1px solid #334067;
    }
    .chip:hover{ filter:brightness(1.08) }

    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th, td{ padding:10px; border-bottom:1px solid #283149; text-align:left; }
    th{ color:#cfe1ff; font-weight:600; background:#11182a; position:sticky; top:0; }

    .toast{
      position:fixed; left:14px; right:14px; bottom:14px; z-index:20;
      background:#0f1a30; color:#e6eeff; border:1px solid #2b3a60; border-radius:12px;
      padding:12px 14px; box-shadow:var(--shadow);
    }

    dialog{
      border:1px solid #2a385f; background:var(--panel); color:var(--txt);
      border-radius:16px; padding:0; width:min(650px, 92vw);
      box-shadow: var(--shadow);
    }
    dialog .dhd{ padding:14px 16px; border-bottom:1px solid #263153; font-weight:600; }
    dialog .dbd{ padding:16px; }
    dialog .dft{ padding:12px 16px; border-top:1px solid #263153; display:flex; gap:10px; justify-content:flex-end; }
    dialog::backdrop{ background: rgba(0,0,0,.45) }

    .tag{padding:4px 8px;border-radius:8px;background:#12203b;color:#b8d7ff;border:1px solid #27406e;font-size:12px}
    .status-pend{ background:#3a2b00; color:#ffd271; border-color:#6b4b00;}
    .status-ok{ background:#0e2e2b; color:#bff7ea; border-color:#1f5b52;}
    .status-fail{ background:#3a0f14; color:#ffb3bd; border-color:#6b1120;}
  </style>
</head>
<body>

<header>
  <strong>üìä HSM v7 ‚Ä¢ M√≥vil</strong>
  <span id="badgeOnline" class="badge ok" role="status">Online</span>
  <div style="flex:1"></div>
  <button class="btn" id="btnConfig" aria-label="Abrir configuraci√≥n" title="Configuraci√≥n (URL WebApp + API Key)">‚öôÔ∏è</button>
</header>

<main>
  <section class="card" aria-labelledby="ing-title">
    <div class="head">
      <div class="title" id="ing-title">Ingreso</div>
      <div class="inline">
        <button class="btn" id="btnHoy">Hoy</button>
        <button class="btn" id="btnAhora">Ahora</button>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="dni">DNI</label>
        <input id="dni" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="9" placeholder="7‚Äì9 d√≠gitos" aria-describedby="dniHelp" />
        <div id="dniHelp" class="helper">Solo n√∫meros (sin puntos)</div>
      </div>

      <div class="col">
        <label for="sexo">Sexo</label>
        <select id="sexo" aria-label="Sexo">
          <option value="">‚Äî</option>
          <option>F</option>
          <option>M</option>
          <option>X</option>
        </select>
      </div>

      <div class="col">
        <label for="fec">Fecha ingreso</label>
        <input id="fec" type="date" aria-describedby="fmtFec" />
        <div id="fmtFec" class="helper">Formato enviado: yyyy-mm-dd</div>
      </div>

      <div class="col">
        <label for="hora">Hora ingreso</label>
        <input id="hora" type="time" step="60" />
      </div>

      <div class="col">
        <label for="ide">Ideaci√≥n / Intento</label>
        <select id="ide">
          <option value="">‚Äî</option>
          <option>Ideaci√≥n</option>
          <option>Intento</option>
        </select>
      </div>

      <div class="col">
        <label for="met">M√©todo / Letalidad</label>
        <select id="met">
          <option value="">‚Äî</option>
          <option>Intoxicaci√≥n</option>
          <option>Corte</option>
          <option>Colgamiento</option>
          <option>Arma de fuego</option>
          <option>Arrojo</option>
          <option>Otro</option>
        </select>
      </div>

      <div class="col">
        <label for="cons">Consumo</label>
        <select id="cons">
          <option>Niega</option>
          <option>S√≠</option>
          <option>En estudio</option>
        </select>
      </div>

      <div class="col">
        <label for="freq">Frecuencia</label>
        <select id="freq" aria-label="Frecuencia de consumo">
          <option value="">‚Äî</option>
          <option>Diaria</option>
          <option>Semanal</option>
          <option>Ocasional</option>
        </select>
      </div>

      <div class="col">
        <label for="dx">Dx CIE-10 (c√≥digo)</label>
        <input id="dx" type="text" placeholder="Ej: F32.1" />
      </div>

      <div class="col" style="flex:1 1 100%">
        <label for="obs">Observaciones</label>
        <textarea id="obs" rows="4" placeholder="Notas breves (opcional)"></textarea>

        <div class="chips" aria-label="Atajos de observaci√≥n">
          <span class="chip" data-obs="Obs. SP">Obs. SP</span>
          <span class="chip" data-obs="Red apoyo ‚úì">Red apoyo ‚úì</span>
          <span class="chip" data-obs="Niega consumo">Niega consumo</span>
          <span class="chip" data-obs="Acompa√±ante">Acompa√±ante</span>
        </div>
      </div>
    </div>

    <div class="inline" style="margin-top:12px; gap:12px;">
      <button class="btn primary" id="btnGuardar">Guardar ingreso</button>
      <span id="pendBadge" class="badge" aria-live="polite">Pend: 0</span>
    </div>

    <div id="toast" class="toast" hidden aria-live="polite"></div>
  </section>

  <section class="card" style="margin-top:16px" aria-labelledby="pend-title">
    <div class="head">
      <div class="title" id="pend-title">Pendientes</div>
      <div class="inline">
        <span class="tag">Se evita duplicar por DUPE_KEY = DNI | Fecha | Hora</span>
        <button class="btn" id="btnRetryAll">Reintentar todos</button>
        <button class="btn warn" id="btnVaciar">Vaciar cola</button>
      </div>
    </div>

    <div class="tablewrap">
      <table aria-describedby="pend-desc">
        <caption id="pend-desc" class="sr-only">Listado de env√≠os pendientes/offline</caption>
        <thead><tr>
          <th>#</th><th>Tipo</th><th>DNI</th><th>Fecha</th><th>Hora</th><th>Estado</th>
        </tr></thead>
        <tbody id="tbodyPend"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Configuraci√≥n -->
<dialog id="dlgCfg" aria-labelledby="cfg-title">
  <div class="dhd" id="cfg-title">Configuraci√≥n</div>
  <div class="dbd">
    <label for="cfgUrl">WebApp URL (/exec)</label>
    <input id="cfgUrl" type="url" placeholder="https://script.google.com/macros/s/....../exec" />

    <label for="cfgKey">API Key</label>
    <input id="cfgKey" type="text" placeholder="HSM2025KEY" />

    <div class="helper">El bot√≥n ‚ÄúProbar‚Äù hace un ping GET y muestra resultado.</div>
  </div>
  <div class="dft">
    <button class="btn" id="btnPing">Probar</button>
    <button class="btn primary" id="btnSaveCfg">Guardar</button>
  </div>
</dialog>

<script>
/* =============================
 * Estado / Config local
 * ============================= */
const $ = sel => document.querySelector(sel);
const cfg = {
  get url(){ return localStorage.getItem('cfg_url') || ''; },
  set url(v){ localStorage.setItem('cfg_url', String(v||'')); },
  get key(){ return localStorage.getItem('cfg_key') || ''; },
  set key(v){ localStorage.setItem('cfg_key', String(v||'')); },
};
const QUEUE_KEY = 'pend';
const TYPE_ING = 'ing';

/* =============================
 * Utilidades
 * ============================= */
function toast(msg, ms=2600){ const t=$("#toast"); t.textContent=msg; t.hidden=false; setTimeout(()=>t.hidden=true, ms); }
function nowISODate(){ const d=new Date(); return d.toISOString().slice(0,10); }
function nowTimeHHMM(){ const d=new Date(); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return `${h}:${m}`; }
function setOnlineBadge(){
  const b = $("#badgeOnline");
  const on = navigator.onLine;
  b.textContent = on? 'Online':'Offline';
  b.classList.toggle('ok', on);
}
window.addEventListener('online', setOnlineBadge);
window.addEventListener('offline', setOnlineBadge);

/* DUPE KEY: DNI | Fecha | Hora */
function makeDupeKey(rec){
  const f = rec.FechaIngresoManual;            // yyyy-mm-dd
  const h = (rec.HoraIngresoManual||'').slice(0,5);
  return `${rec.DNI}|${f}|${h}`;
}

/* Cola local: reemplaza si existe mismo DUPE y estado=pend */
function loadQ(){ try{return JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');}catch(_){return[];} }
function saveQ(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); updatePendUI(); }
function enqueueOffline(rec){
  const q = loadQ();
  const dupe = makeDupeKey(rec);
  const withMeta = {...rec, _type:TYPE_ING, _dupe:dupe, _estado:'pend', _retries:(rec._retries||0)};
  const idx = q.findIndex(x=>x._dupe===dupe && x._estado==='pend');
  if(idx>=0) q[idx]=withMeta; else q.push(withMeta);
  saveQ(q);
  toast('Sin conexi√≥n o error: qued√≥ en pendientes');
}
function clearQueue(){
  saveQ([]);
  toast('Cola vaciada');
}

/* UI pendientes */
function updatePendUI(){
  const q=loadQ(); const tb=$("#tbodyPend"); tb.innerHTML='';
  q.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td>${it._type||''}</td>
      <td>${it.DNI||''}</td>
      <td>${it.FechaIngresoManual||''}</td>
      <td>${(it.HoraIngresoManual||'').slice(0,5)}</td>
      <td><span class="tag ${it._estado==='ok'?'status-ok': it._estado==='fail'?'status-fail':'status-pend'}">${it._estado}</span></td>`;
    tb.appendChild(tr);
  });
  $("#pendBadge").textContent=`Pend: ${q.filter(x=>x._estado==='pend').length}`;
}

/* =============================
 * Env√≠o a GAS
 * ============================= */
async function enviarAPI(payload){
  if(!cfg.url) throw new Error('Config: falta URL WebApp');
  const res = await fetch(cfg.url, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key': cfg.key || ''
    },
    body: JSON.stringify(payload),
  });
  if(!res.ok){
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error('API '+res.status+' '+txt);
  }
  return res.json().catch(()=> ({}));
}

/* Reintento con backoff y l√≠mite */
async function reintentarTodos(){
  const q = loadQ();
  for (const it of q){
    if (it._estado !== 'pend') continue;
    try{
      await enviarAPI(it);
      it._estado='ok';
    }catch(e){
      it._retries=(it._retries||0)+1;
      if (it._retries>=5) it._estado='fail';
      await new Promise(r=>setTimeout(r, 550*(it._retries||1))); // backoff
    }
  }
  saveQ(q);
  toast('Reintento completado');
}

/* =============================
 * Form / Guardar
 * ============================= */
function getForm(){
  const dni=$("#dni").value.trim();
  const sexo=$("#sexo").value.trim();
  const fecha=$("#fec").value;
  const hora=$("#hora").value;
  const ide=$("#ide").value.trim();
  const met=$("#met").value.trim();
  const cons=$("#cons").value.trim();
  const freq=$("#freq").value.trim();
  const dx=$("#dx").value.trim();
  const obs=$("#obs").value.trim();

  return {
    Tipo: TYPE_ING,
    DNI: dni,
    Sexo: sexo,
    FechaIngresoManual: fecha,
    HoraIngresoManual: hora,
    IdeacionIntento: ide,
    MetodoLetalidad: met,
    Consumo: cons,
    Frecuencia: freq,
    DxCIE10: dx,
    Observaciones: obs,
    AppVersion: "v7-m√≥vil"
  };
}

async function guardarIngreso(){
  const btn = $("#btnGuardar");
  if (btn.disabled) return;
  const data = getForm();

  // Validaci√≥n m√≠nima
  if (!data.DNI || !data.FechaIngresoManual || !data.HoraIngresoManual){
    toast('Faltan DNI / Fecha / Hora'); return;
  }

  btn.disabled = true;
  try{
    await enviarAPI(data);
    toast('Guardado ‚úî');
  }catch(e){
    enqueueOffline(data);
  }finally{
    btn.disabled = false;
  }
}

/* =============================
 * Config
 * ============================= */
const dlg = $("#dlgCfg");
$("#btnConfig").addEventListener('click', ()=>{
  $("#cfgUrl").value = cfg.url;
  $("#cfgKey").value = cfg.key;
  dlg.showModal();
});
$("#btnSaveCfg").addEventListener('click', ()=>{
  cfg.url = $("#cfgUrl").value.trim();
  cfg.key = $("#cfgKey").value.trim();
  dlg.close();
  toast('Configuraci√≥n guardada');
});
$("#btnPing").addEventListener('click', async ()=>{
  if(!$("#cfgUrl").value.trim()){ toast('Ingres√° la URL /exec'); return; }
  try{
    const u = new URL($("#cfgUrl").value.trim());
    // ping GET simple (GAS doGet opcional)
    const r = await fetch(u, { method:'GET' });
    toast('Ping enviado (revis√° el deployment de GAS)');
  }catch(e){ toast('URL inv√°lida o sin respuesta'); }
});

/* =============================
 * Eventos UI
 * ============================= */
document.addEventListener('click', (ev)=>{
  const chip = ev.target.closest('.chip');
  if(chip){
    const v = chip.getAttribute('data-obs')||'';
    const t = $("#obs");
    t.value = (t.value? t.value.trim()+" ‚Ä¢ ":"") + v;
  }
});

$("#btnGuardar").addEventListener('click', guardarIngreso);
$("#btnRetryAll").addEventListener('click', reintentarTodos);
$("#btnVaciar").addEventListener('click', clearQueue);
$("#btnHoy").addEventListener('click', ()=> $("#fec").value = nowISODate());
$("#btnAhora").addEventListener('click', ()=> $("#hora").value = nowTimeHHMM());

/* =============================
 * Init
 * ============================= */
(function init(){
  setOnlineBadge();
  if(!$("#fec").value) $("#fec").value = nowISODate();
  if(!$("#hora").value) $("#hora").value = nowTimeHHMM();
  updatePendUI();
})();
</script>
</body>
</html>
