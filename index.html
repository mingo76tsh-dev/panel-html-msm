<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HSM v7 • Ingreso / Alta</title>
<meta name="color-scheme" content="dark light" />

<style>
  :root{
    --bg: #0b0f14;
    --panel: #131a22;
    --muted: #7f8a98;
    --text: #eaf1ff;
    --accent: #7c5cff;   /* violeta */
    --accent-2: #2dd4bf; /* turquesa */
    --ok: #22c55e;
    --warn: #f59e0b;
    --bad: #ef4444;

    --radius: 14px;
    --gap: 14px;
  }
  *{ box-sizing: border-box; }
  html, body{ height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--text); font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    letter-spacing:.2px;
  }

  .shell{ max-width: 1180px; margin: 24px auto; padding: 0 16px 48px; }
  header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 18px;
  }
  h1{ font-size: 18px; font-weight:600; margin:0; opacity:.95; }
  .badge{
    background: linear-gradient(90deg,var(--accent) 0,var(--accent-2));
    color:#0a0a0a; font-weight:700; border-radius: 999px; padding:6px 12px; font-size:12px;
    box-shadow: 0 0 24px rgba(124,92,255,.35);
  }
  .online-dot{ width:10px; height:10px; border-radius:50%; margin-left:10px; display:inline-block; background:var(--ok); box-shadow:0 0 12px var(--ok);}
  .offline{ background:var(--bad) !important; box-shadow:0 0 12px var(--bad) !important;}

  .tabs{
    display:flex; gap:10px; margin: 16px 0;
  }
  .tab{
    background:#0f1520; color:var(--text); border:1px solid rgba(255,255,255,.06);
    border-radius: 10px; padding:12px 16px; cursor:pointer; transition:.2s transform, .2s background;
  }
  .tab[aria-selected="true"]{
    background:linear-gradient(180deg, rgba(124,92,255,.18), rgba(23,23,23,.35));
    transform: translateY(-1px);
    border-color: rgba(124,92,255,.35);
  }

  .grid{
    display:grid; gap: var(--gap);
    grid-template-columns: 1fr 1fr;
  }
  .panel{
    background: var(--panel);
    border:1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
    padding: 18px;
  }
  .hint{ color: var(--muted); font-size: 13px; }
  .kbd{ background:#0b1020; border:1px solid rgba(255,255,255,.1); border-bottom-color: rgba(0,0,0,.4);
        padding:2px 6px; border-radius:6px; font-size:12px; margin:0 2px; display:inline-block; }

  .field{ display:flex; flex-direction:column; gap:8px; margin-bottom:14px; }
  label{ font-size: 13px; color: #cfe2ff; }
  input[type="text"], input[type="date"], input[type="time"], select, textarea{
    width:100%; background:#0b111b; color:var(--text);
    border:1px solid rgba(255,255,255,.08);
    border-radius: 10px; padding: 12px 12px; outline:none; transition: .2s border, .2s box-shadow;
  }
  input:focus, select:focus, textarea:focus{
    border-color: rgba(124,92,255,.7);
    box-shadow:0 0 0 3px rgba(124,92,255,.25);
  }
  textarea{ min-height: 120px; resize: vertical; }

  .row{ display:flex; gap: var(--gap); }
  .row > .field{ flex:1; }

  .btn{
    appearance: none; border:0; cursor:pointer;
    border-radius: 12px; padding: 12px 16px;
    font-weight: 600; color: #0c0c0c;
    background: linear-gradient(90deg, var(--accent) 0, var(--accent-2) 100%);
    box-shadow: 0 10px 24px rgba(124,92,255,.25), inset 0 1px 0 rgba(255,255,255,.2);
    transition:.2s transform, .2s filter, .2s opacity;
  }
  .btn:hover{ filter: brightness(1.08); }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btn.secondary{
    background: #101826; color: var(--text);
    border:1px solid rgba(255,255,255,.08); box-shadow:none;
  }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  .actions{ display:flex; gap:12px; align-items:center; }
  .footer{ margin-top: 16px; color:var(--muted); font-size:13px; text-align:right; }

  .sr{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

  /* Autocomplete popover */
  .ac-wrap{ position:relative; }
  .ac-list{
    position:absolute; z-index:10; inset-inline:0; top: calc(100% + 4px);
    background:#0b111b; border:1px solid rgba(255,255,255,.08);
    border-radius: 10px; padding:6px; max-height: 260px; overflow:auto; display:none;
  }
  .ac-item{
    padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; gap:8px; align-items:baseline;
  }
  .ac-item b{ color:#d6e2ff; letter-spacing:.3px; }
  .ac-item small{ color:var(--muted); }
  .ac-item:hover, .ac-item[aria-selected="true"]{ background:#111a28; }

  /* Toasts */
  .toasts{ position: fixed; right: 18px; bottom: 18px; display:flex; flex-direction:column; gap:10px; z-index: 40; }
  .toast{
    background:#101826; border:1px solid rgba(255,255,255,.08); color:var(--text);
    padding:12px 14px; border-radius: 10px; min-width: 240px; box-shadow:0 8px 24px rgba(0,0,0,.25);
  }
  .toast.ok{ border-color: rgba(34,197,94,.4); }
  .toast.bad{ border-color: rgba(239,68,68,.5); }
</style>
</head>

<body>
<div class="shell">
  <header>
    <h1>HSM v7 • Ingreso / Alta</h1>
    <div>
      <span id="netBadge" class="badge" aria-live="polite" aria-atomic="true">Online</span>
      <span id="dot" class="online-dot" aria-hidden="true"></span>
    </div>
  </header>

  <div class="tabs" role="tablist" aria-label="Elegir operación">
    <button class="tab" role="tab" aria-selected="true"  id="tab-ing" aria-controls="panel-ing">Ingreso</button>
    <button class="tab" role="tab" aria-selected="false" id="tab-alt" aria-controls="panel-alt">Alta / Egreso</button>
  </div>

  <!-- PANEL INGRESO -->
  <section id="panel-ing" role="tabpanel" aria-labelledby="tab-ing" class="panel">
    <form id="form-ing" novalidate>
      <p class="hint" id="hint-ing">
        Datos mínimos: <b>DNI</b> (7–9), <b>Sexo</b>, <b>Fecha</b> y <b>Hora</b>. 
        Atajo: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> guarda.
      </p>

      <div class="grid">
        <div>
          <div class="field">
            <label for="dni">DNI</label>
            <div class="row">
              <input id="dni" name="dni" inputmode="numeric" pattern="\\d{7,9}" placeholder="7–9 dígitos" autocomplete="off" aria-describedby="dni-help" required />
              <button type="button" class="btn secondary" id="btn-buscar-dni" aria-describedby="dni-help">Buscar</button>
            </div>
            <div class="hint" id="dni-help">Ej: 32123456</div>
          </div>

          <div class="row">
            <div class="field">
              <label for="fecha-ing">Fecha ingreso</label>
              <input type="date" id="fecha-ing" required />
            </div>
            <div class="field">
              <label for="hora-ing">Hora ingreso</label>
              <input type="time" id="hora-ing" step="60" required />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="sexo">Sexo</label>
              <select id="sexo" required>
                <option value="">—</option>
                <option>F</option><option>M</option><option>NB</option>
              </select>
            </div>
            <div class="field">
              <label for="metodo">Método / Letalidad</label>
              <input id="metodo" list="dl-metodos" placeholder="Método" />
              <datalist id="dl-metodos">
                <option value="ingesta medicamentosa"></option>
                <option value="ahorcamiento"></option>
                <option value="precipitación"></option>
                <option value="arma blanca"></option>
                <option value="arma de fuego"></option>
                <option value="intoxicación"></option>
              </datalist>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="ii">Ideación / Intento</label>
              <select id="ii">
                <option value="">—</option>
                <option>Ideación</option><option>Intento</option>
              </select>
            </div>
            <div class="field">
              <label for="consumo">Consumo</label>
              <select id="consumo">
                <option value="">—</option>
                <option>Sí</option><option>No</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="sust">Tipo Sustancia</label>
              <input id="sust" list="dl-sust" placeholder="Ej: Cocaína, BZD…" />
              <datalist id="dl-sust">
                <option value="Alcohol"></option>
                <option value="Cocaína"></option>
                <option value="Cannabis"></option>
                <option value="BZD"></option>
                <option value="Opioides"></option>
              </datalist>
            </div>
            <div class="field">
              <label for="freq">Frecuencia</label>
              <select id="freq">
                <option value="">—</option>
                <option>Ocasional</option><option>Semanal</option><option>Diaria</option>
              </select>
            </div>
          </div>
        </div>

        <div>
          <div class="field ac-wrap">
            <label for="dx">Dx CIE-10 (provisorio)</label>
            <input id="dx" placeholder="Ej: F10.1 Trastornos mentales…" aria-autocomplete="list" aria-expanded="false" aria-controls="ac-list" autocomplete="off" />
            <div id="ac-list" class="ac-list" role="listbox" aria-label="Sugerencias CIE-10"></div>
            <div class="row" style="margin-top:6px">
              <button type="button" class="btn secondary" id="btn-last-dx">Cargar último Dx de este DNI</button>
            </div>
            <p class="hint">Escribí <b>código</b> o <b>descripción</b>; se autocompleta desde la hoja <b>CIE10_MAP</b>.</p>
          </div>

          <div class="field">
            <label for="obs">Observaciones</label>
            <textarea id="obs" placeholder="Notas breves…"></textarea>
          </div>

          <div class="actions">
            <button id="btn-save-ing" class="btn">Guardar ingreso</button>
            <span id="status-ing" class="hint" role="status" aria-live="polite"></span>
          </div>
        </div>
      </div>
    </form>
  </section>

  <!-- PANEL ALTA -->
  <section id="panel-alt" role="tabpanel" aria-labelledby="tab-alt" class="panel" hidden>
    <form id="form-alt" novalidate>
      <p class="hint">Ingresá DNI, Sexo (si aplica), fecha y hora de alta. Si no existe un ingreso abierto, se crea “solo alta”.</p>

      <div class="grid">
        <div>
          <div class="field">
            <label for="dni-alt">DNI</label>
            <div class="row">
              <input id="dni-alt" inputmode="numeric" pattern="\\d{7,9}" placeholder="7–9 dígitos" required />
              <button type="button" class="btn secondary" id="btn-buscar-dni-alt">Buscar</button>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="sexo-alt">Sexo</label>
              <select id="sexo-alt">
                <option value="">—</option>
                <option>F</option><option>M</option><option>NB</option>
              </select>
            </div>
            <div class="field">
              <label for="estado-egreso">Estado egreso</label>
              <select id="estado-egreso">
                <option>Alta</option>
                <option>Derivación</option>
                <option>Fuga</option>
                <option>Óbito</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="fecha-alt">Fecha alta</label>
              <input type="date" id="fecha-alt" required />
            </div>
            <div class="field">
              <label for="hora-alt">Hora alta</label>
              <input type="time" id="hora-alt" step="60" required />
            </div>
          </div>
        </div>

        <div>
          <div class="field">
            <label for="obs-alt">Observaciones</label>
            <textarea id="obs-alt" placeholder="Notas…"></textarea>
          </div>
          <div class="actions">
            <button id="btn-save-alt" class="btn">Guardar alta</button>
            <span id="status-alt" class="hint" role="status" aria-live="polite"></span>
          </div>
        </div>
      </div>
    </form>
  </section>

  <div class="footer">v7 • Panel HTML • GitHub Pages</div>
</div>

<!-- toasts -->
<div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
/* ===== Configuración WebApp y API KEY ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyqvAkFP2tf_lT6BXNcMNJ0esY0MajUTsI91wXRItW6RGhJguR4VwdG9wUkLWf1EC7u/exec';
const API_KEY    = 'HSM2025KEY';

/* ===== Helpers fetch sin preflight (application/x-www-form-urlencoded) ===== */
function postForm(url, params){
  const body = new URLSearchParams(params);
  return fetch(url + '?apiKey=' + encodeURIComponent(API_KEY), {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'omit',
    body // ¡sin headers custom!
  }).then(r => r.json());
}
function getJSON(url){
  return fetch(url, { mode:'cors', credentials:'omit' }).then(r => r.json());
}

/* ===== UI ===== */
const $ = sel => document.querySelector(sel);
const acWrap = $('#ac-list');
let acIndex = -1, acItems = [];

function toast(msg, cls=''){
  const t = document.createElement('div');
  t.className = 'toast ' + cls;
  t.textContent = msg;
  $('#toasts').appendChild(t);
  setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(), 400); }, 3000);
}
function setNetStatus(online){
  $('#netBadge').textContent = online ? 'Online' : 'Sin red';
  $('#dot').classList.toggle('offline', !online);
}

/* ===== Tabs ===== */
function showTab(id){
  const ing = id === 'ing';
  $('#tab-ing').setAttribute('aria-selected', ing ? 'true':'false');
  $('#tab-alt').setAttribute('aria-selected', !ing ? 'true':'false');
  $('#panel-ing').hidden = !ing;
  $('#panel-alt').hidden = ing;
}
$('#tab-ing').addEventListener('click', ()=>showTab('ing'));
$('#tab-alt').addEventListener('click', ()=>showTab('alt'));

/* ===== Fechas default ===== */
function todayISO(){ const d=new Date(); const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return `${y}-${m}-${dd}`; }
function timeNow(){ const d=new Date(); const hh=('0'+d.getHours()).slice(-2), mm=('0'+d.getMinutes()).slice(-2); return `${hh}:${mm}`; }
$('#fecha-ing').value = todayISO();
$('#hora-ing').value  = timeNow();
$('#fecha-alt').value = todayISO();
$('#hora-alt').value  = timeNow();

/* ===== Cola offline ===== */
const QKEY = 'hsm_queue_v1';
function enqueue(item){
  const q = JSON.parse(localStorage.getItem(QKEY)||'[]'); q.push(item);
  localStorage.setItem(QKEY, JSON.stringify(q));
  updateQueueBadge();
}
function dequeue(){
  const q = JSON.parse(localStorage.getItem(QKEY)||'[]'); const it = q.shift();
  localStorage.setItem(QKEY, JSON.stringify(q));
  updateQueueBadge(); return it;
}
function queueSize(){ return JSON.parse(localStorage.getItem(QKEY)||'[]').length; }
function updateQueueBadge(){
  const n = queueSize();
  const st = $('#netBadge');
  if (n>0) st.textContent = (navigator.onLine ? 'Online' : 'Sin red') + ` · En cola (${n})`;
}
async function flushQueue(){
  if (!navigator.onLine) return;
  while(queueSize()){
    const it = dequeue();
    try{
      const res = await postForm(WEBAPP_URL, it);
      if (!res || res.ok!==true) throw new Error('falló');
      toast('Elemento de cola enviado ✓', 'ok');
    }catch(e){
      enqueue(it); break; // reintenta después
    }
  }
}
window.addEventListener('online', ()=>{ setNetStatus(true); flushQueue(); });
window.addEventListener('offline', ()=>{ setNetStatus(false); updateQueueBadge(); });
setNetStatus(navigator.onLine); updateQueueBadge(); flushQueue();

/* ===== Autocomplete CIE-10 ===== */
let acTimer = null;
$('#dx').addEventListener('input', (ev)=>{
  const q = ev.target.value.trim();
  acIndex = -1;
  if (acTimer) clearTimeout(acTimer);
  if (!q){ acWrap.style.display='none'; acWrap.innerHTML=''; return; }
  acTimer = setTimeout(async ()=>{
    try{
      const url = `${WEBAPP_URL}?cie10=1&q=${encodeURIComponent(q)}`;
      const res = await getJSON(url);
      acItems = (res && res.items) || [];
      renderAC(acItems);
    }catch(_){}
  }, 120);
});
$('#dx').addEventListener('keydown', ev=>{
  if (acWrap.style.display !== 'block') return;
  if (ev.key === 'ArrowDown'){ ev.preventDefault(); acMove(1); }
  else if (ev.key === 'ArrowUp'){ ev.preventDefault(); acMove(-1); }
  else if (ev.key === 'Enter'){ if (acIndex>=0){ ev.preventDefault(); acPick(acIndex); } }
  else if (ev.key === 'Escape'){ acHide(); }
});
function renderAC(items){
  acWrap.innerHTML = '';
  if (!items.length){ acHide(); return; }
  items.forEach((it, i)=>{
    const div = document.createElement('div');
    div.className = 'ac-item'; div.setAttribute('role','option'); div.setAttribute('id', 'ac-'+i);
    div.innerHTML = `<b>${it.code}</b> <small>${it.desc}</small>`;
    div.addEventListener('click', ()=> acPick(i));
    acWrap.appendChild(div);
  });
  acShow();
}
function acShow(){
  acWrap.style.display='block'; $('#dx').setAttribute('aria-expanded','true');
}
function acHide(){
  acWrap.style.display='none'; $('#dx').setAttribute('aria-expanded','false'); acIndex=-1;
}
function acMove(dir){
  const n = acWrap.children.length; if (!n) return;
  acIndex = (acIndex + dir + n) % n;
  [...acWrap.children].forEach((el,idx)=> el.setAttribute('aria-selected', idx===acIndex ? 'true':'false'));
}
function acPick(i){
  const it = acItems[i]; if (!it) return;
  $('#dx').value = it.code; acHide(); $('#obs').focus();
}

/* ===== Buscar último Dx por DNI ===== */
async function cargarUltimoDx(dni){
  if (!dni) return toast('Ingresá DNI para buscar Dx', 'bad');
  try{
    const url = `${WEBAPP_URL}?episodios=1&dni=${encodeURIComponent(dni)}`;
    const res = await getJSON(url);
    const items = (res && res.items) || [];
    const last = [...items].reverse().find(it => it.dx && it.dx.trim().length);
    if (last){ $('#dx').value = last.dx.trim().toUpperCase(); toast('Dx cargado desde historial ✓', 'ok'); }
    else toast('No se encontró Dx en historial', 'bad');
  }catch(e){ toast('Error consultando episodios', 'bad'); }
}
$('#btn-last-dx').addEventListener('click', ()=> cargarUltimoDx($('#dni').value.trim()));

/* ===== Guardar Ingreso ===== */
function busy(btn, on){
  btn.disabled = !!on;
  btn.dataset._label = btn.dataset._label || btn.textContent;
  btn.textContent = on ? 'Guardando…' : btn.dataset._label;
}
$('#form-ing').addEventListener('submit', ev=> ev.preventDefault());
$('#btn-save-ing').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const btn = ev.currentTarget; busy(btn,true);
  const payload = {
    tipo:'ing',
    DNI: $('#dni').value.trim(),
    Sexo: $('#sexo').value.trim(),
    FechaIngresoManual: $('#fecha-ing').value,
    HoraIngresoManual:  $('#hora-ing').value,
    IdeacionIntento: $('#ii').value,
    MetodoLetalidad: $('#metodo').value,
    Consumo: $('#consumo').value,
    TipoSustancia: $('#sust').value,
    Frecuencia: $('#freq').value,
    DxCIE10: $('#dx').value.trim(),
    Observaciones: $('#obs').value.trim(),
    AppVersion: 'v8-index'
  };

  try{
    if (!navigator.onLine){
      enqueue(payload);
      toast('Sin red: guardado en cola', 'bad');
      $('#status-ing').textContent = `Sin red. En cola (${queueSize()})`;
      return;
    }
    const out = await postForm(WEBAPP_URL, payload);
    if (out && out.ok){ toast(`Ingreso guardado (fila ${out.row})`, 'ok'); $('#status-ing').textContent = 'Ingreso guardado ✓'; }
    else throw new Error(out && out.message || 'Error');
  }catch(e){
    enqueue(payload);
    toast('Error de red. En cola para reintentar', 'bad');
  }finally{ busy(btn,false); flushQueue(); }
});

/* Atajo Ctrl+Enter = guardar ingreso */
window.addEventListener('keydown', (ev)=>{
  if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter' && !$('#panel-ing').hidden){
    $('#btn-save-ing').click();
  }
});

/* ===== Guardar Alta ===== */
$('#form-alt').addEventListener('submit', ev=> ev.preventDefault());
$('#btn-save-alt').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const btn = ev.currentTarget; busy(btn,true);
  const payload = {
    tipo:'alta',
    DNI: $('#dni-alt').value.trim(),
    Sexo: $('#sexo-alt').value.trim(),
    EstadoEgreso: $('#estado-egreso').value || 'Alta',
    FechaAltaManual: $('#fecha-alt').value,
    HoraAltaManual:  $('#hora-alt').value,
    // opcional: por compatibilidad, copio si están visibles:
    FechaIngresoManual: $('#fecha-ing').value,
    HoraIngresoManual:  $('#hora-ing').value,
    Observaciones: $('#obs-alt').value.trim(),
    AppVersion: 'v8-index'
  };
  try{
    if (!navigator.onLine){
      enqueue(payload);
      toast('Sin red: guardado en cola', 'bad');
      $('#status-alt').textContent = `Sin red. En cola (${queueSize()})`;
      return;
    }
    const out = await postForm(WEBAPP_URL, payload);
    if (out && out.ok){ toast(`Alta guardada (fila ${out.row})`, 'ok'); $('#status-alt').textContent = (out.mode==='update'?'Alta vinculada':'Alta insertada') + ' ✓'; }
    else throw new Error(out && out.message || 'Error');
  }catch(e){
    enqueue(payload);
    toast('Error de red. En cola para reintentar', 'bad');
  }finally{ busy(btn,false); flushQueue(); }
});

/* Buscar DNI (atajo para traer último Dx) */
$('#btn-buscar-dni').addEventListener('click', ()=> cargarUltimoDx($('#dni').value.trim()));
$('#btn-buscar-dni-alt').addEventListener('click', ()=> cargarUltimoDx($('#dni-alt').value.trim()));

/* Ping inicial (opcional) */
getJSON(WEBAPP_URL + '?ping=1').then(()=>{}).catch(()=>{});
</script>
</body>
</html>

