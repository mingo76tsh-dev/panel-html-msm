<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HSM v7 ‚Ä¢ M√≥vil</title>
<meta name="description" content="Carga de ingresos - HSM v7 m√≥vil" />
<style>
  :root{
    --bg:#0d1321; --panel:#141a2a; --chip:#2b3550;
    --txt:#e9f1ff; --muted:#bfd1ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --field:#1b2135; --accent:#3381ff; --accent-2:#1e40af;
    --radius:12px; --gap:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,Segoe UI,Roboto,Ubuntu,Arial}
  header{display:flex;align-items:center;gap:10px;padding:14px 18px;background:linear-gradient(180deg,#0f162a,#0c1324)}
  header .badge{background:#0f2a18;color:#9ff4c7;border-radius:999px;padding:3px 10px;font-size:12px}
  main{padding:16px}
  .card{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.28)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
  .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
  @media (max-width:900px){ .col-3,.col-4,.col-6{grid-column:span 12} }

  label{display:block;margin:6px 2px 6px 4px;color:var(--muted);font-size:12px}
  input,select,textarea{
    width:100%;background:var(--field);border:1px solid #223; color:var(--txt);
    border-radius:10px;padding:12px 12px;outline:none;
  }
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(51,129,255,.2)}
  .btn{background:#1c2a4a;border:1px solid #24345d;color:#dfe9ff;border-radius:999px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:#2152d9;border-color:#2c5cff}
  .btn.warn{background:#64410a;border-color:#7a520c}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:var(--chip);border-radius:999px;padding:8px 12px;font-size:13px}
  .hint{color:#9fb3ff;font-size:12px;margin-top:6px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #26304a;font-size:14px}
  th{text-align:left;color:#b9c8ff}
  .tag{padding:2px 8px;border-radius:999px;font-size:12px}
  .tag.pend{background:#3a2b08;color:#ffd27a}
  .tag.ok{background:#09321b;color:#86f3b8}
  .right{display:flex;gap:8px;justify-content:flex-end;align-items:center}
</style>
</head>
<body>
<header>
  <strong>üìä HSM v7 ‚Ä¢ M√≥vil</strong>
  <span id="net" class="badge">Online</span>
  <div class="right" style="margin-left:auto">
    <button id="btnCfg" class="btn">‚öôÔ∏è</button>
  </div>
</header>

<main class="card">
  <form id="frm" autocomplete="off">
    <div class="row">
      <div class="col-3">
        <label for="dni">DNI</label>
        <input id="dni" name="dni" inputmode="numeric" pattern="[0-9]{7,9}" placeholder="7‚Äì9 d√≠gitos" required />
        <div class="hint">Solo n√∫meros (sin puntos)</div>
      </div>

      <div class="col-3">
        <label for="sexo">Sexo</label>
        <select id="sexo" name="sexo">
          <option value="F">F</option><option value="M">M</option><option value="X">X</option>
        </select>
      </div>

      <div class="col-3">
        <label for="fec">Fecha ingreso</label>
        <input id="fec" name="fec" type="date" />
        <div class="hint">Formato enviado: yyyy-mm-dd</div>
      </div>
      <div class="col-3" style="display:flex;gap:8px;align-items:end">
        <button class="btn" type="button" id="btnHoy">Hoy</button>
        <div style="flex:1"></div>
      </div>

      <div class="col-3">
        <label for="hora">Hora ingreso</label>
        <input id="hora" name="hora" type="time" />
      </div>
      <div class="col-3" style="display:flex;gap:8px;align-items:end">
        <button class="btn" type="button" id="btnAhora">Ahora</button>
      </div>

      <div class="col-3">
        <label for="ide">Ideaci√≥n / Intento</label>
        <select id="ide"><option>Ideaci√≥n</option><option selected>Intento</option></select>
      </div>

      <div class="col-3">
        <label for="met">M√©todo / Letalidad</label>
        <select id="met">
          <option>‚Äî</option>
          <option>Intoxicaci√≥n</option>
          <option>Corte</option>
          <option>Colgamiento</option>
          <option>Arma de fuego</option>
          <option>Arrojo</option>
          <option>Otro</option>
        </select>
      </div>

      <div class="col-3">
        <label for="cons">Consumo</label>
        <select id="cons">
          <option>Niega</option><option>Alcohol</option><option>Drogas</option><option>Mixto</option>
        </select>
      </div>

      <div class="col-3">
        <label for="freq">Frecuencia</label>
        <select id="freq">
          <option>‚Äî</option><option>Diaria</option><option>Semanal</option><option>Ocasional</option>
        </select>
      </div>

      <div class="col-6">
        <label for="dx">Dx CIE-10 (c√≥digo)</label>
        <input id="dx" placeholder="Ej: F32.1" />
      </div>

      <div class="col-12">
        <label for="obs">Observaciones</label>
        <textarea id="obs" rows="4" placeholder="Notas‚Ä¶"></textarea>
        <div class="chips">
          <button class="btn chip" type="button" data-ins="Obs. SP">Obs. SP</button>
          <button class="btn chip" type="button" data-ins="Red apoyo ‚úì">Red apoyo ‚úì</button>
          <button class="btn chip" type="button" data-ins="Niega consumo">Niega consumo</button>
          <button class="btn chip" type="button" data-ins="Acompa√±ante">Acompa√±ante</button>
        </div>
      </div>

      <div class="col-12 right">
        <button class="btn primary" id="btnSave" type="submit">Guardar ingreso</button>
        <span id="pend" class="chip">Pend: 0</span>
      </div>
    </div>
  </form>

  <hr style="border:0;border-top:1px solid #27314a;margin:18px 0">

  <div class="right" style="margin-bottom:8px">
    <span class="hint">Se evita duplicar por DUPE_KEY = DNI | Fecha | Hora</span>
    <button id="btnRetry" class="btn">Reintentar todos</button>
    <button id="btnEmpty" class="btn warn">Vaciar cola</button>
  </div>

  <table id="tbl">
    <thead><tr><th>#</th><th>Tipo</th><th>DNI</th><th>Fecha</th><th>Hora</th><th>Estado</th></tr></thead>
    <tbody></tbody>
  </table>
</main>

<script>
/* ====== CONFIG ====== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw8396BPSyjySmmV5efuei721ET6YJamCNDFW3X3R7EaBHLOCFn_l1-ik2eGQyOalq66g/exec';
const API_KEY    = 'HSM2025KEY';
const APP_VER    = 'v7-m√≥vil';
const STORE_KEY  = 'HSMv7_QUEUE';

const $ = s => document.querySelector(s);
const fmt = n => String(n).padStart(2,'0');

function today(){ const d=new Date(); return `${d.getFullYear()}-${fmt(d.getMonth()+1)}-${fmt(d.getDate())}`; }
function now(){ const d=new Date(); return `${fmt(d.getHours())}:${fmt(d.getMinutes())}`; }

function loadQ(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }catch(_){ return []; } }
function saveQ(q){ localStorage.setItem(STORE_KEY, JSON.stringify(q)); paintQ(q); }

function dupeKey(dni, f, h){ return [String(dni||'').trim(), f, h].join('|'); }

function paintQ(q){
  $('#pend').textContent = 'Pend: ' + q.length;
  const tb = $('#tbl tbody'); tb.innerHTML = '';
  q.forEach((it,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${it.tipo}</td><td>${it.DNI}</td><td>${it.fecha}</td><td>${it.hora}</td>
      <td><span class="tag pend">pend</span></td>`;
    tb.appendChild(tr);
  });
}

function pushUnique(item){
  const q = loadQ();
  if (!q.find(x => x.DUPE_KEY === item.DUPE_KEY)) {
    q.push(item); saveQ(q);
  }
}

async function sendOne(item){
  // Request SIMPLE: form-urlencoded (evita preflight/CORS)
  const data = new URLSearchParams();
  data.set('key', API_KEY);
  data.set('data', JSON.stringify(item));   // servidor parsea e.parameter.data

  const res = await fetch(WEBAPP_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body: data.toString(),
    redirect: 'follow',
    cache: 'no-cache'
  }).catch(()=>null);

  if (!res) throw new Error('sin_respuesta');
  if (!res.ok) throw new Error('http_'+res.status);

  // Apps Script devuelve JSON (TextOutput)
  const txt = await res.text();
  try { const j = JSON.parse(txt); if (!j.ok) throw new Error(j.error||'srv'); } catch(_){}
  return true;
}

async function retryAll(){
  let q = loadQ();
  const left = [];
  for (const it of q){
    try { await sendOne(it); }
    catch(e){ left.push(it); }
  }
  saveQ(left);
}

function setOnline(v){ $('#net').textContent = v ? 'Online' : 'Offline'; }

/* ====== UI wiring ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Defaults
  $('#fec').value  = today();
  $('#hora').value = now();
  paintQ(loadQ());
  setOnline(navigator.onLine);

  $('#btnHoy').onclick = ()=> $('#fec').value = today();
  $('#btnAhora').onclick = ()=> $('#hora').value = now();

  // Chips ‚Üí insertan texto
  document.querySelectorAll('[data-ins]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const t = $('#obs');
      t.value = (t.value ? (t.value.trim() + ' ‚Ä¢ ') : '') + b.dataset.ins;
    });
  });

  $('#btnRetry').onclick = ()=> retryAll();
  $('#btnEmpty').onclick = ()=> saveQ([]);

  // Cola autom√°tica al recuperar conexi√≥n
  window.addEventListener('online', ()=>{ setOnline(true); retryAll(); });
  window.addEventListener('offline', ()=> setOnline(false) );

  // Submit
  $('#frm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const btn = $('#btnSave'); btn.disabled = true;

    const dni   = $('#dni').value.trim();
    const fecha = $('#fec').value;
    const hora  = $('#hora').value;

    const item = {
      tipo:'ing',
      DNI:dni,
      Sexo:$('#sexo').value,
      FechaIngresoManual:fecha,
      HoraIngresoManual:hora,
      IdeacionIntento:$('#ide').value,
      MetodoLetalidad:$('#met').value,
      Consumo:$('#cons').value,
      Frecuencia:$('#freq').value,
      DxCIE10:$('#dx').value.trim(),
      Observaciones:$('#obs').value.trim(),
      AppVersion:APP_VER,
      DUPE_KEY: dupeKey(dni, fecha || today(), hora || now())
    };

    // Evitar duplicado por error humano (multi-click)
    pushUnique(item);

    try {
      await sendOne(item);
      // si fue OK, sacar de cola
      const q = loadQ().filter(x => x.DUPE_KEY !== item.DUPE_KEY);
      saveQ(q);
    } catch(_) {
      // queda en pendientes; el banner informativo es la tabla
    } finally {
      btn.disabled = false;
    }
  });
});
</script>
</body>
</html>

