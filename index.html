<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HSM v7 Â· MÃ³vil</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0d1321; --panel:#141a2a; --chip:#2b3550; --ok:#22dd8f; --warn:#f59e0b; --err:#ef4444;
      --txt:#e9f1ff; --muted:#bdcff7; --ph:#afc2f5; --gap:14px; --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";}
    header{display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,.04));position:sticky;top:0;z-index:5}
    .app{display:flex;align-items:center;gap:10px;font-weight:700}
    .pill{padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfe3ff;font-weight:600}
    .ok{background:rgba(34,221,143,.15);color:#bfffe8;border:1px solid rgba(34,221,143,.35)}
    .btn{border:0;background:#1e2742;color:#dbe8ff;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-warn{background:#3a2b06;color:#ffd88a;border:1px solid rgba(245,158,11,.45)}
    .btn-danger{background:#35151a;color:#ffc7c7;border:1px solid rgba(239,68,68,.45)}
    .row{display:grid;gap:var(--gap)}
    .grid{display:grid;gap:var(--gap)}
    @media(min-width:980px){ .grid{grid-template-columns:repeat(3,1fr);} }
    main{padding:16px}
    section{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    label{display:block;margin:6px 0 4px;color:#cfe3ff}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0f1627;color:var(--txt)}
    input::placeholder,textarea::placeholder{color:var(--ph)}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chips .chip{background:var(--chip);border:1px solid rgba(189,207,247,.25);color:#cfe3ff;padding:6px 10px;border-radius:999px;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .muted{color:var(--muted);font-size:.9rem}
    .hint{font-size:.82rem;color:#a9bde8}
    nav.tabs{display:flex;gap:8px;margin:0 0 12px 0}
    nav .tab{background:#192240;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:999px;cursor:pointer}
    nav .tab.active{background:#263158}
    dialog{border:0;border-radius:14px;background:#0f1627;color:var(--txt);padding:0;max-width:520px;width:96%}
    dialog header{position:unset;box-shadow:none;border-radius:14px 14px 0 0}
    dialog .content{padding:16px}
    .foot{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid rgba(255,255,255,.06)}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <div class="app">ðŸ“Š HSM v7 Â· MÃ³vil</div>
    <span id="badgeNet" class="pill ok">Online</span>
    <nav class="tabs right" role="tablist" aria-label="Secciones">
      <button class="tab active" id="t-ing">Ingreso</button>
      <button class="tab" id="t-alta">Alta</button>
      <button class="tab" id="t-pend">Pendientes <span id="cntPend" class="pill" style="margin-left:6px">0</span></button>
      <button class="tab" id="t-util">Ãštiles</button>
    </nav>
    <button id="btnCfg" class="btn" aria-label="Config">âš™</button>
  </header>

  <main class="row">
    <!-- Ingreso -->
    <section id="sec-ing">
      <h3>Ingreso</h3>
      <div class="grid">
        <div>
          <label for="dni">DNI</label>
          <input id="dni" inputmode="numeric" pattern="[0-9]*" placeholder="7â€“9 dÃ­gitos" />
          <div class="hint">Solo nÃºmeros (sin puntos)</div>
        </div>

        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo">
            <option value="">â€”</option>
            <option>F</option><option>M</option><option>X</option>
          </select>
        </div>

        <div>
          <label for="fecIng">Fecha ingreso</label>
          <div class="inline">
            <input id="fecIng" type="date" />
            <button id="btnHoyIng" class="btn">Hoy</button>
          </div>
          <div class="hint">Formato enviado: yyyy-mm-dd</div>
        </div>

        <div>
          <label for="horIng">Hora ingreso</label>
          <div class="inline">
            <input id="horIng" type="time" step="60"/>
            <button id="btnAhoraIng" class="btn">Ahora</button>
          </div>
        </div>

        <div>
          <label for="idea">IdeaciÃ³n / Intento</label>
          <select id="idea">
            <option value="">â€”</option>
            <option>IdeaciÃ³n</option>
            <option>Intento</option>
          </select>
        </div>

        <div>
          <label for="metodo">MÃ©todo / Letalidad</label>
          <select id="metodo">
            <option value="">â€”</option>
            <option>IntoxicaciÃ³n</option>
            <option>Corte</option>
            <option>Colgamiento</option>
            <option>Arma de fuego</option>
            <option>Arrojo</option>
            <option>Otro</option>
          </select>
        </div>

        <div>
          <label for="consumo">Consumo</label>
          <select id="consumo">
            <option>Niega</option>
            <option>Ocasional</option>
            <option>Semanal</option>
            <option>Diaria</option>
          </select>
        </div>

        <div>
          <label for="freq">Frecuencia</label>
          <select id="freq">
            <option value="">â€”</option>
            <option>Ocasional</option>
            <option>Semanal</option>
            <option>Diaria</option>
          </select>
        </div>

        <div class="grid" style="grid-template-columns:1fr 2fr">
          <div>
            <label for="dx">Dx CIE-10 (cÃ³digo)</label>
            <input id="dx" placeholder="Ej: F32.1"/>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="chips inline">
              <span data-obs="Obs. SP" class="chip">Obs. SP</span>
              <span data-obs="Red apoyo âœ“" class="chip">Red apoyo âœ“</span>
              <span data-obs="Niega consumo" class="chip">Niega consumo</span>
              <span data-obs="AcompaÃ±ante" class="chip">AcompaÃ±ante</span>
            </div>
          </div>
        </div>

        <div style="grid-column:1/-1">
          <label for="obs">Observaciones</label>
          <textarea id="obs" rows="4" placeholder=""></textarea>
        </div>
      </div>

      <div class="inline" style="margin-top:12px">
        <button id="btnSendIng" class="btn">Guardar ingreso</button>
        <span class="pill" id="badgePendIng">Pend: 0</span>
        <span id="msgIng" class="muted"></span>
      </div>
    </section>

    <!-- Alta -->
    <section id="sec-alta" hidden>
      <h3>Alta</h3>
      <div class="grid">
        <div>
          <label for="dniA">DNI</label>
          <input id="dniA" inputmode="numeric" pattern="[0-9]*" placeholder="7â€“9 dÃ­gitos" />
        </div>
        <div>
          <label for="fecAlta">Fecha alta</label>
          <div class="inline">
            <input id="fecAlta" type="date"/>
            <button id="btnHoyAlta" class="btn">Hoy</button>
          </div>
          <div class="hint">Formato enviado: yyyy-mm-dd</div>
        </div>
        <div>
          <label for="horAlta">Hora alta</label>
          <div class="inline">
            <input id="horAlta" type="time" step="60"/>
            <button id="btnAhoraAlta" class="btn">Ahora</button>
          </div>
        </div>
        <div style="grid-column:1/-1">
          <label for="obsAlta">Observaciones (alta, derivaciÃ³n, indicaciones)</label>
          <textarea id="obsAlta" rows="4"></textarea>
        </div>
      </div>
      <div class="inline" style="margin-top:12px">
        <button id="btnSendAlta" class="btn">Guardar alta</button>
        <span id="msgAlta" class="muted"></span>
      </div>
    </section>

    <!-- Pendientes -->
    <section id="sec-pend" hidden>
      <h3>Pendientes</h3>
      <div class="inline" style="margin-bottom:8px">
        <span class="muted">Se evita duplicar por <b>DUPE_KEY = tipo | DNI | Fecha | Hora</b></span>
        <span class="right"></span>
        <button id="btnRetryAll" class="btn">Reintentar todos</button>
        <button id="btnClear" class="btn btn-warn">Vaciar cola</button>
      </div>
      <div style="overflow:auto">
        <table id="tblPend">
          <thead><tr><th>#</th><th>Tipo</th><th>DNI</th><th>Fecha</th><th>Hora</th><th>Estado</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Ãštiles -->
    <section id="sec-util" hidden>
      <h3>Ãštiles</h3>
      <p class="muted">Atajos rÃ¡pidos, exportaciones y diagnÃ³sticos.</p>
      <div class="inline">
        <button id="btnPing" class="btn">Probar WebApp</button>
        <span id="msgPing" class="muted"></span>
      </div>
    </section>
  </main>

  <!-- ConfiguraciÃ³n -->
  <dialog id="dlgCfg" aria-labelledby="cfg-title">
    <header>
      <div id="cfg-title" class="app">ConfiguraciÃ³n</div>
    </header>
    <div class="content">
      <label>WebApp URL (/exec)</label>
      <input id="cfgUrl" placeholder="https://script.google.com/macros/s/.../exec" />
      <label>API Key</label>
      <input id="cfgKey" placeholder="HSM2025KEY" />
      <label>Logo URL (opcional)</label>
      <input id="cfgLogo" placeholder="https://.../logo.png" />
      <p class="muted">El ping usa <code>GET</code>. Los envÃ­os usan <code>POST</code> sin headers (sin preflight).</p>
    </div>
    <div class="foot">
      <button class="btn" id="btnCfgPing">Probar</button>
      <span class="right"></span>
      <button class="btn" id="btnCfgClose">Cerrar</button>
      <button class="btn ok" id="btnCfgSave">Guardar</button>
    </div>
  </dialog>

  <script>
  /************* CONFIG LOCAL *************/
  const LS = {
    URL: 'HSM_URL',
    KEY: 'HSM_KEY',
    LOGO: 'HSM_LOGO',
    QUEUE: 'HSM_QUEUE_V1'
  };
  // Defaults (se pueden cambiar luego en âš™)
  const DEFAULTS = {
    url: 'https://script.google.com/macros/s/AKfycbw8396BPSyjySmmV5efuei721ET6YJamCNDFW3X3R7EaBHLOCFn_l1-ik2eGQyOalq66g/exec',
    key: 'HSM2025KEY'
  };

  function getCfg(){
    return {
      url: localStorage.getItem(LS.URL) || DEFAULTS.url,
      key: localStorage.getItem(LS.KEY) || DEFAULTS.key,
      logo: localStorage.getItem(LS.LOGO) || ''
    };
  }
  function setCfg({url,key,logo}){
    if (url) localStorage.setItem(LS.URL,url);
    if (key) localStorage.setItem(LS.KEY,key);
    if (logo!==undefined) localStorage.setItem(LS.LOGO,logo);
    paintCfg();
  }
  function paintCfg(){
    const {url,key,logo} = getCfg();
    qs('#cfgUrl').value = url;
    qs('#cfgKey').value = key;
    qs('#cfgLogo').value = logo;
  }

  /************* UI BÃSICA *************/
  const q  = (s,el=document)=>el.querySelector(s);
  const qa = (s,el=document)=>el.querySelectorAll(s);
  const qs = q;

  // Tabs
  function show(id){
    for (const sec of ['sec-ing','sec-alta','sec-pend','sec-util']) q('#'+sec).hidden = true;
    q('#'+id).hidden = false;
    qa('nav .tab').forEach(b=>b.classList.remove('active'));
    if (id==='sec-ing') q('#t-ing').classList.add('active');
    if (id==='sec-alta') q('#t-alta').classList.add('active');
    if (id==='sec-pend') q('#t-pend').classList.add('active');
    if (id==='sec-util') q('#t-util').classList.add('active');
  }
  q('#t-ing').onclick = ()=>show('sec-ing');
  q('#t-alta').onclick = ()=>show('sec-alta');
  q('#t-pend').onclick = ()=>{ refreshQueueTable(); show('sec-pend'); };
  q('#t-util').onclick = ()=>show('sec-util');

  // Hoy/Ahora
  const today = ()=> new Date().toISOString().slice(0,10);
  const nowHM = ()=> { const d=new Date(); return d.toTimeString().slice(0,5); };

  q('#btnHoyIng').onclick  = ()=> q('#fecIng').value  = today();
  q('#btnAhoraIng').onclick= ()=> q('#horIng').value  = nowHM();
  q('#btnHoyAlta').onclick = ()=> q('#fecAlta').value = today();
  q('#btnAhoraAlta').onclick=()=> q('#horAlta').value = nowHM();

  // Chips de Observaciones
  qa('.chips .chip').forEach(c=>c.onclick = ()=> {
    const val = c.getAttribute('data-obs') || c.textContent.trim();
    const ta  = q('#obs');
    ta.value = (ta.value? (ta.value.trim()+' Â· '):'') + val;
  });

  // Estado de red
  function paintNet(){ const b=q('#badgeNet'); b.textContent = navigator.onLine ? 'Online' : 'Offline'; b.className = 'pill ' + (navigator.onLine?'ok':''); }
  window.addEventListener('online', paintNet);
  window.addEventListener('offline', paintNet);
  paintNet();

  /************* COLA CON DEDUPE *************/
  function loadQ(){ try{ return JSON.parse(localStorage.getItem(LS.QUEUE)||'[]'); }catch(_){ return []; } }
  function saveQ(a){ localStorage.setItem(LS.QUEUE, JSON.stringify(a)); paintPendCount(); }
  function dupeKeyFrom(tipo,p){ return [tipo, p.DNI, (p.FechaIngresoManual||p.FechaAltaManual||''), (p.HoraIngresoManual||p.HoraAltaManual||'')].join('|'); }
  function upsertQ(item){
    const a = loadQ();
    const i = a.findIndex(x=>x.dupeKey===item.dupeKey);
    if (i>=0) a[i]=item; else a.push(item);
    saveQ(a);
  }
  function delQ(dupeKey){ saveQ(loadQ().filter(x=>x.dupeKey!==dupeKey)); }
  function paintPendCount(){ const n=loadQ().length; q('#cntPend').textContent = n; q('#badgePendIng').textContent='Pend: '+n; }

  function refreshQueueTable(){
    const tb = q('#tblPend tbody'); tb.innerHTML='';
    loadQ().forEach((x,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${x.tipo}</td><td>${x.DNI||''}</td><td>${x.fecha||''}</td><td>${x.hora||''}</td><td>${x.estado||'pend'}</td>`;
      tb.appendChild(tr);
    });
  }
  paintPendCount();

  /************* API (sin preflight) *************/
  async function apiPing(){
    const {url} = getCfg();
    const r = await fetch(url, { method:'GET' }); // doGet ping
    return r.json();
  }
  async function apiSend(tipo, payload){
    const {url,key} = getCfg();
    // âš ï¸ Sin headers, sin Content-Type. API key en el body.
    const r = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({ apiKey: key, origin: location.origin, type: tipo, payload })
    });
    // Si el preflight no existe, doPost responde JSON
    return r.json();
  }

  /************* LECTURA FORM *************/
  function readIngreso(){
    return {
      DNI: (q('#dni').value||'').trim(),
      Sexo: q('#sexo').value,
      FechaIngresoManual: q('#fecIng').value,
      HoraIngresoManual: q('#horIng').value,
      IdeacionIntento: q('#idea').value,
      MetodoLetalidad: q('#metodo').value,
      Consumo: q('#consumo').value,
      Frecuencia: q('#freq').value,
      DxCIE10: (q('#dx').value||'').trim(),
      Observaciones: (q('#obs').value||'').trim(),
      AppVersion: 'v7-mÃ³vil'
    };
  }
  function readAlta(){
    return {
      DNI: (q('#dniA').value||'').trim(),
      FechaAltaManual: q('#fecAlta').value,
      HoraAltaManual: q('#horAlta').value,
      Observaciones: (q('#obsAlta').value||'').trim(),
      AppVersion: 'v7-mÃ³vil'
    };
  }
  function basicValidate(p, campos){
    for (const c of campos){
      const v = (p[c]||'').trim();
      if (!v) throw new Error('falta_'+c);
    }
  }

  /************* ENVÃOS con bloqueo y DEDUPE *************/
  let inFlightIng = false, inFlightAlta = false;

  q('#btnSendIng').onclick = async ()=>{
    if (inFlightIng) return;
    const btn = q('#btnSendIng'); const msg = q('#msgIng'); msg.textContent='';
    try{
      const p = readIngreso();
      basicValidate(p, ['DNI','FechaIngresoManual','HoraIngresoManual']);
      const item = {
        tipo:'ing', DNI:p.DNI, fecha:p.FechaIngresoManual, hora:p.HoraIngresoManual,
        dupeKey: dupeKeyFrom('ing', p), estado:'pend', payload:p
      };
      upsertQ(item); refreshQueueTable();

      inFlightIng = true; btn.disabled = true;
      const res = await apiSend('ing', p);
      if (!res || !res.ok) throw new Error(res && res.error || 'api_error');
      delQ(item.dupeKey); refreshQueueTable();
      msg.textContent = 'Ingreso enviado âœ”'; msg.style.color='#bfffe8';
    }catch(e){
      msg.textContent = 'Sin conexiÃ³n o error: quedÃ³ en pendientes';
      msg.style.color = '#ffd88a';
    }finally{
      inFlightIng = false; btn.disabled = false; paintPendCount();
    }
  };

  q('#btnSendAlta').onclick = async ()=>{
    if (inFlightAlta) return;
    const btn = q('#btnSendAlta'); const msg = q('#msgAlta'); msg.textContent='';
    try{
      const p = readAlta();
      basicValidate(p, ['DNI','FechaAltaManual','HoraAltaManual']);
      const item = {
        tipo:'alta', DNI:p.DNI, fecha:p.FechaAltaManual, hora:p.HoraAltaManual,
        dupeKey: dupeKeyFrom('alta', p), estado:'pend', payload:p
      };
      upsertQ(item); refreshQueueTable();

      inFlightAlta = true; btn.disabled = true;
      const res = await apiSend('alta', p);
      if (!res || !res.ok) throw new Error(res && res.error || 'api_error');
      delQ(item.dupeKey); refreshQueueTable();
      msg.textContent = 'Alta enviada âœ”'; msg.style.color='#bfffe8';
    }catch(e){
      msg.textContent = 'Sin conexiÃ³n o error: quedÃ³ en pendientes';
      msg.style.color = '#ffd88a';
    }finally{
      inFlightAlta = false; btn.disabled = false; paintPendCount();
    }
  };

  // Reintentar y Vaciar
  q('#btnRetryAll').onclick = async ()=>{
    const arr = loadQ();
    for (const it of arr.slice()){
      try{
        const p = it.payload;
        const res = await apiSend(it.tipo, p);
        if (res && res.ok) delQ(it.dupeKey);
      }catch(_){}
    }
    refreshQueueTable(); paintPendCount();
  };
  q('#btnClear').onclick = ()=>{
    if (!confirm('Â¿Vaciar cola pendiente?')) return;
    saveQ([]); refreshQueueTable(); paintPendCount();
  };

  /************* CONFIG / PING *************/
  const dlg = q('#dlgCfg');
  q('#btnCfg').onclick = ()=>{ paintCfg(); dlg.showModal(); };
  q('#btnCfgClose').onclick = ()=> dlg.close();
  q('#btnCfgSave').onclick = ()=>{
    setCfg({ url: q('#cfgUrl').value.trim(), key: q('#cfgKey').value.trim(), logo: q('#cfgLogo').value.trim() });
    dlg.close();
  };
  q('#btnCfgPing').onclick = async ()=>{
    const el = q('#cfgUrl'); const url = el.value.trim(); if (!url) return;
    try{
      const r = await fetch(url, {method:'GET'}); const j = await r.json();
      alert('PING OK: '+JSON.stringify(j));
    }catch(e){ alert('PING ERROR: '+e); }
  };

  q('#btnPing').onclick = async ()=>{
    const span = q('#msgPing'); span.textContent='â€¦';
    try{ const j = await apiPing(); span.textContent = 'Ping OK: '+(j && j.ok ? 'ok:true' : 'respuesta invÃ¡lida'); }
    catch(e){ span.textContent = 'Ping ERROR (ver URL en âš™)'; }
  };

  /************* VALORES POR DEFECTO *************/
  // Pre-cargar fecha y hora
  q('#fecIng').value = today();  q('#horIng').value = nowHM();
  q('#fecAlta').value = today(); q('#horAlta').value = nowHM();
  paintCfg();
  </script>
</body>
</html>
