<!doctype html>
<html lang="es" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="theme-color" content="#0b1220"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>HSM v7 • Móvil</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --mut:#94a3b8;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --acc:#60a5fa;
      --field:#0b1329; --bd:#1f2a44; --chip:#1f2937; --shadow:0 8px 28px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;-webkit-tap-highlight-color:transparent}
    .wrap{max-width:920px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .header{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--bd)}
    .header .title{font-weight:800; letter-spacing:.3px}
    .header .sp{flex:1}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;font-size:12px;background:rgba(148,163,184,.16);color:#cbd5e1;border:1px solid var(--bd)}
    .badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
    .badge.off{background:rgba(148,163,184,.12);color:#94a3b8}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--acc);color:#031532}
    .btn.sec{background:#1f2937;color:#d1d5db}
    .btn.warn{background:var(--warn);color:#051019}
    .btn.ghost{background:transparent;border:1px solid var(--bd);color:#cbd5e1}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }
    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    input,select,textarea{
      width:100%; background:var(--field); color:var(--ink);
      border:1px solid var(--bd); border-radius:12px; padding:11px 12px; outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.25)}
    textarea{min-height:90px;resize:vertical}
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--bd);padding:10px 10px 0}
    .tab{padding:8px 12px;border-radius:9px 9px 0 0;background:#111a2c;border:1px solid var(--bd);border-bottom:0;color:#cbd5e1;cursor:pointer;font-weight:700}
    .tab[aria-selected="true"]{background:var(--card);color:#fff}
    .view{padding:12px}
    .kv{display:flex; gap:8px; align-items:center}
    .kv input{flex:1}
    .st{margin-top:10px;font-size:13px}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .mut{color:#94a3b8}
    .logo{height:44px; width:auto; object-fit:contain; border-radius:8px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:var(--chip); border:1px solid var(--bd); color:#d1d5db; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer}
    .grid{display:grid; gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .list{border:1px solid var(--bd); border-radius:12px; overflow:hidden}
    .item{display:flex;gap:12px; padding:10px 12px; border-bottom:1px solid var(--bd); align-items:center}
    .item:last-child{border-bottom:0}
    .small{font-size:12px;color:var(--mut)}
    hr{border:0;border-top:1px solid var(--bd); margin:14px 0}
    .hint{font-size:12px;color:#cbd5e1}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,23,42,.96);color:#e5e7eb;border:1px solid var(--bd);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;display:none}
    .focus-ring:focus-visible{outline:2px solid #3b82f6; outline-offset:2px}
    @media (prefers-reduced-motion:reduce){ *{scroll-behavior:auto} }
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="header">
      <img id="logo" class="logo" alt="Logo del hospital" src="" hidden>
      <div class="title">HSM v7 • Móvil</div>
      <span id="online" class="badge off" aria-live="polite">Offline</span>
      <span class="sp"></span>
      <button id="btnInstall" class="btn sec focus-ring" type="button" style="display:none">Instalar</button>
      <button id="btnUpdate" class="btn warn focus-ring" type="button" style="display:none">Nueva versión — Actualizar</button>
      <button id="btnCfg" class="btn sec focus-ring" type="button" aria-label="Configuración">⚙️</button>
    </div>

    <!-- NAV TABS (accesibles) -->
    <div class="tabs" role="tablist" aria-label="Secciones">
      <button class="tab focus-ring" role="tab" aria-selected="true" aria-controls="v-ing" id="t-ing" data-v="ing">Ingreso</button>
      <button class="tab focus-ring" role="tab" aria-selected="false" aria-controls="v-alta" id="t-alta" data-v="alta">Alta</button>
      <button class="tab focus-ring" role="tab" aria-selected="false" aria-controls="v-pend" id="t-pend" data-v="pend">Pendientes</button>
      <button class="tab focus-ring" role="tab" aria-selected="false" aria-controls="v-util" id="t-util" data-v="util">Útiles</button>
    </div>

    <!-- INGRESO -->
    <section id="v-ing" class="view" role="tabpanel" aria-labelledby="t-ing">
      <div class="row">
        <div>
          <label for="i_dni">DNI</label>
          <div class="kv">
            <input id="i_dni" inputmode="numeric" pattern="^\d{7,9}$" minlength="7" maxlength="9" autocomplete="off" placeholder="7–9 dígitos" aria-describedby="dniHelp">
            <button class="btn sec focus-ring" id="dniCam" type="button">Cargar</button>
          </div>
          <div id="dniHelp" class="small mut">Solo números (7–9 dígitos).</div>
        </div>
        <div>
          <label for="i_sexo">Sexo</label>
          <select id="i_sexo" autocomplete="sex">
            <option value="">—</option><option>M</option><option>F</option><option>X</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="i_fi">Fecha ingreso</label>
          <div class="kv">
            <input id="i_fi" type="date" autocomplete="off"><button class="btn sec focus-ring" id="iFiNow" type="button">Ahora</button>
          </div>
        </div>
        <div>
          <label for="i_hi">Hora ingreso</label>
          <div class="kv">
            <input id="i_hi" type="time" autocomplete="off"><button class="btn sec focus-ring" id="iHiNow" type="button">Ahora</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="i_ii">Ideación / Intento</label>
          <select id="i_ii"><option value="">—</option><option>Ideación</option><option>Intento</option></select>
        </div>
        <div>
          <label for="i_met">Método / Letalidad</label>
          <select id="i_met">
            <option value="">—</option>
            <option>Intoxicación</option><option>Corte</option><option>Colgamiento</option>
            <option>Arma de fuego</option><option>Arrojo</option><option>Otro</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="i_con">Consumo</label>
          <select id="i_con"><option value="">—</option><option>Sí</option><option>No</option></select>
        </div>
        <div>
          <label for="i_sus">Tipo Sustancia</label>
          <select id="i_sus"><option value=""></option><option>Alcohol</option><option>BZD</option><option>Opioides</option><option>Cocaína</option><option>THC</option><option>Mixto</option></select>
        </div>
      </div>

      <label for="i_cie">Dx CIE-10 (código)</label>
      <input id="i_cie" list="cie-list" placeholder="Ej: F32.1" autocomplete="off">
      <datalist id="cie-list"></datalist>

      <label for="i_obs">Observaciones</label>
      <textarea id="i_obs" placeholder="Notas breves (opcional)" autocomplete="off"></textarea>
      <div class="chips" id="tpls" aria-label="Plantillas rápidas">
        <button class="chip focus-ring" type="button" data-t="+Observación breve sin particularidades.">Obs. SP</button>
        <button class="chip focus-ring" type="button" data-t="+Se informa red de apoyo presente.">Red apoyo ✓</button>
        <button class="chip focus-ring" type="button" data-t="+Niega consumo reciente.">Niega consumo</button>
        <button class="chip focus-ring" type="button" data-t="+Acompañante en guardia.">Acompañante</button>
      </div>

      <div id="ingMsg" class="st mut" role="status" aria-live="polite"></div>
      <div class="kv" style="margin-top:12px; gap:10px; flex-wrap:wrap">
        <button class="btn focus-ring" id="ingSave" type="button">Guardar ingreso</button>
        <button class="btn ghost focus-ring" id="ingShare" type="button">Compartir comprobante</button>
      </div>
      <div class="small">Tip: admite <code>?dni=&amp;sexo=&amp;fi=YYYY-MM-DD</code> para prellenar.</div>
    </section>

    <!-- ALTA -->
    <section id="v-alta" class="view" role="tabpanel" aria-labelledby="t-alta" hidden>
      <div class="row">
        <div>
          <label for="a_dni">DNI</label>
          <input id="a_dni" inputmode="numeric" pattern="^\d{7,9}$" minlength="7" maxlength="9" placeholder="7–9 dígitos" autocomplete="off">
        </div>
        <div>
          <label for="a_fn">Fecha Nac. (opcional)</label>
          <input id="a_fn" type="date" autocomplete="bday">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="a_sexo">Sexo</label>
          <select id="a_sexo" autocomplete="sex"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
        </div>
        <div>
          <label>Buscar ingreso</label>
          <div class="kv">
            <button class="btn sec focus-ring" id="aSearch" type="button">Buscar por DNI</button>
            <span id="aFound" class="hint" role="status" aria-live="polite"></span>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="a_fa">Fecha alta</label>
          <div class="kv">
            <input id="a_fa" type="date" autocomplete="off"><button class="btn sec focus-ring" id="aFaNow" type="button">Ahora</button>
          </div>
        </div>
        <div>
          <label for="a_ha">Hora alta</label>
          <div class="kv">
            <input id="a_ha" type="time" autocomplete="off"><button class="btn sec focus-ring" id="aHaNow" type="button">Ahora</button>
          </div>
        </div>
      </div>

      <label for="a_estado">Estado</label>
      <select id="a_estado">
        <option>Alta</option><option>Derivación</option><option>Fuga</option><option>Traslado</option><option>Óbito</option>
      </select>

      <label for="a_obs">Observaciones</label>
      <textarea id="a_obs" placeholder="Breve detalle (opcional)"></textarea>

      <div id="altaMsg" class="st mut" role="status" aria-live="polite"></div>
      <div class="kv" style="margin-top:12px; gap:10px; flex-wrap:wrap">
        <button class="btn focus-ring" id="altaSave" type="button">Guardar alta</button>
        <button class="btn ghost focus-ring" id="altaShare" type="button">Compartir comprobante</button>
      </div>
    </section>

    <!-- PENDIENTES -->
    <section id="v-pend" class="view" role="tabpanel" aria-labelledby="t-pend" hidden>
      <div class="kv" style="gap:8px; flex-wrap:wrap">
        <button class="btn sec focus-ring" id="flush" type="button">Enviar pendientes</button>
        <button class="btn ghost focus-ring" id="exp" type="button">Exportar JSON</button>
        <input id="impFile" type="file" accept="application/json" hidden>
        <button class="btn ghost focus-ring" id="imp" type="button">Importar JSON</button>
        <span id="pendInfo" class="badge off" aria-live="polite">0</span>
      </div>
      <hr/>
      <div class="list" id="pendList"></div>
    </section>

    <!-- ÚTILES -->
    <section id="v-util" class="view" role="tabpanel" aria-labelledby="t-util" hidden>
      <div class="grid grid2">
        <div class="card" style="padding:12px">
          <b>Escáner rápido (DNI)</b><br>
          <div class="small">Usá la cámara/teclado del celular para pegar/teclear DNI y validar.</div>
          <div class="kv" style="margin-top:8px">
            <input id="u_dni" inputmode="numeric" pattern="^\d{7,9}$" placeholder="DNI">
            <button class="btn sec focus-ring" id="uVal" type="button">Validar</button>
          </div>
          <div id="u_res" class="st mut" role="status" aria-live="polite"></div>
        </div>
        <div class="card" style="padding:12px">
          <b>Atajos</b>
          <div class="chips" style="margin-top:8px">
            <button class="chip focus-ring" type="button" data-go="ing">Ir a Ingreso</button>
            <button class="chip focus-ring" type="button" data-go="alta">Ir a Alta</button>
            <button class="chip focus-ring" type="button" data-go="pend">Ver Pendientes</button>
          </div>
          <hr>
          <div class="small">Versión app: <span id="vver">v7-móvil</span></div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- CONFIG -->
<dialog id="cfg" style="border:1px solid var(--bd); border-radius:16px; background:#0f172a; color:#e5e7eb; max-width:560px; width:92%">
  <form method="dialog" style="padding:14px">
    <h3 style="margin:0 0 10px">Configuración</h3>
    <label for="cfg_url">WebApp URL (/exec)</label>
    <input id="cfg_url" placeholder="https://script.google.com/macros/s/.../exec" autocomplete="off" class="focus-ring">
    <label for="cfg_key">API Key</label>
    <input id="cfg_key" placeholder="Si está activa" autocomplete="off" class="focus-ring">
    <label for="cfg_logo">Logo URL (png/jpg/svg)</label>
    <input id="cfg_logo" placeholder="https://.../logo.png" autocomplete="off" class="focus-ring">
    <div class="kv" style="margin-top:10px; gap:8px">
      <button class="btn sec focus-ring" id="cfgTest" type="button">Probar</button>
      <button class="btn focus-ring" type="submit">Guardar</button>
    </div>
    <div id="cfgMsg" class="small" style="margin-top:8px" role="status" aria-live="polite"></div>
  </form>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== LocalStorage helper ===== */
const LS={get(k,d=null){try{const v=localStorage.getItem(k);return v==null?d:JSON.parse(v)}catch(_){return localStorage.getItem(k)||d}},
          set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(_){localStorage.setItem(k,v)}},
          del(k){localStorage.removeItem(k)}};
const $=s=>document.querySelector(s);
const fmtDate=ts=>new Date(ts).toLocaleString();
const vibrate = p=>('vibrate' in navigator)&&navigator.vibrate(p);

/* ===== API con timeout ===== */
function timeoutFetch(resource, options = {}, ms = 10000){
  const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort('timeout'), ms);
  return fetch(resource,{...options,signal:ctrl.signal}).finally(()=>clearTimeout(id));
}
const API={url(){return LS.get('HSM_WEBAPP_URL','')},
           key(){return LS.get('HSM_API_KEY','')},
           async call(action,payload={}){
             const u=API.url(); if(!u) throw new Error('Sin URL configurada');
             const body={action,apiKey:API.key(), ...payload};
             const r=await timeoutFetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}, 12000);
             if(!r.ok) throw new Error('HTTP '+r.status);
             return r.json();
           }};

/* ===== Toast ===== */
function toast(txt,ms=2200){const t=$("#toast");t.textContent=txt;t.style.display='block';setTimeout(()=>t.style.display='none',ms)}

/* ===== Service Worker + actualización ===== */
let _deferredPrompt=null, _newWorker=null;
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').then(reg=>{
    reg.addEventListener('updatefound',()=>{
      _newWorker = reg.installing;
      _newWorker.addEventListener('statechange',()=>{
        if(_newWorker.state==='installed' && navigator.serviceWorker.controller){
          $('#btnUpdate').style.display='inline-block';
        }
      });
    });
  }).catch(()=>{}));

  navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
}
$('#btnUpdate').onclick=()=>{ if(_newWorker) _newWorker.postMessage({type:'SKIP_WAITING'}); };

/* ===== Instalación PWA ===== */
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();_deferredPrompt=e;$('#btnInstall').style.display='inline-block';});
$('#btnInstall').onclick=async()=>{ if(!_deferredPrompt) return; _deferredPrompt.prompt(); await _deferredPrompt.userChoice; _deferredPrompt=null; $('#btnInstall').style.display='none';};

/* ===== Estado online ===== */
function setOnline(ok){const b=$('#online');b.textContent=ok?'Online':'Offline';b.className='badge '+(ok?'ok':'off')}
window.addEventListener('online',()=>setOnline(true));
window.addEventListener('offline',()=>setOnline(false));
setOnline(navigator.onLine);

/* ===== Logo ===== */
function applyLogo(){ const u=LS.get('HSM_LOGO_URL',''), el=$('#logo'); if(u){ el.src=u; el.hidden=false; } else { el.hidden=true; } }

/* ===== Tabs accesibles ===== */
const tabs=[...document.querySelectorAll('[role="tab"]')];
function activateTab(btn){
  tabs.forEach(t=>{t.setAttribute('aria-selected', String(t===btn)); const v=t.dataset.v; const vp=$('#v-'+v); const hide=(t!==btn); vp.hidden=hide; });
  if(btn.dataset.v==='pend') renderPend();
}
tabs.forEach(t=>{
  t.addEventListener('click',()=>activateTab(t));
  t.addEventListener('keydown',e=>{
    const i=tabs.indexOf(t);
    if(e.key==='ArrowRight'){ (tabs[i+1]||tabs[0]).focus(); }
    if(e.key==='ArrowLeft'){ (tabs[i-1]||tabs[tabs.length-1]).focus(); }
    if(e.key==='Home'){ tabs[0].focus(); }
    if(e.key==='End'){ tabs[tabs.length-1].focus(); }
  });
});

/* ===== Helpers fechas ===== */
const nowDate=()=>new Date().toISOString().slice(0,10);
const nowTime=()=>new Date().toTimeString().slice(0,5);
$('#iFiNow').onclick=()=>$('#i_fi').value=nowDate();
$('#iHiNow').onclick=()=>$('#i_hi').value=nowTime();
$('#aFaNow').onclick=()=>$('#a_fa').value=nowDate();
$('#aHaNow').onclick=()=>$('#a_ha').value=nowTime();

/* ===== Chips (observaciones) ===== */
$('#tpls').addEventListener('click',e=>{const t=e.target.closest('.chip'); if(!t) return; $('#i_obs').value=(($('#i_obs').value||'')+' '+t.dataset.t).trim(); $('#i_obs').focus();});

/* ===== Validaciones ===== */
const validDNI=v=>/^\d{7,9}$/.test((v||'').trim());

/* ===== Outbox ===== */
const boxGet=()=>LS.get('HSM_OUTBOX',[]);
function boxSet(a){ LS.set('HSM_OUTBOX',a); const n=a.length; $('#pendInfo').textContent=n; $('#pendInfo').className='badge '+(n?'ok':'off'); }
async function boxFlush(){
  const box=boxGet(); if(!box.length){ toast('No hay pendientes'); return; }
  $('#pendInfo').textContent='…';
  const rest=[];
  for(const it of box){
    try{
      if(it.kind==='ingreso') await API.call('save',{payload:it.payload});
      if(it.kind==='alta')    await API.call('alta',{payload:it.payload});
    }catch(_){ rest.push(it); }
  }
  boxSet(rest);
  toast(rest.length?('Quedan '+rest.length+' pendientes'): 'Pendientes enviados ✔');
  renderPend();
}
$('#flush').onclick=boxFlush;
$('#exp').onclick=()=>{ const a=document.createElement('a'); a.download='hsm_outbox.json'; a.href=URL.createObjectURL(new Blob([JSON.stringify(boxGet())],{type:'application/json'})); a.click(); };
$('#imp').onclick=()=>$('#impFile').click();
$('#impFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{ try{ const arr=JSON.parse(rd.result||'[]'); boxSet(boxGet().concat(arr)); renderPend(); toast('Importado'); }catch(_){ toast('Archivo inválido',2600) } };
  rd.readAsText(f);
};
function renderPend(){
  const box=boxGet(), el=$('#pendList'); el.innerHTML='';
  if(!box.length){ el.innerHTML='<div class="item"><span class="mut">No hay pendientes.</span></div>'; return; }
  box.forEach((it,ix)=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<div class="small">${it.kind.toUpperCase()}</div>
      <div>DNI <b>${it.payload.DNI||'?'}</b> • ${fmtDate(it.ts)}</div>
      <span class="sp"></span>
      <button class="btn ghost focus-ring" data-i="${ix}" type="button">Borrar</button>`;
    el.appendChild(d);
  });
  el.onclick=e=>{ const b=e.target.closest('button'); if(!b) return; const idx=+b.dataset.i; const box=boxGet(); box.splice(idx,1); boxSet(box); renderPend(); };
}

/* ===== Anti-duplicado simple (misma acción + DNI + 60s) ===== */
const recentKey=(k,d)=>`HSM_REC_${k}_${d}`;
const dedupeSet=(k,d)=>LS.set(recentKey(k,d), Date.now());
const dedupeHit=(k,d,ms=60000)=> (Date.now()-(LS.get(recentKey(k,d),0)))<ms;

/* ===== Autosave (borradores locales) ===== */
const DRAFT_ING='HSM_DRAFT_ING', DRAFT_ALTA='HSM_DRAFT_ALTA';
const saveDraft=(id,fields)=>{ const o={}; fields.forEach(f=>o[f]=$('#'+f).value); LS.set(id,o); };
const loadDraft=(id,fields)=>{ const o=LS.get(id,null); if(!o) return; fields.forEach(f=>{ if(o[f]!=null) $('#'+f).value=o[f]; }); };
['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs'].forEach(id=>$('#'+id).addEventListener('input',()=>saveDraft(DRAFT_ING,['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs'])));
['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs'].forEach(id=>$('#'+id).addEventListener('input',()=>saveDraft(DRAFT_ALTA,['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs'])));

/* ===== Ingreso ===== */
let lastReceipt=null;
$('#ingSave').onclick=async ()=>{
  try{
    const dni=$('#i_dni').value.trim();
    if(!validDNI(dni)){ $('#ingMsg').textContent='DNI inválido'; $('#ingMsg').className='st err'; vibrate(200); return; }
    if(dedupeHit('ing',dni)){ toast('Ingreso enviado hace instantes'); return; }

    const payload={
      DNI:dni, Sexo:$('#i_sexo').value,
      FechaIngresoManual:$('#i_fi').value, HoraIngresoManual:$('#i_hi').value,
      IdeacionIntento:$('#i_ii').value, MetodoLetalidad:$('#i_met').value,
      Consumo:$('#i_con').value, TipoSustancia:$('#i_sus').value,
      DxProvisorio_CIE10:$('#i_cie').value, Observaciones:$('#i_obs').value
    };
    $('#ingMsg').textContent='Guardando…'; $('#ingMsg').className='st mut';
    const j=await API.call('save',{payload});
    if(j&&j.ok){
      $('#ingMsg').textContent='Guardado ✔'; $('#ingMsg').className='st ok';
      lastReceipt={kind:'Ingreso',dni,ts:Date.now()};
      dedupeSet('ing',dni); LS.del(DRAFT_ING); vibrate([60,40,60]);
    } else throw new Error(j&&j.message||'desconocido');
  }catch(e){
    const it={kind:'ingreso',payload:{
      DNI:$('#i_dni').value.trim(), Sexo:$('#i_sexo').value,
      FechaIngresoManual:$('#i_fi').value, HoraIngresoManual:$('#i_hi').value,
      IdeacionIntento:$('#i_ii').value, MetodoLetalidad:$('#i_met').value,
      Consumo:$('#i_con').value, TipoSustancia:$('#i_sus').value,
      DxProvisorio_CIE10:$('#i_cie').value, Observaciones:$('#i_obs').value
    }, ts:Date.now()};
    const box=boxGet(); box.push(it); boxSet(box);
    $('#ingMsg').textContent='Sin red. Guardado en pendientes ('+box.length+')'; $('#ingMsg').className='st err'; vibrate(150);
  }
};
$('#ingShare').onclick=()=>{ const txt = lastReceipt? `HSM • ${lastReceipt.kind} DNI ${lastReceipt.dni} • ${fmtDate(lastReceipt.ts)}` : 'HSM • Ingreso registrado'; if(navigator.share) navigator.share({text:txt}).catch(()=>{}); else navigator.clipboard.writeText(txt).then(()=>toast('Copiado')); };

/* ===== Alta ===== */
$('#aSearch').onclick=async ()=>{
  try{
    const dni=$('#a_dni').value.trim(); if(!validDNI(dni)){ $('#aFound').textContent=' DNI inválido'; return; }
    $('#aFound').textContent=' Buscando…';
    const j=await API.call('find',{dni, days:120}).catch(()=>null);
    if(j && j.ok && j.row){ $('#aFound').textContent=' Encontrado (fila '+j.row+')'; if(j.sexo) $('#a_sexo').value=(j.sexo||'').toUpperCase(); }
    else { $('#aFound').textContent=' No hallado (continuar manual)'; }
  }catch(_){ $('#aFound').textContent=' Offline (buscará al enviar)'; }
};
$('#altaSave').onclick=async ()=>{
  try{
    const dni=$('#a_dni').value.trim();
    if(!validDNI(dni)){ $('#altaMsg').textContent='DNI inválido'; $('#altaMsg').className='st err'; vibrate(200); return; }
    if(dedupeHit('alta',dni)){ toast('Alta enviada hace instantes'); return; }

    const payload={
      DNI:dni, Sexo:$('#a_sexo').value,
      FechaAltaManual:$('#a_fa').value, HoraAltaManual:$('#a_ha').value,
      EstadoEgreso:$('#a_estado').value, Observaciones:$('#a_obs').value
    };
    $('#altaMsg').textContent='Guardando…'; $('#altaMsg').className='st mut';
    const j=await API.call('alta',{payload});
    if(j&&j.ok){
      $('#altaMsg').textContent='Alta guardada ✔'; $('#altaMsg').className='st ok';
      lastReceipt={kind:'Alta',dni,ts:Date.now()};
      dedupeSet('alta',dni); LS.del(DRAFT_ALTA); vibrate([60,40,60]);
    } else throw new Error(j&&j.message||'desconocido');
  }catch(e){
    const it={kind:'alta',payload:{
      DNI:$('#a_dni').value.trim(), Sexo:$('#a_sexo').value,
      FechaAltaManual:$('#a_fa').value, HoraAltaManual:$('#a_ha').value,
      EstadoEgreso:$('#a_estado').value, Observaciones:$('#a_obs').value
    }, ts:Date.now()};
    const box=boxGet(); box.push(it); boxSet(box);
    $('#altaMsg').textContent='Sin red. Guardado en pendientes ('+box.length+')'; $('#altaMsg').className='st err'; vibrate(150);
  }
};
$('#altaShare').onclick=()=>{ const txt = lastReceipt? `HSM • ${lastReceipt.kind} DNI ${lastReceipt.dni} • ${fmtDate(lastReceipt.ts)}` : 'HSM • Alta registrada'; if(navigator.share) navigator.share({text:txt}).catch(()=>{}); else navigator.clipboard.writeText(txt).then(()=>toast('Copiado')); };

/* ===== Config ===== */
$('#btnCfg').onclick=()=>{ $('#cfg_url').value=API.url()||''; $('#cfg_key').value=API.key()||''; $('#cfg_logo').value=LS.get('HSM_LOGO_URL','')||''; $('#cfg').showModal(); };
$('#cfg').addEventListener('close',()=>{ const u=$('#cfg_url').value.trim(), k=$('#cfg_key').value.trim(), l=$('#cfg_logo').value.trim(); if(u) LS.set('HSM_WEBAPP_URL',u); else LS.del('HSM_WEBAPP_URL'); if(k) LS.set('HSM_API_KEY',k); else LS.del('HSM_API_KEY'); if(l) LS.set('HSM_LOGO_URL',l); else LS.del('HSM_LOGO_URL'); applyLogo(); toast('Configuración guardada'); });
$('#cfgTest').onclick=async ()=>{ try{ const r=await API.call('ping'); $('#cfgMsg').textContent='OK '+(r.version||''); toast('WebApp OK'); } catch(e){ $('#cfgMsg').textContent='Error: '+(e.message||e); toast('No conecta',2600) } };

/* ===== Útiles ===== */
$('#uVal').onclick=()=>{ const v=$('#u_dni').value.trim(); const ok=validDNI(v); $('#u_res').textContent = ok? 'Formato válido ✔' : 'Formato inválido'; $('#u_res').className = 'st ' + (ok?'ok':'err'); };
document.querySelectorAll('.chip[data-go]').forEach(c=>c.onclick=()=>document.querySelector(`.tab[data-v="${c.dataset.go}"]`).click());

/* ===== CIE10 cache (10 min) ===== */
(async function loadCIE(){
  try{
    const ck='CIE_CACHE', ts='CIE_TS', now=Date.now();
    let list=LS.get(ck,null), t=LS.get(ts,0);
    if(!list || (now-t)>600000){
      const j=await API.call('cie10_list'); list=(j&&j.ok&&j.list)||[];
      LS.set(ck,list); LS.set(ts,now);
    }
    const dl=$('#cie-list'); dl.innerHTML='';
    list.slice(0,2000).forEach(x=>{ const o=document.createElement('option'); o.value=x.code; o.label=x.desc; dl.appendChild(o); });
  }catch(_){ /* silencioso */ }
})();

/* ===== Prefill por query ===== */
(function prefill(){
  const q=new URLSearchParams(location.search);
  if(q.get('dni')) $('#i_dni').value=q.get('dni');
  if(q.get('sexo')) $('#i_sexo').value=q.get('sexo').toUpperCase();
  if(q.get('fi')) $('#i_fi').value=q.get('fi');
})();

/* ===== Boot ===== */
applyLogo(); boxSet(boxGet());
loadDraft(DRAFT_ING,['i_dni','i_sexo','i_fi','i_hi','i_ii','i_met','i_con','i_sus','i_cie','i_obs']);
loadDraft(DRAFT_ALTA,['a_dni','a_fn','a_sexo','a_fa','a_ha','a_estado','a_obs']);
if (!$('#i_fi').value) $('#i_fi').value = nowDate();
if (!$('#i_hi').value) $('#i_hi').value = nowTime();

// Aviso de nueva versión desde el SW
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', (ev) => {
    if (ev?.data?.type === 'SW_ACTIVATED') {
      toast('Nueva versión disponible. Recargando…', 1800);
      setTimeout(() => location.reload(), 1500);
    }
  });
}

// Auto-flush al recuperar conectividad
window.addEventListener('online', () => {
  try { boxFlush(); } catch {}
});

