<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0d1321" />
  <title>HSM v7 · Móvil</title>
  <meta name="description" content="Carga móvil de ingresos HSM con cola offline y sincronización a Google Sheets." />
  <style>
    :root{
      --bg:#0d1321; --panel:#141a2a; --panel2:#1a2236; --txt:#e9f1ff;
      --mut:#bfd1ff; --mut2:#8fa6d9; --ok:#22d4bf; --warn:#ffab0b; --err:#ff5a5a;
      --chip:#2b355e; --chipb:#39457a; --radius:14px; --gap:14px; --shadow:0 6px 18px rgba(0,0,0,.25)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    a{color:inherit}
    .wrap{min-height:100%;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),rgba(13,19,33,.9));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.05)}
    .bar{display:flex;align-items:center;gap:10px;padding:10px 14px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--panel2);box-shadow:var(--shadow)}
    .online{color:#0f0}
    .tabs{display:flex;gap:8px;margin-left:10px}
    .tab{padding:8px 12px;border-radius:999px;background:var(--panel2);cursor:pointer}
    .tab[aria-selected="true"]{background:var(--chipb)}
    .sp{flex:1}
    .iconbtn{all:unset;display:inline-grid;place-items:center;width:40px;height:40px;border-radius:50%;background:var(--chipb);cursor:pointer;box-shadow:var(--shadow)}
    .gear{position:relative}
    main{flex:1;max-width:1200px;margin:12px auto;padding:0 12px;width:100%}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:860px){ .grid.cols-3{grid-template-columns:repeat(3,1fr)} .grid.cols-2{grid-template-columns:repeat(2,1fr)} }
    label{display:block;font-weight:600;margin:2px 0 6px}
    .help{color:var(--mut);font-size:12px;margin-top:4px}
    input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:var(--panel2);color:var(--txt);outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{all:unset;display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;background:#2d4b9f;cursor:pointer;box-shadow:var(--shadow)}
    .btn.secondary{background:var(--chip)}
    .btn.warn{background:#8d5a00}
    .btn.ok{background:#145a52}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:8px 12px;background:var(--chip);border-radius:999px;cursor:pointer}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:var(--panel2);border:1px solid rgba(255,255,255,.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{position:sticky;top:0;background:var(--panel)}
    .status{padding:2px 8px;border-radius:999px}
    .s-pend{background:#3b2f00;color:#ffcc45}
    .s-ok{background:#0d3b2f;color:#5bffda}
    .inline-btn{margin-left:8px}
    dialog{border:0;background:var(--panel);color:var(--txt);border-radius:16px;box-shadow:var(--shadow);max-width:680px;width:min(96vw,680px);padding:0}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .dlg-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .dlg-b{padding:16px}
    .kbd{font:600 12px/1 ui-monospace, SFMono-Regular, Menlo;background:#111b34;padding:2px 6px;border-radius:6px}
    .banner{margin:12px 0;padding:12px;border-radius:12px;background:#3c0e0e;color:#ffdede;border:1px solid #ff5a5a}
    .sr{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="bar">
      <span class="badge"><strong>HSM v7 · Móvil</strong><span id="netState" class="pill">Online</span></span>
      <nav class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab" role="tab" id="t-ing" aria-controls="p-ing" aria-selected="true">Ingreso</button>
        <button class="tab" role="tab" id="t-pend" aria-controls="p-pend" aria-selected="false">Pendientes <span id="pendCount" class="pill">0</span></button>
        <button class="tab" role="tab" id="t-util" aria-controls="p-util" aria-selected="false">Útiles</button>
      </nav>
      <div class="sp"></div>
      <button id="btnConfig" class="iconbtn gear" aria-label="Configuración"><span aria-hidden="true">⚙️</span></button>
    </div>
  </header>

  <main>
    <!-- Panel Ingreso -->
    <section id="p-ing" role="tabpanel" aria-labelledby="t-ing">
      <div class="card">
        <div class="grid cols-3">
          <div>
            <label for="dni">DNI</label>
            <input id="dni" inputmode="numeric" pattern="[0-9]*" placeholder="7–9 dígitos" autocomplete="off" />
            <div class="help">Solo números (sin puntos)</div>
          </div>
          <div>
            <label for="sexo">Sexo</label>
            <select id="sexo">
              <option value="F">F</option>
              <option value="M">M</option>
            </select>
          </div>
          <div>
            <label for="fIngreso">Fecha ingreso</label>
            <div class="row">
              <input id="fIngreso" type="date" />
              <button class="btn secondary inline-btn" id="btnHoy" type="button">Hoy</button>
            </div>
            <div class="help">Formato enviado: <span class="kbd">yyyy-mm-dd</span></div>
          </div>
          <div>
            <label for="hIngreso">Hora ingreso</label>
            <div class="row">
              <input id="hIngreso" type="time" />
              <button class="btn secondary inline-btn" id="btnAhora" type="button">Ahora</button>
            </div>
          </div>
          <div>
            <label for="tipoIngreso">Ideación / Intento</label>
            <select id="tipoIngreso">
              <option value="Ideación">Ideación</option>
              <option value="Intento" selected>Intento</option>
            </select>
          </div>
          <div>
            <label for="metodo">Método / Letalidad</label>
            <select id="metodo">
              <option value="–">—</option>
              <option>Intoxicación</option>
              <option>Corte</option>
              <option>Colgamiento</option>
              <option>Arma de fuego</option>
              <option>Arrojo</option>
              <option>Otro</option>
            </select>
          </div>
          <div>
            <label for="consumo">Consumo</label>
            <select id="consumo">
              <option>Niega</option>
              <option>Sí</option>
            </select>
          </div>
          <div>
            <label for="frecuencia">Frecuencia</label>
            <select id="frecuencia">
              <option>—</option>
              <option>Diaria</option>
              <option>Semanal</option>
              <option>Ocasional</option>
            </select>
          </div>
          <div>
            <label for="dx">Dx CIE-10 (código)</label>
            <input id="dx" placeholder="Ej: F32.1" inputmode="latin" />
          </div>
          <div class="colspan-3" style="grid-column:1/-1">
            <label for="obs">Observaciones</label>
            <textarea id="obs" placeholder="Notas clínicas relevantes…"></textarea>
            <div class="chips">
              <button class="chip" data-add="Obs. SP">Obs. SP</button>
              <button class="chip" data-add="Red apoyo ✓">Red apoyo ✓</button>
              <button class="chip" data-add="Niega consumo">Niega consumo</button>
              <button class="chip" data-add="Acompañante">Acompañante</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:12px;align-items:center">
          <button id="btnGuardar" class="btn">Guardar ingreso</button>
          <span id="pendBadge" class="pill">Pend: 0</span>
          <div id="saveMsg" class="help"></div>
        </div>
      </div>
    </section>

    <!-- Panel Pendientes -->
    <section id="p-pend" role="tabpanel" aria-labelledby="t-pend" hidden>
      <div class="card">
        <div id="corsWarn" class="banner" hidden>
          <strong>La WebApp no acepta tu origen (CORS)</strong>.  
          Verificá que tu Apps Script responda a <span class="kbd">OPTIONS</span> y envíe
          <span class="kbd">Access-Control-Allow-Origin: https://mingo76tsh-dev.github.io</span>.  
          (Abajo te dejo el parche exacto para el servidor).
        </div>
        <div class="row" style="justify-content:flex-end;margin-bottom:10px">
          <button id="btnRetryAll" class="btn ok">Reintentar todos</button>
          <button id="btnVaciar" class="btn warn">Vaciar cola</button>
        </div>
        <div class="help">Se evita duplicar por <span class="kbd">DUPE_KEY = DNI | Fecha | Hora</span></div>
        <div style="overflow:auto;margin-top:10px">
          <table aria-label="Listado de envíos pendientes/offline">
            <thead><tr>
              <th>#</th><th>Tipo</th><th>DNI</th><th>Fecha</th><th>Hora</th><th>Estado</th><th>Acción</th>
            </tr></thead>
            <tbody id="tbodyPend"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Panel Útiles -->
    <section id="p-util" role="tabpanel" aria-labelledby="t-util" hidden>
      <div class="card grid cols-2">
        <div>
          <h3>Atajos</h3>
          <p><span class="kbd">H</span> = Hoy · <span class="kbd">A</span> = Ahora</p>
          <p>Guardá primero en **Pendientes** si estás sin señal; luego **Reintentar**.</p>
        </div>
        <div>
          <h3>Diagnóstico</h3>
          <div id="diagBox" class="help"></div>
        </div>
      </div>
    </section>
  </main>
  <!-- Diálogo Configuración -->
  <dialog id="dlgCfg" aria-labelledby="cfg-title">
    <div class="dlg-h">
      <strong id="cfg-title">Configuración</strong>
      <button id="cfgClose" class="iconbtn" aria-label="Cerrar">✖</button>
    </div>
    <div class="dlg-b grid cols-2">
      <div style="grid-column:1/-1">
        <label for="cfgUrl">WebApp URL (/exec)</label>
        <input id="cfgUrl" placeholder="https://script.google.com/macros/s/.../exec" />
      </div>
      <div>
        <label for="cfgKey">API Key</label>
        <input id="cfgKey" placeholder="HSM2025KEY" />
      </div>
      <div>
        <label for="cfgCors">CORS Origin</label>
        <input id="cfgCors" placeholder="https://mingo76tsh-dev.github.io" />
      </div>
      <div style="grid-column:1/-1" class="row">
        <button id="cfgTest" class="btn secondary">Probar</button>
        <button id="cfgSave" class="btn">Guardar</button>
      </div>
      <div id="cfgMsg" class="help" style="grid-column:1/-1"></div>
    </div>
  </dialog>

</div><!-- wrap -->

<script>
(() => {
  /* =========================
     CONFIG + ESTADO
  ========================= */
  const DEF_CFG = {
    WEBAPP_URL: "https://script.google.com/macros/s/AKfycbw8396BPSyjySmmV5efuei721ET6YJamCNDFW3X3R7EaBHLOCFn_l1-ik2eGQyOalq66g/exec",
    API_KEY: "HSM2025KEY",
    CORS_ORIGIN: "https://mingo76tsh-dev.github.io"
  };
  const LS_KEY_CFG = "hsmv7_cfg";
  const LS_KEY_Q   = "hsmv7_queue";
  const $ = sel => document.querySelector(sel);

  const state = {
    cfg: {...DEF_CFG, ...(JSON.parse(localStorage.getItem(LS_KEY_CFG) || "{}"))},
    queue: JSON.parse(localStorage.getItem(LS_KEY_Q) || "[]"),
  };

  function saveCfg(){ localStorage.setItem(LS_KEY_CFG, JSON.stringify(state.cfg)); }
  function saveQ(){ localStorage.setItem(LS_KEY_Q, JSON.stringify(state.queue)); refreshPend(); }

  /* =========================
     UTILIDADES
  ========================= */
  const pad = n => String(n).padStart(2,"0");
  function nowISODate(){
    const d = new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function nowHHmm(){
    const d = new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function fmtISO(d){ // acepta yyyy-mm-dd o dd/mm/yyyy
    if(!d) return ""; if(d.includes("-")) return d;
    const [dd,mm,yy] = d.split("/"); return `2025-`.startsWith(yy)? `${yy}-${mm}-${dd}` : `${yy}-${pad(mm)}-${pad(dd)}`;
  }
  function toast(msg, ok=false){
    const el = $("#saveMsg"); el.textContent = msg; el.style.color = ok ? "var(--ok)" : "var(--mut)";
    setTimeout(()=>{ el.textContent=""; }, 3000);
  }

  /* =========================
     PESTAÑAS + HEADER
  ========================= */
  const panels = { "t-ing":"p-ing", "t-pend":"p-pend", "t-util":"p-util" };
  for(const id of Object.keys(panels)){
    $("#"+id).addEventListener("click", () => {
      for(const k of Object.keys(panels)){
        $("#"+k).setAttribute("aria-selected", k===id ? "true" : "false");
        $("#"+panels[k]).hidden = k!==id;
      }
    });
  }
  function refreshPend(){
    $("#pendCount").textContent = state.queue.length;
    $("#pendBadge").textContent = `Pend: ${state.queue.length}`;
    const tb = $("#tbodyPend"); tb.innerHTML = "";
    state.queue.forEach((r,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${r.tipo || "ing"}</td>
        <td>${r.dni||""}</td>
        <td>${r.fecha||"—"}</td>
        <td>${r.hora||"—"}</td>
        <td><span class="status s-pend">pend</span></td>
        <td><button class="btn secondary" data-idx="${i}">Enviar</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("button[data-idx]").forEach(b=>{
      b.addEventListener("click", async e=>{
        const idx = +e.currentTarget.dataset.idx;
        await trySendOne(idx);
      });
    });
  }

  /* =========================
     FORM + CHIPS
  ========================= */
  const f = {
    dni:        $("#dni"),
    sexo:       $("#sexo"),
    fIngreso:   $("#fIngreso"),
    hIngreso:   $("#hIngreso"),
    tipo:       $("#tipoIngreso"),
    metodo:     $("#metodo"),
    consumo:    $("#consumo"),
    freq:       $("#frecuencia"),
    dx:         $("#dx"),
    obs:        $("#obs")
  };
  $("#btnHoy").onclick  = ()=> f.fIngreso.value = nowISODate();
  $("#btnAhora").onclick= ()=> f.hIngreso.value = nowHHmm();
  document.addEventListener("keydown", (ev)=>{
    if(ev.key.toLowerCase()==="h") { f.fIngreso.value = nowISODate(); }
    if(ev.key.toLowerCase()==="a") { f.hIngreso.value = nowHHmm(); }
  });
  document.querySelectorAll(".chip[data-add]").forEach(ch=>{
    ch.addEventListener("click",()=>{
      const t = ch.getAttribute("data-add");
      f.obs.value = (f.obs.value? f.obs.value+" · " : "") + t;
    });
  });

  // Inicial
  if(!f.fIngreso.value) f.fIngreso.value = nowISODate();
  if(!f.hIngreso.value) f.hIngreso.value = nowHHmm();

  /* =========================
     QUEUE + DEDUPE
  ========================= */
  const dupeKey = r => [r.dni, r.fecha, r.hora].join("|");
  function pushQueue(rec){
    // anti duplicados
    const key = dupeKey(rec);
    const exists = state.queue.some(x => dupeKey(x)===key);
    if(!exists){ state.queue.push(rec); saveQ(); }
  }

  function readForm(){
    const rec = {
      tipo: "ing",
      dni: (f.dni.value||"").trim(),
      sexo: f.sexo.value,
      fecha: f.fIngreso.value || nowISODate(),
      hora:  f.hIngreso.value || nowHHmm(),
      ideacionIntento: f.tipo.value,
      metodoLetalidad: f.metodo.value,
      consumo: f.consumo.value,
      frecuencia: f.freq.value,
      dxProvisorio: (f.dx.value||"").toUpperCase().replace(/\s+/g,""),
      observaciones: f.obs.value?.trim() || "",
      ts: Date.now()
    };
    if(!/^\d{7,9}$/.test(rec.dni)) throw new Error("DNI inválido (7–9 dígitos, sin puntos)");
    return rec;
  }

  $("#btnGuardar").addEventListener("click", async ()=>{
    try{
      const rec = readForm();
      const ok = await sendToServer(rec, true);
      if(ok){ toast("Enviado ✔", true); }
      else{
        pushQueue(rec);
        toast("Sin conexión o CORS: quedó en pendientes");
      }
    }catch(err){ toast(err.message||String(err)); }
  });

  $("#btnRetryAll").onclick = async ()=>{
    for(let i=0;i<state.queue.length;i++){
      await trySendOne(i); // al enviar, se acorta
    }
  };
  $("#btnVaciar").onclick = ()=>{ state.queue = []; saveQ(); };

  async function trySendOne(idx){
    const rec = state.queue[idx]; if(!rec) return;
    const ok = await sendToServer(rec, false);
    if(ok){
      state.queue.splice(idx,1); saveQ();
    }
  }

  /* =========================
     FETCH + BACKOFF + CORS
  ========================= */
  async function sendToServer(rec, diagnose){
    // Preflight de diagnóstico opcional (una sola vez por sesión)
    if(diagnose){ await corsProbe(); }

    const body = JSON.stringify(rec);
    try{
      const resp = await fetch(state.cfg.WEBAPP_URL, {
        method:"POST",
        mode:"cors",
        headers:{
          "Content-Type":"application/json",
          "x-api-key": state.cfg.API_KEY,
          "x-app-origin": state.cfg.CORS_ORIGIN
        },
        body,
      });
      if(!resp.ok) throw new Error("HTTP "+resp.status);
      const data = await resp.json().catch(()=> ({}));
      if(data?.ok){ return true; }
      // Si la WebApp devuelve texto sin CORS, no llega acá; sería bloqueado antes
      return false;
    }catch(e){
      // Red/ CORS / errores
      return false;
    }
  }

  let probed=false;
  async function corsProbe(){
    if(probed) return; probed=true;
    try{
      const url = state.cfg.WEBAPP_URL;
      const resp = await fetch(url, {
        method:"OPTIONS",
        mode:"cors",
        headers:{ "Origin": state.cfg.CORS_ORIGIN, "Access-Control-Request-Method":"POST" }
      });
      const allow = resp.headers.get("Access-Control-Allow-Origin") || "";
      if(!(allow==="*" || allow.includes(state.cfg.CORS_ORIGIN))){ $("#corsWarn").hidden=false; }
      $("#diagBox").textContent = `Preflight: ${resp.status} · ACAO=${allow||"—"}`;
    }catch(err){
      $("#corsWarn").hidden=false;
      $("#diagBox").textContent = "Preflight: bloqueado (CORS/RED)";
    }
  }

  /* =========================
     CONFIG DIALOG
  ========================= */
  const dlg = $("#dlgCfg");
  $("#btnConfig").onclick = ()=>{ fillCfg(); dlg.showModal(); };
  $("#cfgClose").onclick   = ()=> dlg.close();
  $("#cfgSave").onclick    = ()=>{ state.cfg.WEBAPP_URL=$("#cfgUrl").value.trim();
                                   state.cfg.API_KEY   =$("#cfgKey").value.trim();
                                   state.cfg.CORS_ORIGIN=$("#cfgCors").value.trim();
                                   saveCfg(); $("#cfgMsg").textContent="Guardado"; };
  $("#cfgTest").onclick    = async ()=>{
    $("#cfgMsg").textContent="Probando…";
    await corsProbe();
    $("#cfgMsg").textContent="Listo. Revisá el banner y Diagnóstico.";
  };
  function fillCfg(){ $("#cfgUrl").value=state.cfg.WEBAPP_URL; $("#cfgKey").value=state.cfg.API_KEY; $("#cfgCors").value=state.cfg.CORS_ORIGIN; }

  /* =========================
     NET STATE + INIT
  ========================= */
  function netUpdate(){ $("#netState").textContent = navigator.onLine ? "Online" : "Offline"; }
  window.addEventListener("online", netUpdate); window.addEventListener("offline", netUpdate); netUpdate();
  refreshPend(); fillCfg();

})();
</script>
</body>
</html>

