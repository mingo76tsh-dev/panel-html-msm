<!doctype html>
<html lang="es" dir="ltr">
<head>
  <!-- ===== PWA + SEO ===== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="HS-V7 — Panel Salud Mental • Ingreso/Alta rápida con soporte offline y cola de pendientes." />
  <title>HS-V7 — Panel Salud Mental</title>

  <!-- Manifest + iconos (rutas absolutas para GH Pages /panel-html-msm/) -->
  <link rel="manifest" href="/panel-html-msm/manifest.json">
  <!-- Favicons explícitos (apuntan a la carpeta en MAYÚSCULAS: ICONS) -->
  <link rel="icon" type="image/png" sizes="32x32" href="/panel-html-msm/ICONS/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/panel-html-msm/ICONS/favicon-16.png">
  <link rel="apple-touch-icon" href="/panel-html-msm/ICONS/apple-touch-icon.png" sizes="180x180" />

  <!-- Conexión a Apps Script (para menor latencia) -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://script.googleapis.com" crossorigin>

  <!-- ===== Estilos ===== -->
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --mut:#94a3b8;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --acc:#60a5fa;
      --field:#0b1329; --bd:#1f2a44; --chip:#1f2937; --shadow:0 8px 28px rgba(0,0,0,.35);
      --focus:0 0 0 2px rgba(59,130,246,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    header.app{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--bd)}
    .title{font-weight:800;letter-spacing:.3px}
    .sp{flex:1}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;font-size:12px;background:rgba(148,163,184,.16);color:#cbd5e1;border:1px solid var(--bd)}
    .badge.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:#14532d}
    .badge.off{background:rgba(148,163,184,.12);color:#94a3b8}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--acc);color:#04121f}
    .btn.sec{background:#1f2937;color:#d1d5db}
    .btn.ghost{background:transparent;border:1px solid var(--bd);color:#cbd5e1}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:740px){ .row{grid-template-columns:1fr} }
    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    input,select,textarea{
      width:100%;background:var(--field);color:var(--ink);
      border:1px solid var(--bd);border-radius:12px;padding:11px 12px;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#3b82f6;box-shadow:var(--focus)}
    textarea{min-height:90px;resize:vertical}
    nav.tabs{display:flex;gap:6px;border-bottom:1px solid var(--bd);padding:10px 10px 0}
    .tab{padding:8px 12px;border-radius:9px 9px 0 0;background:#111a2c;border:1px solid var(--bd);border-bottom:0;color:#cbd5e1;cursor:pointer;font-weight:700;text-decoration:none;-webkit-tap-highlight-color:transparent}
    .tab[aria-selected="true"]{background:var(--card);color:#fff}
    section.view{padding:12px;content-visibility:auto;contain-intrinsic-size: 800px 1200px;}
    .kv{display:flex;gap:8px;align-items:center}
    .kv input{flex:1}
    .st{margin-top:10px;font-size:13px}
    .ok{color:#86efac}.err{color:#fca5a5}.mut{color:#94a3b8}
    .logo{height:44px;width:auto;object-fit:contain;border-radius:8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip,.pill{background:var(--chip);border:1px solid var(--bd);color:#d1d5db;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;text-decoration:none}
    .list{border:1px solid var(--bd);border-radius:12px;overflow:hidden}
    .item{display:flex;gap:12px;padding:10px 12px;border-bottom:1px solid var(--bd);align-items:center}
    .item:last-child{border-bottom:0}
    .small{font-size:12px;color:#94a3b8}
    hr{border:0;border-top:1px solid var(--bd);margin:14px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,23,42,.96);color:#e5e7eb;border:1px solid var(--bd);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;display:none}
    dialog#cfg{border:1px solid var(--bd);border-radius:16px;background:#0f172a;color:#e5e7eb;max-width:560px;width:92%}
    dialog::backdrop{background:rgba(2,6,23,.55)}
    :focus-visible{outline:2px solid #60a5fa;outline-offset:2px}
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
    }
    /* Fallback CSS-only por hash */
    .view{display:none}
    :root:has(:target#ing)  #v-ing,
    :root:has(:target#alta) #v-alta,
    :root:has(:target#pend) #v-pend,
    :root:has(:target#util) #v-util {display:block}
    .footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;color:#a8b3c7;font-size:12px;border-top:1px solid var(--bd);background:#0f172a}
  </style>
</head>

<body>
  <noscript>
    <div class="wrap">
      <div class="card" style="padding:12px;margin-top:12px">Se requiere JavaScript para usar esta aplicación.</div>
    </div>
  </noscript>

  <a class="visually-hidden" href="#main" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Saltar al contenido</a>

  <main id="main" class="wrap" role="main">
    <article class="card" aria-label="HS-V7 — Panel Salud Mental">
      <header class="app">
        <img id="logo" class="logo" alt="Logo de la institución" src="" hidden width="44" height="44" decoding="async">
        <h1 class="title" style="margin:0;font-size:16px">HS-V7 — Panel Salud Mental</h1>
        <span id="online" class="badge off" aria-live="polite" title="Estado de red">Offline</span>
        <span class="sp"></span>
        <button id="btnInstall" class="btn sec" style="display:none">Instalar</button>
        <button id="btnCfg" class="btn sec" aria-haspopup="dialog" aria-controls="cfg" title="Configuración">⚙️</button>
      </header>

      <!-- NAV -->
      <nav class="tabs" role="tablist" aria-label="Secciones">
        <a class="tab" id="tab-ing"  role="tab" href="#ing"  data-v="ing"  aria-selected="true">Ingreso</a>
        <a class="tab" id="tab-alta" role="tab" href="#alta" data-v="alta" aria-selected="false">Alta</a>
        <a class="tab" id="tab-pend" role="tab" href="#pend" data-v="pend" aria-selected="false">Pendientes</a>
        <a class="tab" id="tab-util" role="tab" href="#util" data-v="util" aria-selected="false">Útiles</a>
      </nav>

      <!-- ============== INGRESO ============== -->
      <section id="v-ing" class="view" role="tabpanel" aria-labelledby="tab-ing">
        <div class="row">
          <div>
            <label for="i_dni">DNI</label>
            <div class="kv">
              <input id="i_dni" name="DNI" type="tel" inputmode="numeric" autocomplete="off" placeholder="7–9 dígitos" aria-required="true">
              <button class="btn sec" id="dniCam">Cargar</button>
            </div>
          </div>
          <div>
            <label for="i_sexo">Sexo</label>
            <select id="i_sexo" name="Sexo"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="i_fi">Fecha ingreso</label>
            <div class="kv">
              <input id="i_fi" name="FechaIngresoManual" type="date">
              <button class="btn sec" id="iFiNow">Ahora</button>
            </div>
          </div>
          <div>
            <label for="i_hi">Hora ingreso</label>
            <div class="kv">
              <input id="i_hi" name="HoraIngresoManual" type="time">
              <button class="btn sec" id="iHiNow">Ahora</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="i_ii">Ideación / Intento</label>
            <select id="i_ii" name="IdeacionIntento"><option value="">—</option><option>Ideación</option><option>Intento</option></select>
          </div>
          <div>
            <label for="i_met">Método / Letalidad</label>
            <select id="i_met" name="MetodoLetalidad">
              <option value="">—</option>
              <option>Intoxicación</option><option>Corte</option><option>Colgamiento</option>
              <option>Arma de fuego</option><option>Arrojo</option><option>Otro</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="i_con">Consumo</label>
            <select id="i_con" name="Consumo"><option value="">—</option><option>Sí</option><option>No</option></select>
          </div>
          <div>
            <label for="i_sus">Tipo Sustancia</label>
            <select id="i_sus" name="TipoSustancia">
              <option value=""></option><option>Alcohol</option><option>BZD</option><option>Opioides</option>
              <option>Cocaína</option><option>THC</option><option>Mixto</option>
            </select>
          </div>
        </div>

        <label for="i_cie">Dx CIE-10 (código)</label>
        <input id="i_cie" name="DxProvisorio_CIE10" list="cie-list" placeholder="Ej: F32.1" inputmode="text" autocomplete="off">
        <datalist id="cie-list"></datalist>

        <label for="i_obs">Observaciones</label>
        <textarea id="i_obs" name="Observaciones" placeholder="Notas breves (opcional)"></textarea>

        <div class="chips" id="tpls" aria-label="Plantillas rápidas">
          <button class="chip" type="button" data-t="+Observación breve sin particularidades.">Obs. SP</button>
          <button class="chip" type="button" data-t="+Se informa red de apoyo presente.">Red apoyo ✓</button>
          <button class="chip" type="button" data-t="+Niega consumo reciente.">Niega consumo</button>
          <button class="chip" type="button" data-t="+Acompañante en guardia.">Acompañante</button>
        </div>

        <div class="st mut" id="ingMsg" aria-live="polite"></div>
        <div class="kv" style="margin-top:12px;gap:10px;flex-wrap:wrap">
          <button class="btn" id="ingSave">Guardar ingreso</button>
          <button class="btn ghost" id="ingShare">Compartir comprobante</button>
        </div>
        <div class="small">Tip: admite <code>?dni=&amp;sexo=&amp;fi=YYYY-MM-DD</code> para prellenar.</div>
      </section>

      <!-- ============== ALTA ============== -->
      <section id="v-alta" class="view" role="tabpanel" aria-labelledby="tab-alta">
        <div class="row">
          <div>
            <label for="a_dni">DNI</label>
            <input id="a_dni" name="DNI" type="tel" inputmode="numeric" placeholder="7–9 dígitos">
          </div>
          <div>
            <label for="a_fn">Fecha Nac. (opcional)</label>
            <input id="a_fn" name="FechaNac" type="date">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="a_sexo">Sexo</label>
            <select id="a_sexo" name="Sexo"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
          </div>
          <div>
            <label>Buscar ingreso</label>
            <div class="kv">
              <button class="btn sec" id="aSearch">Buscar por DNI</button>
              <span id="aFound" class="small" aria-live="polite"></span>
          ... (rest of your original HTML unchanged) ...
  <!-- ========= LÓGICA / PWA ========= -->
  <script>
  /* ===== Helpers ===== */
  const LS={get:(k,d=null)=>{try{const v=localStorage.getItem(k);return v==null?d:JSON.parse(v)}catch(_){return localStorage.getItem(k)||d}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch(_){localStorage.setItem(k,v)}},del:(k)=>localStorage.removeItem(k)};
  const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const vibrate=p=>('vibrate'in navigator)&&navigator.vibrate(p);
  const toast=(t,ms=2200)=>{const el=$("#toast"); if(!el)return; el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',ms)};

  const S=Object.freeze({normStr:v=>(v==null?'':String(v).trim()),onlyDigits:v=>String(v==null?'':v).replace(/\D/g,''),normDate(v){v=this.normStr(v);if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){const[d,m,y]=v.split('/');return `${y}-${m}-${d}`}return v},normTime(v){v=this.normStr(v);if(!v)return'';const m=v.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);if(!m)return'';const hh=String(Math.max(0,Math.min(23,parseInt(m[1],10)||0))).padStart(2,'0');const mm=String(Math.max(0,Math.min(59,parseInt(m[2],10)||0))).padStart(2,'0');return `${hh}:${mm}`}});

  /* ===== PWA: SW + instalar ===== */
  let _deferredPrompt=null;
  addEventListener('beforeinstallprompt',e=>{e.preventDefault();_deferredPrompt=e;$('#btnInstall').style.display='inline-block';});
  $('#btnInstall')?.addEventListener('click',async()=>{if(!_deferredPrompt)return;_deferredPrompt.prompt();try{await _deferredPrompt.userChoice}catch(_){} _deferredPrompt=null;$('#btnInstall').style.display='none';});
  if('serviceWorker' in navigator){
    addEventListener('load', ()=>{ navigator.serviceWorker.register('/panel-html-msm/sw.js',{scope:'/panel-html-msm/'})
        .then(async reg=>{ try{const sw=await navigator.serviceWorker.ready; sw.active?.postMessage({type:'WARMUP'});}catch(_){}
          if('sync' in reg){try{await reg.sync.register('flush-pend');}catch(_){}}
        }).catch(()=>{}); },{once:true});
    navigator.serviceWorker.addEventListener('message',ev=>{ if(ev.data?.type==='SW_ACTIVATED'){toast('Nueva versión disponible. Recargando…',1800); setTimeout(()=>location.reload(),1500);} if(ev.data?.type==='TRY_FLUSH_PEND' && document.visibilityState==='visible'){ safeFlushPend(); }});
  }

  /* ===== applyLogo (modificada para no bloquear LCP) ===== */
  function applyLogo(){
    const url = LS.get('HSM_LOGO_URL','/panel-html-msm/ICONS/icon-192.png');
    const el = $('#logo');
    if(!el) return;
    if(!url){ el.hidden = true; return; }

    const loadLogo = ()=>{
      const safeUrl = url.includes('icon-512') ? url.replace('icon-512','icon-192') : url;
      el.loading = 'lazy';
      el.decoding = 'async';
      el.src = safeUrl;
      el.hidden = true;
      el.onload = ()=> { el.hidden = false; };
      el.onerror = ()=> { el.hidden = true; };
    };

    if('requestIdleCallback' in window){
      requestIdleCallback(loadLogo, {timeout: 2000});
    } else {
      setTimeout(loadLogo, 1200);
    }
  }

  /* ===== el resto de tu lógica permanece exactamente igual ===== */
  /* ... (tu JS original aquí) ... */

  /* Boot */
  addEventListener('DOMContentLoaded',()=>{ applyLogo(); /* resto unchanged */ });
  </script>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
